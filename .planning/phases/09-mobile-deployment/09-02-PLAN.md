---
phase: 09-mobile-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-compose.yml
  - .dockerignore
  - src/routes/health/+server.ts
autonomous: true

must_haves:
  truths:
    - "Docker container builds successfully with multi-stage build"
    - "Container runs and serves the app on configured port"
    - "Health check endpoint returns 200 OK"
    - "Environment variables configure ORIGIN, DATA_DIR, BODY_SIZE_LIMIT"
    - "Data persists in mounted volumes across container restarts"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build with node:22-slim"
      contains: "FROM node:22-slim"
    - path: "docker-compose.yml"
      provides: "Production deployment configuration with volumes"
      contains: "volumes:"
    - path: ".dockerignore"
      provides: "Exclude dev files from build context"
      contains: "node_modules"
    - path: "src/routes/health/+server.ts"
      provides: "Health check endpoint"
      exports: ["GET"]
  key_links:
    - from: "Dockerfile"
      to: "docker-compose.yml"
      via: "build context"
      pattern: "build: \\."
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "service definition"
      pattern: "services:"
---

<objective>
Create Docker deployment configuration with multi-stage build, health checks, and volume mounts.

Purpose: Enable production deployment of the app in a Docker container with proper isolation, data persistence, and environment configuration.

Output: Dockerfile with multi-stage build, docker-compose.yml with volume mounts and environment variables, health check endpoint.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-mobile-deployment/09-CONTEXT.md
@.planning/phases/09-mobile-deployment/09-RESEARCH.md
@package.json
@svelte.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check endpoint</name>
  <files>src/routes/health/+server.ts</files>
  <action>
Create a simple health check endpoint for Docker health checks:

```typescript
// src/routes/health/+server.ts
import type { RequestHandler } from './$types';

export const GET: RequestHandler = async () => {
  return new Response('ok', { status: 200 });
};
```

This endpoint:
- Returns 200 OK with 'ok' body
- Used by Docker HEALTHCHECK to verify container is running
- Simple and lightweight (no database check needed for basic health)
  </action>
  <verify>
- File exists at src/routes/health/+server.ts
- `npm run dev` and `curl http://localhost:5173/health` returns "ok"
  </verify>
  <done>
/health endpoint returns 200 OK for Docker health checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile with multi-stage build</name>
  <files>Dockerfile</files>
  <action>
Create `Dockerfile` with multi-stage build optimized for better-sqlite3:

```dockerfile
# Build stage
FROM node:22-slim AS builder
WORKDIR /app

# Install build dependencies for better-sqlite3
RUN apt-get update && apt-get install -y python3 make g++ && rm -rf /var/lib/apt/lists/*

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build
RUN npm prune --production

# Runtime stage
FROM node:22-slim
WORKDIR /app

# Create non-root user
RUN groupadd --gid 1001 nodejs && useradd --uid 1001 --gid 1001 -m nodejs

# Copy built app and production dependencies
COPY --from=builder --chown=nodejs:nodejs /app/build build/
COPY --from=builder --chown=nodejs:nodejs /app/node_modules node_modules/
COPY --from=builder --chown=nodejs:nodejs /app/package.json .

# Create data directories
RUN mkdir -p /data/db /data/attachments && chown -R nodejs:nodejs /data

USER nodejs

# Default environment variables
ENV NODE_ENV=production
ENV PORT=3000
ENV HOST=0.0.0.0
ENV DATA_DIR=/data
ENV BODY_SIZE_LIMIT=10M

EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"

CMD ["node", "build"]
```

Key design decisions:
- Use node:22-slim (Debian-based) NOT Alpine - better-sqlite3 native bindings compatibility
- Install python3, make, g++ for native module compilation
- Multi-stage to minimize final image size
- Non-root user (nodejs) for security
- Create /data directories owned by nodejs user
- Use Node's fetch for health check (no wget needed)
  </action>
  <verify>
- Dockerfile exists with FROM node:22-slim
- Contains USER nodejs (non-root)
- Contains HEALTHCHECK directive
- Contains ENV defaults for all required variables
  </verify>
  <done>
Multi-stage Dockerfile with security best practices and better-sqlite3 support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create docker-compose.yml and .dockerignore</name>
  <files>
    docker-compose.yml
    .dockerignore
  </files>
  <action>
1. Create `docker-compose.yml`:

```yaml
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      # REQUIRED: Set to your actual domain
      - ORIGIN=http://localhost:3000
      # Data directory (matches Dockerfile default)
      - DATA_DIR=/data
      # Request body size limit (10M = 10 megabytes)
      - BODY_SIZE_LIMIT=10M
      # Server port (matches EXPOSE in Dockerfile)
      - PORT=3000
      # Timezone for date handling
      - TZ=America/New_York
      # Optional: Log level for debugging
      # - LOG_LEVEL=info
    volumes:
      # Separate volumes for databases and attachments
      - ledger-db:/data/db
      - ledger-attachments:/data/attachments
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

volumes:
  ledger-db:
  ledger-attachments:
```

2. Create `.dockerignore`:

```
# Dependencies
node_modules

# Build output
build
.svelte-kit

# Development files
.git
.gitignore
*.md
!README.md

# IDE
.vscode
.idea
*.swp
*.swo

# Environment files (should not be in build context)
.env
.env.*

# Planning files
.planning

# Test files
*.test.ts
*.spec.ts
scripts/

# OS files
.DS_Store
Thumbs.db
```

Key design decisions per CONTEXT.md:
- Separate volume mounts for db and attachments (user preference)
- Extensive environment variables with sensible defaults
- ORIGIN is commented as REQUIRED - user must set for their domain
- TZ for timezone handling
- restart: unless-stopped for production reliability
  </action>
  <verify>
- docker-compose.yml has two named volumes (ledger-db, ledger-attachments)
- docker-compose.yml has ORIGIN, DATA_DIR, BODY_SIZE_LIMIT, PORT, TZ environment variables
- .dockerignore excludes node_modules, .planning, .env files
  </verify>
  <done>
docker-compose.yml configured with separate volumes, environment variables, and health checks.
.dockerignore excludes development files from build context.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build` (ensure SvelteKit build works before Docker)
2. Docker build succeeds: `docker build -t tinyledger .`
3. Container runs: `docker run -p 3000:3000 -e ORIGIN=http://localhost:3000 tinyledger`
4. Health check works: `curl http://localhost:3000/health` returns "ok"
5. Compose works: `docker compose up -d` starts container
</verification>

<success_criteria>
- Dockerfile uses node:22-slim with multi-stage build
- Dockerfile runs as non-root nodejs user
- Dockerfile has HEALTHCHECK directive
- docker-compose.yml has separate volumes for db and attachments
- docker-compose.yml configures ORIGIN, DATA_DIR, BODY_SIZE_LIMIT, PORT, TZ
- .dockerignore excludes node_modules, .planning, .env, and dev files
- /health endpoint returns 200 OK
- `docker build` completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/09-mobile-deployment/09-02-SUMMARY.md`
</output>
