---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - svelte.config.js
  - vite.config.ts
  - tailwind.config.ts
  - src/app.html
  - src/app.css
  - src/app.d.ts
  - src/hooks.server.ts
  - src/lib/server/db/index.ts
  - src/lib/server/db/schema.ts
  - src/lib/server/db/migrate.ts
  - src/lib/server/workspace/index.ts
  - src/lib/server/workspace/registry.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "SvelteKit project builds and runs with `npm run dev`"
    - "SQLite database files are created in DATA_DIR when workspace is accessed"
    - "WAL mode is enabled on all database connections"
    - "Workspace ID from URL path is available in event.locals"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "better-sqlite3"
    - path: "src/hooks.server.ts"
      provides: "Workspace context injection"
      contains: "event.locals.workspaceId"
    - path: "src/lib/server/db/schema.ts"
      provides: "Drizzle schema definitions"
      contains: "workspaceSettings"
    - path: "src/lib/server/workspace/index.ts"
      provides: "Database connection factory"
      contains: "getWorkspaceDb"
  key_links:
    - from: "src/hooks.server.ts"
      to: "src/lib/server/workspace/index.ts"
      via: "getWorkspaceDb import"
      pattern: "getWorkspaceDb"
    - from: "src/lib/server/workspace/index.ts"
      to: "src/lib/server/db/schema.ts"
      via: "schema import for drizzle"
      pattern: "import.*schema"
---

<objective>
Initialize SvelteKit project with workspace-isolated SQLite database architecture.

Purpose: Establish the foundation that all other features build upon - the multi-tenant database layer with proper SQLite configuration (WAL mode, busy_timeout) and request-scoped workspace context.

Output: Working SvelteKit project with hooks.server.ts injecting workspace-scoped database connections into event.locals for any /w/[workspace]/ route.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize SvelteKit project with dependencies</name>
  <files>
    package.json
    svelte.config.js
    vite.config.ts
    tailwind.config.ts
    src/app.html
    src/app.css
    .env.example
  </files>
  <action>
    Create new SvelteKit project in current directory (empty except .planning/):

    1. Run `npm create svelte@latest . -- --template skeleton --types typescript --no-prettier --no-eslint --no-playwright --no-vitest` (use --force if needed since .planning exists)

    2. Install dependencies:
       ```bash
       npm install better-sqlite3 drizzle-orm sharp
       npm install -D drizzle-kit @types/better-sqlite3 tailwindcss @tailwindcss/vite @sveltejs/adapter-node
       ```

    3. Configure svelte.config.js:
       - Use adapter-node (not adapter-auto)
       - Set alias: { '$lib': 'src/lib' }

    4. Configure vite.config.ts:
       - Add Tailwind v4 Vite plugin
       - Add server.fs.allow for DATA_DIR access

    5. Create tailwind.config.ts with mobile-first defaults

    6. Update src/app.html:
       - Add viewport meta for mobile
       - Add apple-mobile-web-app-capable meta tags

    7. Create src/app.css with Tailwind imports:
       ```css
       @import "tailwindcss";
       ```

    8. Create .env.example with:
       ```
       DATA_DIR=./data
       ORIGIN=http://localhost:5173
       ```

    Do NOT use PostCSS - Tailwind v4 uses Vite plugin directly.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - `npm run build` completes successfully
    - Visit http://localhost:5173 shows SvelteKit default page
    - package.json includes better-sqlite3, drizzle-orm, sharp
  </verify>
  <done>
    SvelteKit project runs with all dependencies installed, Tailwind v4 configured via Vite plugin
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database layer with Drizzle schema</name>
  <files>
    src/lib/server/db/schema.ts
    src/lib/server/db/index.ts
    src/lib/server/db/migrate.ts
  </files>
  <action>
    Create the database layer following patterns from RESEARCH.md:

    1. src/lib/server/db/schema.ts - Define workspace_settings table:
       ```typescript
       import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
       import { sql } from 'drizzle-orm';

       export const workspaceSettings = sqliteTable('workspace_settings', {
           id: integer('id').primaryKey({ autoIncrement: true }),
           name: text('name').notNull(),
           type: text('type', { enum: ['sole_prop', 'volunteer_org'] }).notNull(),
           businessName: text('business_name'),
           address: text('address'),
           phone: text('phone'),
           responsibleParty: text('responsible_party'),
           foundedYear: integer('founded_year'),
           logoFilename: text('logo_filename'),
           createdAt: text('created_at').default(sql`CURRENT_TIMESTAMP`).notNull(),
           updatedAt: text('updated_at').default(sql`CURRENT_TIMESTAMP`).notNull(),
       });

       export type WorkspaceSettings = typeof workspaceSettings.$inferSelect;
       export type NewWorkspaceSettings = typeof workspaceSettings.$inferInsert;
       ```

    2. src/lib/server/db/migrate.ts - Schema initialization:
       - Create tables if not exists using raw SQL
       - Insert default settings row if table is empty (singleton pattern)
       - Export initializeSchema(db) function

    3. src/lib/server/db/index.ts - Re-export schema and types for convenience

    CRITICAL: Use snake_case for column names in database (business_name, not businessName).
    Drizzle maps these to camelCase in TypeScript automatically.
  </action>
  <verify>
    - TypeScript compiles without errors: `npx tsc --noEmit`
    - Schema exports WorkspaceSettings type
    - initializeSchema function is exported
  </verify>
  <done>
    Drizzle schema defines workspace_settings table with all required fields, migration function ready
  </done>
</task>

<task type="auto">
  <name>Task 3: Create workspace context system with hooks</name>
  <files>
    src/lib/server/workspace/index.ts
    src/lib/server/workspace/registry.ts
    src/hooks.server.ts
    src/app.d.ts
  </files>
  <action>
    Create workspace resolution and context injection:

    1. src/lib/server/workspace/registry.ts - Workspace registry management:
       - Store list of workspaces in DATA_DIR/workspaces.json
       - Functions: listWorkspaces(), addWorkspace(id, name), removeWorkspace(id)
       - Each entry: { id: string, name: string, createdAt: string }

    2. src/lib/server/workspace/index.ts - Database connection factory:
       ```typescript
       // Connection cache to avoid repeated file opens
       const connectionCache = new Map<string, BetterSQLite3Database<typeof schema>>();

       export function getWorkspaceDb(workspaceId: string): BetterSQLite3Database<typeof schema> {
           // Return cached if exists
           // Create DATA_DIR/workspaces/{workspaceId}.db if not exists
           // Enable WAL mode: sqlite.pragma('journal_mode = WAL')
           // Set busy_timeout: sqlite.pragma('busy_timeout = 5000')
           // Wrap with drizzle(sqlite, { schema })
           // Initialize schema
           // Cache and return
       }

       export function workspaceExists(workspaceId: string): boolean {
           // Check if .db file exists in DATA_DIR/workspaces/
       }

       export function createWorkspace(workspaceId: string, name: string, type: 'sole_prop' | 'volunteer_org'): void {
           // Create database via getWorkspaceDb
           // Insert initial settings with provided name and type
           // Add to registry
       }
       ```

    3. src/hooks.server.ts - Request hook for workspace injection:
       ```typescript
       export const handle: Handle = async ({ event, resolve }) => {
           const workspaceMatch = event.url.pathname.match(/^\/w\/([^\/]+)/);

           if (workspaceMatch) {
               const workspaceId = workspaceMatch[1];

               if (!workspaceExists(workspaceId)) {
                   throw error(404, 'Workspace not found');
               }

               event.locals.workspaceId = workspaceId;
               event.locals.db = getWorkspaceDb(workspaceId);
           }

           return resolve(event);
       };
       ```

    4. src/app.d.ts - Type declarations:
       ```typescript
       import type { BetterSQLite3Database } from 'drizzle-orm/better-sqlite3';
       import type * as schema from '$lib/server/db/schema';

       declare global {
           namespace App {
               interface Locals {
                   workspaceId?: string;
                   db?: BetterSQLite3Database<typeof schema>;
               }
           }
       }

       export {};
       ```

    Use DATA_DIR from environment variable with fallback to './data'.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - `npm run build` completes
    - TypeScript compiles: `npx tsc --noEmit`
    - Manually test: Create a test workspace programmatically, verify .db file created with WAL mode
  </verify>
  <done>
    hooks.server.ts injects workspace-scoped db into event.locals, WAL mode enabled, workspace registry functional
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Project structure verification:
   ```bash
   ls -la src/lib/server/db/
   ls -la src/lib/server/workspace/
   cat src/hooks.server.ts
   ```

2. Build verification:
   ```bash
   npm run build
   ```

3. Database configuration verification:
   - Create a test script that:
     - Imports createWorkspace
     - Creates a test workspace
     - Verifies .db file exists in data/workspaces/
     - Verifies WAL mode by checking for .db-wal file after write
     - Cleans up test workspace

4. Type safety verification:
   ```bash
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
- SvelteKit project builds and runs without errors
- better-sqlite3, drizzle-orm, sharp installed and importable
- Tailwind v4 configured via Vite plugin (no PostCSS)
- hooks.server.ts parses workspace ID from /w/[workspace]/ URLs
- getWorkspaceDb returns workspace-scoped Drizzle database
- SQLite databases created with WAL mode enabled
- Workspace registry tracks all workspaces in workspaces.json
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md` following the summary template.
</output>
