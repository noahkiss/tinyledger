---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/routes/+page.svelte
  - src/routes/+page.server.ts
  - src/routes/+layout.svelte
  - src/routes/w/[workspace]/+layout.svelte
  - src/routes/w/[workspace]/+layout.server.ts
  - src/routes/w/[workspace]/+page.svelte
  - src/routes/w/[workspace]/settings/+page.svelte
  - src/routes/w/[workspace]/settings/+page.server.ts
  - src/routes/api/logo/[workspace]/[filename]/+server.ts
  - src/lib/server/storage/logo.ts
  - src/lib/components/WorkspaceSelector.svelte
  - src/lib/components/WorkspaceLogo.svelte
  - src/lib/stores/lastWorkspace.ts
autonomous: false

must_haves:
  truths:
    - "User can create a new workspace from landing page"
    - "User can access workspace via /w/[workspace]/ URL"
    - "User can edit workspace name, type, and business details"
    - "User can upload logo with enforced 128x128 dimensions"
    - "User can switch between workspaces via header dropdown"
    - "Last-used workspace is remembered across browser sessions"
  artifacts:
    - path: "src/routes/+page.svelte"
      provides: "Landing page with workspace creation"
      contains: "form"
    - path: "src/routes/w/[workspace]/settings/+page.svelte"
      provides: "Workspace settings form"
      contains: "enctype"
    - path: "src/lib/components/WorkspaceSelector.svelte"
      provides: "Header dropdown for switching workspaces"
      contains: "select"
    - path: "src/lib/stores/lastWorkspace.ts"
      provides: "localStorage-backed store"
      contains: "localStorage"
    - path: "src/lib/server/storage/logo.ts"
      provides: "Logo upload with Sharp processing"
      contains: "sharp"
  key_links:
    - from: "src/routes/w/[workspace]/settings/+page.server.ts"
      to: "src/lib/server/storage/logo.ts"
      via: "processLogoUpload import"
      pattern: "processLogoUpload"
    - from: "src/lib/components/WorkspaceSelector.svelte"
      to: "src/lib/stores/lastWorkspace.ts"
      via: "lastWorkspace store"
      pattern: "lastWorkspace"
    - from: "src/routes/w/[workspace]/+layout.server.ts"
      to: "event.locals.db"
      via: "database from hooks"
      pattern: "locals\\.db"
---

<objective>
Implement complete workspace CRUD functionality with settings UI and workspace switcher.

Purpose: Deliver the user-facing workspace management features - creating workspaces, editing their settings, uploading logos, and switching between them. This completes all WKSP-* requirements for Phase 1.

Output: Fully functional workspace system where users can create, configure, and switch between isolated workspaces.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create landing page with workspace creation</name>
  <files>
    src/routes/+page.svelte
    src/routes/+page.server.ts
    src/routes/+layout.svelte
  </files>
  <action>
    Create the landing page that lists existing workspaces and allows creating new ones:

    1. src/routes/+layout.svelte - Root layout:
       - Basic HTML structure
       - Include app.css for Tailwind
       - Slot for page content

    2. src/routes/+page.server.ts - Landing page data and actions:
       ```typescript
       import { listWorkspaces } from '$lib/server/workspace/registry';
       import { createWorkspace } from '$lib/server/workspace';
       import { redirect, fail } from '@sveltejs/kit';
       import { randomUUID } from 'crypto';

       export const load = async () => {
           return { workspaces: listWorkspaces() };
       };

       export const actions = {
           create: async ({ request }) => {
               const data = await request.formData();
               const name = data.get('name')?.toString().trim();
               const type = data.get('type')?.toString();

               if (!name || name.length < 2) {
                   return fail(400, { error: 'Name must be at least 2 characters' });
               }

               if (type !== 'sole_prop' && type !== 'volunteer_org') {
                   return fail(400, { error: 'Invalid workspace type' });
               }

               // Generate URL-safe ID from name
               const id = name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').slice(0, 30) + '-' + randomUUID().slice(0, 8);

               createWorkspace(id, name, type);

               throw redirect(303, `/w/${id}/settings`);
           }
       };
       ```

       WIRING: The create action must:
       - Import createWorkspace from '$lib/server/workspace' (NOT workspace/index)
       - Call createWorkspace(id, name, type) which handles both database creation AND registry update
       - The redirect sends user to settings page where they can complete setup

    3. src/routes/+page.svelte - Landing page UI:
       - Show list of existing workspaces as cards
       - Each card shows logo/abbreviation, name, type
       - Click card to go to /w/[workspace]/
       - "Create New Workspace" form with name and type inputs
       - Mobile-first Tailwind styling
       - If only one workspace exists and no form submission, consider auto-redirect to it
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` completes successfully
    - `grep -q "createWorkspace" src/routes/+page.server.ts` confirms import wiring
    - `grep -q "listWorkspaces" src/routes/+page.server.ts` confirms registry wiring
    - `npm run dev` and visit http://localhost:5173 shows landing page
    - Fill form and submit to create workspace - redirected to /w/[id]/settings
  </verify>
  <done>
    Landing page displays workspaces, form creates new workspace with generated ID, redirects to settings
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workspace layout and settings page</name>
  <files>
    src/routes/w/[workspace]/+layout.svelte
    src/routes/w/[workspace]/+layout.server.ts
    src/routes/w/[workspace]/+page.svelte
    src/routes/w/[workspace]/settings/+page.svelte
    src/routes/w/[workspace]/settings/+page.server.ts
    src/routes/api/logo/[workspace]/[filename]/+server.ts
    src/lib/server/storage/logo.ts
    src/lib/components/WorkspaceLogo.svelte
  </files>
  <action>
    Create workspace-scoped layout with header and settings page:

    1. src/lib/server/storage/logo.ts - Logo processing with Sharp:
       ```typescript
       import sharp from 'sharp';
       import { writeFile, mkdir, unlink } from 'node:fs/promises';
       import { join } from 'node:path';
       import { randomUUID } from 'node:crypto';
       import { existsSync } from 'node:fs';

       const DATA_DIR = process.env.DATA_DIR ?? './data';
       const LOGO_SIZE = 128;

       export async function processLogoUpload(workspaceId: string, file: File): Promise<string> {
           const dir = join(DATA_DIR, 'logos', workspaceId);
           await mkdir(dir, { recursive: true });

           const filename = `${randomUUID()}.png`;
           const filepath = join(dir, filename);

           const buffer = Buffer.from(await file.arrayBuffer());

           await sharp(buffer)
               .resize(LOGO_SIZE, LOGO_SIZE, { fit: 'cover', position: 'center' })
               .png()
               .toFile(filepath);

           return filename;
       }

       export function getLogoPath(workspaceId: string, filename: string): string | null {
           const filepath = join(DATA_DIR, 'logos', workspaceId, filename);
           return existsSync(filepath) ? filepath : null;
       }
       ```

    2. src/routes/api/logo/[workspace]/[filename]/+server.ts - Logo serving:
       ```typescript
       import { error } from '@sveltejs/kit';
       import { getLogoPath } from '$lib/server/storage/logo';
       import { readFile } from 'node:fs/promises';

       export async function GET({ params }) {
           const filepath = getLogoPath(params.workspace, params.filename);
           if (!filepath) throw error(404);

           const file = await readFile(filepath);
           return new Response(file, {
               headers: { 'Content-Type': 'image/png', 'Cache-Control': 'public, max-age=31536000' }
           });
       }
       ```

    3. src/routes/w/[workspace]/+layout.server.ts - Load workspace data:
       ```typescript
       import { listWorkspaces } from '$lib/server/workspace/registry';
       import { workspaceSettings } from '$lib/server/db/schema';

       export const load = async ({ locals }) => {
           const settings = locals.db!.select().from(workspaceSettings).limit(1).get();
           const workspaces = listWorkspaces();

           return {
               workspaceId: locals.workspaceId,
               settings,
               workspaces
           };
       };
       ```

    4. src/routes/w/[workspace]/+layout.svelte - Workspace layout with header:
       - Header with WorkspaceSelector dropdown
       - Navigation placeholder (will be timeline in Phase 5)
       - Slot for page content

    5. src/lib/components/WorkspaceLogo.svelte - Reusable logo component:
       - Props: settings (WorkspaceSettings), size (default 40)
       - Show image if logoFilename exists, else 2-letter abbreviation
       - Abbreviation from first 2 chars of name, uppercase, colored background

    6. src/routes/w/[workspace]/+page.svelte - Workspace home:
       - Simple placeholder: "Welcome to {workspace.name}"
       - Link to settings
       - (Timeline will replace this in Phase 5)

    7. src/routes/w/[workspace]/settings/+page.server.ts - Settings CRUD:
       ```typescript
       import { fail } from '@sveltejs/kit';
       import { workspaceSettings } from '$lib/server/db/schema';
       import { eq } from 'drizzle-orm';
       import { processLogoUpload } from '$lib/server/storage/logo';

       export const load = async ({ locals }) => {
           const settings = locals.db!.select().from(workspaceSettings).limit(1).get();
           return { settings };
       };

       export const actions = {
           update: async ({ request, locals }) => {
               const data = await request.formData();
               // Validate name (required, 2+ chars)
               // Validate type (sole_prop or volunteer_org)
               // Handle logo upload if provided (call processLogoUpload)
               // Update all fields: name, type, businessName, address, phone, responsibleParty, foundedYear, logoFilename
               // Set updatedAt to current timestamp
           }
       };
       ```

    8. src/routes/w/[workspace]/settings/+page.svelte - Settings form:
       - CRITICAL: Add enctype="multipart/form-data" for file upload
       - use:enhance for progressive enhancement
       - Fields: name (required), type (select), logo (file input)
       - Business details: businessName, address, phone, responsibleParty
       - Founded year: number input
       - Show current logo preview
       - Success/error feedback
       - Mobile-first responsive layout

    Use Tailwind for all styling. Large touch targets for mobile.
  </action>
  <verify>
    Programmatic checks:
    - `npx tsc --noEmit` - TypeScript compiles without errors
    - `npm run build` - Production build completes successfully
    - `grep -q "sharp" src/lib/server/storage/logo.ts` - Sharp import exists
    - `grep -q "processLogoUpload" src/routes/w/\\[workspace\\]/settings/+page.server.ts` - Logo processing wired
    - `grep -q "enctype" src/routes/w/\\[workspace\\]/settings/+page.svelte` - Multipart form configured
    - `grep -q "locals.db" src/routes/w/\\[workspace\\]/+layout.server.ts` - Database access wired
    - `test -f src/lib/components/WorkspaceLogo.svelte` - Component file exists

    Manual verification:
    - Navigate to /w/[workspace]/settings
    - See form with current values populated
    - Change name, save, see updated name
    - Upload logo image, save, see processed 128x128 logo displayed
  </verify>
  <done>
    Workspace layout renders with header, settings page allows editing all workspace fields including logo upload
  </done>
</task>

<task type="auto">
  <name>Task 3: Create workspace switcher with localStorage persistence</name>
  <files>
    src/lib/stores/lastWorkspace.ts
    src/lib/components/WorkspaceSelector.svelte
  </files>
  <action>
    Create workspace switching functionality with last-used persistence:

    1. src/lib/stores/lastWorkspace.ts - localStorage-backed store:
       ```typescript
       import { writable } from 'svelte/store';
       import { browser } from '$app/environment';

       const STORAGE_KEY = 'tinyledger_last_workspace';

       function createLastWorkspaceStore() {
           const initialValue = browser ? localStorage.getItem(STORAGE_KEY) ?? '' : '';
           const store = writable<string>(initialValue);

           if (browser) {
               store.subscribe((value) => {
                   if (value) {
                       localStorage.setItem(STORAGE_KEY, value);
                   } else {
                       localStorage.removeItem(STORAGE_KEY);
                   }
               });
           }

           return store;
       }

       export const lastWorkspace = createLastWorkspaceStore();
       ```

    2. src/lib/components/WorkspaceSelector.svelte - Dropdown component:
       ```svelte
       <script lang="ts">
           import { goto } from '$app/navigation';
           import { lastWorkspace } from '$lib/stores/lastWorkspace';
           import WorkspaceLogo from './WorkspaceLogo.svelte';
           import type { WorkspaceSettings } from '$lib/server/db/schema';

           interface WorkspaceInfo {
               id: string;
               name: string;
               // ... other fields from registry or settings
           }

           let { workspaces, currentWorkspace, currentSettings }: {
               workspaces: WorkspaceInfo[];
               currentWorkspace: string;
               currentSettings: WorkspaceSettings;
           } = $props();

           function switchWorkspace(workspaceId: string) {
               lastWorkspace.set(workspaceId);
               goto(`/w/${workspaceId}`);
           }
       </script>

       <div class="flex items-center gap-3">
           <WorkspaceLogo settings={currentSettings} size={40} />

           <select
               class="font-medium text-lg border-none bg-transparent cursor-pointer"
               value={currentWorkspace}
               onchange={(e) => switchWorkspace(e.currentTarget.value)}
           >
               {#each workspaces as ws}
                   <option value={ws.id}>{ws.name}</option>
               {/each}
           </select>
       </div>
       ```

    3. Update src/routes/w/[workspace]/+layout.svelte:
       - Import and use WorkspaceSelector in header
       - Pass workspaces list and current workspace data
       - Update lastWorkspace store when entering workspace

    4. Update src/routes/+page.svelte (landing page):
       - On mount, check lastWorkspace store
       - If lastWorkspace exists and is valid, offer to "Continue to [workspace name]" button
       - Or auto-redirect if user prefers (make it optional)
  </action>
  <verify>
    Programmatic checks:
    - `npx tsc --noEmit` - TypeScript compiles without errors
    - `npm run build` - Production build completes successfully
    - `grep -q "localStorage" src/lib/stores/lastWorkspace.ts` - localStorage usage confirmed
    - `grep -q "lastWorkspace" src/lib/components/WorkspaceSelector.svelte` - Store import wired
    - `grep -q "select" src/lib/components/WorkspaceSelector.svelte` - Dropdown element exists
    - `grep -q "goto" src/lib/components/WorkspaceSelector.svelte` - Navigation wired
    - `test -f src/lib/stores/lastWorkspace.ts` - Store file exists

    Manual verification:
    - Create two workspaces
    - Switch between them using dropdown
    - Close browser, reopen, visit landing page
    - See "Continue to [last workspace]" option
  </verify>
  <done>
    WorkspaceSelector allows switching between workspaces, lastWorkspace store persists choice in localStorage across sessions
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete workspace system with:
    - Landing page with workspace creation
    - Workspace settings page with logo upload
    - Header dropdown for switching workspaces
    - Last-used workspace persistence
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Visit http://localhost:5173
    3. Create a new workspace:
       - Enter name "Test Business"
       - Select type "Sole Proprietor"
       - Click Create
    4. On settings page:
       - See name pre-filled
       - Upload a logo image
       - Fill in business name, address
       - Set founded year to 2020
       - Click Save
    5. Verify logo appears at 128x128 in header
    6. Create second workspace from landing page
    7. Use header dropdown to switch between workspaces
    8. Close browser, reopen, visit landing page
    9. Verify "Continue to [last workspace]" appears
    10. Click it, confirm correct workspace loads

    Expected: All operations work smoothly, data persists, logo displays correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Requirement coverage check:
   - WKSP-01: Create workspace with name and type - Landing page form
   - WKSP-02: Edit workspace details - Settings page form
   - WKSP-03: Upload logo with dimensions - Sharp processing + settings form
   - WKSP-04: Business details - Settings form fields
   - WKSP-05: Founded year - Settings form field
   - WKSP-06: Switch workspaces via dropdown - WorkspaceSelector
   - WKSP-07: Last-used remembered - lastWorkspace store

2. Data integrity check:
   - Create workspace, verify .db file in data/workspaces/
   - Verify WAL mode: look for .db-wal file
   - Verify logo in data/logos/[workspace]/

3. Build verification:
   ```bash
   npm run build
   npm run preview
   ```
   Test all features in production build
</verification>

<success_criteria>
- User can create new workspace from landing page with name and type
- User can edit all workspace fields in settings page
- Logo upload processes to 128x128 PNG via Sharp
- Logo displays in header (or 2-letter abbreviation if no logo)
- Workspace dropdown allows switching between workspaces
- Last-used workspace persists in localStorage
- All forms use progressive enhancement (use:enhance)
- Mobile-first responsive design with large touch targets
- Production build works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` following the summary template.
</output>
