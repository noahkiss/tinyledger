---
phase: 05-timeline-navigation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/lib/components/QuickEntryFAB.svelte
  - src/lib/components/QuickEntryForm.svelte
  - src/routes/w/[workspace]/transactions/+page.svelte
  - src/routes/w/[workspace]/transactions/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Floating + button visible at bottom of screen"
    - "Tapping FAB opens entry form as slide-up sheet"
    - "Form defaults to Income type with toggle to Expense"
    - "After save, form clears but stays open for rapid entry"
    - "Clicking outside form closes it"
  artifacts:
    - path: "src/lib/components/QuickEntryFAB.svelte"
      provides: "Floating action button for quick entry"
    - path: "src/lib/components/QuickEntryForm.svelte"
      provides: "Slide-up transaction entry form"
  key_links:
    - from: "QuickEntryFAB.svelte"
      to: "QuickEntryForm.svelte"
      via: "state toggle for sheet visibility"
      pattern: "showForm.*true"
    - from: "QuickEntryForm.svelte"
      to: "+page.server.ts action"
      via: "form action for transaction creation"
      pattern: "action.*create"
---

<objective>
Add floating action button for quick transaction entry from the timeline view.

Purpose: Enable rapid transaction entry without navigating away from the timeline. Users can tap the + button, enter transaction details in a slide-up sheet, and immediately add another without the sheet closing. This supports the "10-second transaction entry" core value.

Output: Floating action button component and slide-up entry form that allows rapid sequential transaction entry.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-timeline-navigation/05-CONTEXT.md
@.planning/phases/05-timeline-navigation/05-02-SUMMARY.md
@src/routes/w/[workspace]/transactions/+page.svelte
@src/routes/w/[workspace]/transactions/+page.server.ts
@src/routes/w/[workspace]/transactions/new/+page.svelte
@src/routes/w/[workspace]/transactions/new/+page.server.ts
@src/lib/components/CurrencyInput.svelte
@src/lib/components/DateInput.svelte
@src/lib/components/PayeeAutocomplete.svelte
@src/lib/components/TagSelector.svelte
@src/lib/components/PaymentMethodSelect.svelte
@src/lib/components/AttachmentUpload.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuickEntryFAB and QuickEntryForm components</name>
  <files>
    src/lib/components/QuickEntryFAB.svelte
    src/lib/components/QuickEntryForm.svelte
  </files>
  <action>
**1. Create QuickEntryFAB.svelte**
Props: none (manages its own state)
Exports: none (self-contained)

Features:
- Fixed position button at bottom-right: `fixed bottom-6 right-6 z-30`
- Circular button with + icon: `h-14 w-14 rounded-full bg-blue-600 text-white shadow-lg`
- Hover effect: `hover:bg-blue-700`
- Active effect: `active:scale-95`
- On click: toggle showForm state

When showForm is true:
- Render backdrop overlay: `fixed inset-0 z-40 bg-black/50`
- Clicking backdrop closes form
- Render QuickEntryForm component

**2. Create QuickEntryForm.svelte**
Props:
- `workspaceId: string`
- `availableTags: Tag[]`
- `payees: string[]` (for autocomplete)
- `onClose: () => void`
- `onSuccess: () => void` (called after successful save)

Features:
- Slide-up sheet on mobile: `fixed inset-x-0 bottom-0 z-50 rounded-t-2xl bg-white p-6 shadow-xl`
- Modal on desktop: `md:inset-auto md:right-6 md:bottom-24 md:w-96 md:rounded-2xl`
- Uses existing input components (CurrencyInput, DateInput, PayeeAutocomplete, TagSelector, PaymentMethodSelect)
- NO attachment upload in quick entry (keep it fast)

Type toggle (per CONTEXT.md):
- Default to Income (green)
- Single toggle button showing current type
- Income: green background, "+" icon
- Expense: red background, "-" icon
- Tap to toggle between them
- Layout: type toggle above the form fields, prominent

Form fields (minimal for speed):
- Type toggle (Income/Expense)
- Amount (CurrencyInput) - required
- Payee (PayeeAutocomplete) - required
- Date (DateInput) - defaults to today
- Tags (TagSelector) - optional, single tag for quick entry
- Description (text input) - optional
- Payment method hidden input defaulting to 'card'

Form submission:
- Use progressive enhancement with use:enhance
- On success:
  - Clear form fields (reset to defaults)
  - Keep sheet open (don't call onClose)
  - Show brief success indicator (toast or flash)
  - Call onSuccess to trigger data refresh
- On error: Show error message inline

Close behavior:
- X button in top-right corner
- Clicking backdrop calls onClose
- Escape key closes (optional enhancement)

Style the toggle:
```svelte
<button
  type="button"
  onclick={() => type = type === 'income' ? 'expense' : 'income'}
  class="flex items-center gap-2 rounded-xl px-4 py-3 text-lg font-semibold text-white transition-colors"
  class:bg-green-600={type === 'income'}
  class:bg-red-600={type === 'expense'}
>
  <span class="text-2xl">{type === 'income' ? '+' : '-'}</span>
  <span>{type === 'income' ? 'Income' : 'Expense'}</span>
</button>
```
  </action>
  <verify>
- Components import without errors
- FAB button renders in fixed position
- Clicking FAB opens sheet
- Clicking backdrop closes sheet
- Type toggle switches between income/expense
  </verify>
  <done>
- QuickEntryFAB renders floating button
- QuickEntryForm slides up with type toggle and minimal fields
- Type toggle defaults to Income, taps to Expense
- Form clears on success but stays open
  </done>
</task>

<task type="auto">
  <name>Task 2: Add create action and integrate FAB into transactions page</name>
  <files>
    src/routes/w/[workspace]/transactions/+page.server.ts
    src/routes/w/[workspace]/transactions/+page.svelte
  </files>
  <action>
**1. Update +page.server.ts**

Add a `create` action that mirrors the logic from transactions/new/+page.server.ts:
- Parse form data: type, amountCents, date, payee, description, paymentMethod, tagAllocations
- Validate required fields
- Generate publicId with crypto.randomUUID()
- Insert transaction
- Insert tag allocations if provided
- Insert history record with action 'created'
- Return success with the new transaction's publicId

Reference the existing new/+page.server.ts for the exact implementation pattern. Key differences:
- This action is on the list page, not the new page
- No attachment handling in quick entry
- Simpler tag handling (single tag with 100% allocation)

**2. Update +page.svelte**

Add to the page:
- Import QuickEntryFAB component
- Add to page after timeline content (before closing div)
- Pass required props:
  - workspaceId from data
  - availableTags from data
  - payees: derive unique payee list from transactions

```svelte
<script>
  // ... existing code ...

  // Derive unique payees for autocomplete
  const payees = $derived(
    [...new Set(data.transactions.map(t => t.payee))].sort()
  );
</script>

<!-- ... existing page content ... -->

<QuickEntryFAB
  workspaceId={data.workspaceId}
  availableTags={data.tags}
  {payees}
/>
```

Handle refresh after successful entry:
- Use invalidateAll() from $app/navigation to refresh data
- Or use onSuccess callback to trigger page reload

**3. Load function update**
Ensure the load function returns:
- `tags`: all available tags (already returned)
- Update transactions query to include all payees for autocomplete
  </action>
  <verify>
- Navigate to transactions page
- FAB button visible at bottom-right
- Tap FAB - sheet opens with form
- Fill form and submit - transaction created
- Form clears but sheet stays open
- Timeline updates with new transaction
- Close sheet - FAB visible again
  </verify>
  <done>
- Create action handles transaction creation from quick entry
- FAB integrated into transactions page
- Data refreshes after successful entry
- Rapid entry workflow works (save, form clears, add another)
  </done>
</task>

</tasks>

<verification>
1. `npm run check` - TypeScript compiles
2. `npm run dev` - App runs
3. Test quick entry flow:
   - Navigate to transactions page
   - FAB visible at bottom-right of screen
   - Tap FAB - sheet slides up
   - Type defaults to Income (green)
   - Tap type toggle - switches to Expense (red)
   - Enter amount, payee, save
   - Form clears, sheet stays open
   - New transaction appears in timeline
   - Can immediately add another
   - Close sheet by tapping backdrop or X
4. Test on mobile viewport:
   - Sheet takes full width at bottom
   - Touch targets are large enough
</verification>

<success_criteria>
- [ ] FAB visible and accessible at bottom of transactions page
- [ ] Tapping FAB opens slide-up entry form
- [ ] Type toggle defaults to Income, easy switch to Expense
- [ ] Form submission creates transaction and clears form
- [ ] Sheet stays open for rapid sequential entry
- [ ] Clicking outside sheet closes it
- [ ] Requirement TMLN-03 fully addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-timeline-navigation/05-03-SUMMARY.md`
</output>
