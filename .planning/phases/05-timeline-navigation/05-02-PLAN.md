---
phase: 05-timeline-navigation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/routes/w/[workspace]/transactions/+page.server.ts
  - src/routes/w/[workspace]/transactions/+page.svelte
  - src/lib/components/FiscalYearPicker.svelte
  - src/lib/components/FilterBar.svelte
  - src/lib/components/TimelineEntry.svelte
  - src/lib/components/TimelineDateMarker.svelte
autonomous: true

must_haves:
  truths:
    - "User can view transactions for selected fiscal year"
    - "Net Income YTD displayed prominently in sticky header"
    - "User can switch between fiscal years via dropdown"
    - "Timeline shows vertical date line with grouped transactions"
    - "User can filter by payee, tags, date range, type, and payment method"
    - "Scroll-to-current auto-scrolls to most recent transaction on load"
  artifacts:
    - path: "src/routes/w/[workspace]/transactions/+page.server.ts"
      provides: "Filtered transaction loading with totals"
      exports: ["load"]
    - path: "src/lib/components/FiscalYearPicker.svelte"
      provides: "Fiscal year dropdown selector"
    - path: "src/lib/components/FilterBar.svelte"
      provides: "Transaction filter controls"
    - path: "src/lib/components/TimelineEntry.svelte"
      provides: "Single transaction card in timeline"
  key_links:
    - from: "src/routes/w/[workspace]/transactions/+page.svelte"
      to: "+page.server.ts"
      via: "page.url.searchParams for filter state"
      pattern: "url\\.searchParams"
    - from: "FilterBar.svelte"
      to: "URL state"
      via: "goto() with replaceState"
      pattern: "goto.*replaceState"
---

<objective>
Build the fiscal year-aware transaction timeline with filtering capabilities.

Purpose: Replace the simple transaction list with a proper timeline view that groups transactions by date, shows fiscal year totals in a sticky header, and allows filtering by various criteria. This is the main view users will use daily.

Output: Updated transactions page with sticky header (fiscal year picker + totals), filter bar, vertical timeline layout, and scroll-to-current behavior.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-timeline-navigation/05-CONTEXT.md
@.planning/phases/05-timeline-navigation/05-RESEARCH.md
@.planning/phases/05-timeline-navigation/05-01-SUMMARY.md
@src/routes/w/[workspace]/transactions/+page.server.ts
@src/routes/w/[workspace]/transactions/+page.svelte
@src/lib/utils/fiscal-year.ts
@src/lib/server/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update server load with fiscal year filtering and totals</name>
  <files>
    src/routes/w/[workspace]/transactions/+page.server.ts
  </files>
  <action>
Update the load function to:

1. Parse URL search params for filters:
   - `fy`: Fiscal year number (default: current fiscal year)
   - `payee`: Payee search string (fuzzy match)
   - `tag`: Tag IDs (multiple allowed via getAll)
   - `from`: Date range start (YYYY-MM-DD)
   - `to`: Date range end (YYYY-MM-DD)
   - `type`: 'income' or 'expense'
   - `method`: Payment method ('cash', 'card', 'check')

2. Get workspace settings to read fiscalYearStartMonth and foundedYear

3. Calculate fiscal year date range using getFiscalYearRange utility

4. Build transaction query with filters:
   - Always filter by fiscal year date range
   - Apply additional filters with AND logic across filter types
   - For tags: if any tag filters, transaction must have at least one matching tag (OR within tags)
   - For payee: use LIKE with % wildcards for substring match
   - Exclude soft-deleted transactions (deletedAt IS NULL)
   - Order by date DESC, createdAt DESC

5. Calculate totals for the fiscal year (NOT affected by filters except fiscal year):
   - Total income (excluding voided)
   - Total expenses (excluding voided)
   - Net income = income - expenses

6. Count filtered vs total transactions for display:
   - `totalCount`: All transactions in fiscal year
   - `filteredCount`: Transactions matching current filters

7. Get available fiscal years using getAvailableFiscalYears

8. Return:
   - transactions (with tags)
   - totals (income, expense, net)
   - currentFilters (the parsed filter values for UI)
   - availableFiscalYears
   - fiscalYear (current selected)
   - filteredCount, totalCount

Implementation notes:
- Use Drizzle's `and()`, `or()`, `gte()`, `lte()`, `like()`, `eq()`, `inArray()` operators
- For tag filtering, need to join with transactionTags table
- Import fiscal year utilities from '$lib/utils/fiscal-year'
  </action>
  <verify>
- `npm run check` passes
- Navigate to /w/{workspace}/transactions - loads with current fiscal year
- Add `?fy=2025` to URL - filters to that year
- Add `?type=income` - shows only income transactions
- Add `?payee=test` - filters by payee substring
  </verify>
  <done>
- Load function parses all filter params from URL
- Transactions filtered by fiscal year date range
- Totals calculated for fiscal year (excluding voided)
- Available fiscal years list returned
- Filter counts returned for UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timeline UI components</name>
  <files>
    src/lib/components/FiscalYearPicker.svelte
    src/lib/components/FilterBar.svelte
    src/lib/components/TimelineEntry.svelte
    src/lib/components/TimelineDateMarker.svelte
  </files>
  <action>
Create four new components:

**1. FiscalYearPicker.svelte**
Props: `fiscalYear: number`, `availableYears: number[]`, `startMonth: number`
- Dropdown select styled as compact picker
- Uses formatFiscalYear for display text
- On change: updates URL param `fy` via goto() with replaceState: true, noScroll: true
- Style: matches existing UI (gray-200 border, rounded, etc.)

**2. FilterBar.svelte**
Props: `currentFilters`, `availableTags`, `filteredCount`, `totalCount`
- Horizontal scrollable row of filter controls
- Payee search: text input with search icon, debounced 300ms before URL update
- Type filter: segmented button (All | Income | Expense)
- Tags filter: multi-select dropdown showing tag names
- Date range: two date inputs (from, to)
- Payment method: dropdown (All, Cash, Card, Check)
- Each filter updates URL via goto() with replaceState: true, noScroll: true
- Clear all filters button when any filter active
- Display: "{filteredCount} of {totalCount} transactions"
- Filter logic per CONTEXT.md: OR within same type, AND across types

**3. TimelineEntry.svelte**
Props: `transaction`, `workspaceId: string`
- Compact card showing: payee, amount (colored by type), primary tag, attachment indicator
- Links to transaction detail page
- Income: green text with up arrow icon
- Expense: red text with down arrow icon
- Voided: strike-through, muted colors
- Shows date only if different from previous entry (handled by parent)

**4. TimelineDateMarker.svelte**
Props: `date: string`
- Displays formatted date (e.g., "Thursday, January 30, 2026")
- Circular icon on the vertical timeline line
- Positioned absolutely to overlap the border-s line
- Use Intl.DateTimeFormat for locale-aware formatting

Component styling notes:
- Follow Flowbite timeline pattern: `border-s-2` on parent, absolute positioned date markers
- Keep components small and focused
- Use existing Tailwind patterns from codebase
  </action>
  <verify>
- All four components import without errors
- Components render in isolation with test props
  </verify>
  <done>
- FiscalYearPicker navigates between fiscal years via URL
- FilterBar provides all filter controls
- TimelineEntry shows transaction with proper styling
- TimelineDateMarker shows date with timeline visual
  </done>
</task>

<task type="auto">
  <name>Task 3: Update transactions page with timeline layout</name>
  <files>
    src/routes/w/[workspace]/transactions/+page.svelte
  </files>
  <action>
Rewrite the transactions page with:

**1. Sticky Header**
- Position: `sticky top-0 z-10 bg-white/95 backdrop-blur border-b`
- Left side: FiscalYearPicker component
- Right side: Totals display
  - Income: green, "+$X,XXX.XX"
  - Expense: red, "-$X,XXX.XX"
  - Net: bold, colored based on positive/negative

**2. Filter Bar**
- Below sticky header
- FilterBar component with current filters and tags

**3. Timeline Layout**
- Vertical line on left: `border-s-2 border-gray-200`
- Group transactions by date
- For each date group:
  - TimelineDateMarker
  - List of TimelineEntry components
- Empty state: Different messages for "No transactions in FY XXXX" vs "No transactions match filters"

**4. Scroll to Current**
- On initial load (no filters active), scroll to today's date marker or most recent transaction
- Use `bind:this` on the target element
- Scroll in `$effect` after mount
- Only scroll on initial load, not on filter changes

**5. Income/Expense Buttons**
- Keep the existing large Income/Expense buttons at the top
- They should be visible above the timeline, not sticky

**6. Transaction Grouping Logic**
```typescript
// Group transactions by date
function groupByDate(transactions) {
  const groups = new Map<string, Transaction[]>();
  for (const txn of transactions) {
    const existing = groups.get(txn.date);
    if (existing) existing.push(txn);
    else groups.set(txn.date, [txn]);
  }
  return groups;
}
```

Layout structure:
```svelte
<!-- Income/Expense buttons -->
<div class="grid grid-cols-2 gap-4 mb-6">...</div>

<!-- Sticky header with totals -->
<header class="sticky top-0 ...">
  <FiscalYearPicker ... />
  <div class="totals">...</div>
</header>

<!-- Filter bar -->
<FilterBar ... />

<!-- Timeline -->
<ol class="relative border-s-2 border-gray-200 ms-3 mt-4">
  {#each groupedTransactions as [date, txns]}
    <li class="mb-6 ms-6">
      <TimelineDateMarker {date} bind:this={...} />
      {#each txns as txn}
        <TimelineEntry transaction={txn} {workspaceId} />
      {/each}
    </li>
  {/each}
</ol>
```
  </action>
  <verify>
- Page loads with sticky header showing fiscal year and totals
- Transactions grouped by date with visual timeline
- Changing fiscal year updates URL and reloads data
- Filters work and update counts
- Scroll-to-current works on initial load
  </verify>
  <done>
- Timeline view with sticky header and fiscal year totals
- Filter bar with all filter types working
- Transactions grouped by date with visual timeline design
- Scroll-to-current on initial page load
- All requirements TMLN-01, TMLN-02, TMLN-04, TMLN-05, TMLN-06, TMLN-07, TMLN-08, TMLN-09, TMLN-10, FISC-01, FISC-04, FISC-05 addressed
  </done>
</task>

</tasks>

<verification>
1. `npm run check` - TypeScript compiles
2. `npm run dev` - App runs
3. Navigate to transactions page:
   - Sticky header shows with fiscal year picker and totals
   - Transactions grouped by date in vertical timeline
   - Filter bar present below header
4. Test fiscal year switching:
   - Change year in picker - URL updates, data reloads
   - Totals update for selected year
5. Test filters:
   - Type filter: All/Income/Expense works
   - Payee search: filters by substring
   - Tag filter: shows transactions with selected tags
   - Date range: limits to date window
   - Clear filters resets all
6. Scroll-to-current: On fresh load, page scrolls to recent transactions
</verification>

<success_criteria>
- [ ] Sticky header with fiscal year picker and income/expense/net totals
- [ ] Filter bar with payee search, type, tags, date range, payment method
- [ ] Transactions grouped by date with vertical timeline design
- [ ] Scroll-to-current works on initial page load
- [ ] URL state preserves filter selections on refresh
- [ ] Empty states differentiate "no data" vs "no matches"
</success_criteria>

<output>
After completion, create `.planning/phases/05-timeline-navigation/05-02-SUMMARY.md`
</output>
