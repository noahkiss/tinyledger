---
phase: 05-timeline-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/db/schema.ts
  - src/lib/server/db/migrate.ts
  - src/lib/utils/fiscal-year.ts
  - src/routes/w/[workspace]/settings/+page.svelte
  - src/routes/w/[workspace]/settings/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Fiscal year defaults to calendar year (January start)"
    - "User can configure fiscal year start month in workspace settings"
    - "Fiscal year calculation correctly handles non-calendar year configurations"
    - "Historical fiscal years are available back to founded year"
  artifacts:
    - path: "src/lib/utils/fiscal-year.ts"
      provides: "Fiscal year calculation utilities"
      exports: ["getCurrentFiscalYear", "getFiscalYearRange", "getAvailableFiscalYears"]
    - path: "src/lib/server/db/schema.ts"
      provides: "fiscalYearStartMonth column on workspace_settings"
      contains: "fiscalYearStartMonth"
  key_links:
    - from: "src/lib/utils/fiscal-year.ts"
      to: "workspace_settings.fiscalYearStartMonth"
      via: "startMonth parameter to utilities"
      pattern: "getFiscalYear.*startMonth"
---

<objective>
Add fiscal year configuration and utilities for timeline navigation.

Purpose: Enable configurable fiscal year boundaries that Phase 5's timeline will use to scope transactions. Calendar year is default, but users can configure a different start month (e.g., July for July-June fiscal year).

Output: New schema column for fiscal year start month, utility functions for fiscal year calculations, and settings UI to configure the start month.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-timeline-navigation/05-CONTEXT.md
@.planning/phases/05-timeline-navigation/05-RESEARCH.md
@src/lib/server/db/schema.ts
@src/lib/server/db/migrate.ts
@src/routes/w/[workspace]/settings/+page.svelte
@src/routes/w/[workspace]/settings/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fiscalYearStartMonth to schema and create utilities</name>
  <files>
    src/lib/server/db/schema.ts
    src/lib/server/db/migrate.ts
    src/lib/utils/fiscal-year.ts
  </files>
  <action>
1. Update workspace_settings in schema.ts:
   - Add `fiscalYearStartMonth: integer('fiscal_year_start_month').default(1).notNull()` after tagsLocked
   - Update WorkspaceSettings type export

2. Update migrate.ts to add migration for existing databases:
   - Add column if not exists: `ALTER TABLE workspace_settings ADD COLUMN fiscal_year_start_month INTEGER DEFAULT 1 NOT NULL`
   - Handle gracefully if column already exists (SQLite throws error on duplicate add)

3. Create src/lib/utils/fiscal-year.ts with these functions:

```typescript
/**
 * Get fiscal year for a given date.
 * For FY with startMonth=1 (Jan): FY 2026 = Jan 1, 2026 - Dec 31, 2026
 * For FY with startMonth=7 (Jul): FY 2026 = Jul 1, 2025 - Jun 30, 2026
 * Convention: FY number is the year the fiscal year ENDS.
 */
export function getFiscalYear(date: Date, startMonth: number = 1): number

/**
 * Get the start and end dates for a fiscal year.
 * Returns ISO date strings (YYYY-MM-DD) suitable for DB queries.
 */
export function getFiscalYearRange(fiscalYear: number, startMonth: number = 1): { start: string; end: string }

/**
 * Get current fiscal year based on today's date.
 */
export function getCurrentFiscalYear(startMonth: number = 1): number

/**
 * Get list of available fiscal years from foundedYear to next year.
 * Returns array of fiscal year numbers in descending order.
 */
export function getAvailableFiscalYears(foundedYear: number | null, startMonth: number = 1): number[]

/**
 * Format fiscal year for display (e.g., "FY 2026" or "2025-2026" for non-calendar).
 */
export function formatFiscalYear(fiscalYear: number, startMonth: number = 1): string

/**
 * Get the last day of a given month.
 */
function getLastDayOfMonth(year: number, month: number): number
```

Key implementation notes:
- startMonth is 1-indexed (1=January, 7=July, etc.)
- FY2026 with startMonth=7 means Jul 1, 2025 to Jun 30, 2026
- For calendar year (startMonth=1): format as "FY 2026"
- For non-calendar year (startMonth>1): format as "FY 2025-2026"
  </action>
  <verify>
- `npm run check` passes with no type errors
- New column exists in schema exports
- Utility functions are importable: `import { getCurrentFiscalYear } from '$lib/utils/fiscal-year'`
  </verify>
  <done>
- Schema includes fiscalYearStartMonth column with default 1
- Migration handles adding column to existing DBs
- All 5 utility functions exported and typed correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fiscal year configuration to workspace settings UI</name>
  <files>
    src/routes/w/[workspace]/settings/+page.svelte
    src/routes/w/[workspace]/settings/+page.server.ts
  </files>
  <action>
1. Update +page.server.ts:
   - Ensure load function returns current fiscalYearStartMonth from settings
   - Add handling in the update action for fiscalYearStartMonth field
   - Validate fiscalYearStartMonth is 1-12

2. Update +page.svelte:
   - Add a "Fiscal Year" section after existing settings (before Tags section)
   - Include a select dropdown for fiscal year start month
   - Options: January through December (value 1-12)
   - Display format: "January (Calendar Year)" for month 1, just month name for others
   - Add helper text: "Fiscal year runs from selected month through the following year. Most businesses use calendar year (January)."
   - The select should be inside the existing form or a new form with action="?/update"

UI placement (after business info, before Tags Management link):
```svelte
<!-- Fiscal Year -->
<div class="rounded-lg border border-gray-200 bg-white p-4">
  <h3 class="font-medium text-gray-900">Fiscal Year</h3>
  <p class="mt-1 text-sm text-gray-500">...</p>
  <select name="fiscalYearStartMonth" ...>
    {#each months as month, i}
      <option value={i + 1}>{month.name}</option>
    {/each}
  </select>
</div>
```
  </action>
  <verify>
- Navigate to workspace settings page
- Fiscal Year section is visible with month dropdown
- Changing month and saving persists the value
- Refreshing page shows saved value selected
  </verify>
  <done>
- Settings UI includes fiscal year start month selector
- Value persists to database on save
- Default is January (1) for existing workspaces
  </done>
</task>

</tasks>

<verification>
1. `npm run check` - TypeScript compiles without errors
2. `npm run dev` - App starts successfully
3. Create new workspace - fiscalYearStartMonth defaults to 1
4. Edit workspace settings - can change fiscal year start month
5. Import fiscal-year utilities in a test file - all functions available
</verification>

<success_criteria>
- [ ] Schema has fiscalYearStartMonth column with default 1
- [ ] Migration adds column to existing databases
- [ ] Utility functions correctly calculate fiscal year boundaries
- [ ] Settings UI allows configuring fiscal year start month
- [ ] All requirements FISC-02, FISC-03 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-timeline-navigation/05-01-SUMMARY.md`
</output>
