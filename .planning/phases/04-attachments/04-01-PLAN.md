---
phase: 04-attachments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/db/schema.ts
  - src/lib/server/storage/attachment.ts
  - src/routes/api/attachment/[workspace]/[transactionId]/+server.ts
autonomous: true

must_haves:
  truths:
    - "Attachments table exists in database with transaction relationship"
    - "Storage module can save, retrieve, and delete attachment files"
    - "API endpoint serves attachments with correct MIME type"
    - "API endpoint supports download with export-friendly filename"
  artifacts:
    - path: "src/lib/server/db/schema.ts"
      provides: "Attachments table schema"
      contains: "attachments = sqliteTable"
    - path: "src/lib/server/storage/attachment.ts"
      provides: "Attachment CRUD operations"
      exports: ["saveAttachment", "getAttachment", "deleteAttachment", "generateExportFilename"]
    - path: "src/routes/api/attachment/[workspace]/[transactionId]/+server.ts"
      provides: "Attachment serving endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/lib/server/storage/attachment.ts"
      to: "data/attachments/{workspaceId}/"
      via: "filesystem operations"
      pattern: "join.*attachments"
    - from: "src/routes/api/attachment/[workspace]/[transactionId]/+server.ts"
      to: "src/lib/server/storage/attachment.ts"
      via: "getAttachment import"
      pattern: "import.*getAttachment"
---

<objective>
Set up attachment storage infrastructure: database schema, storage module, and serving endpoint.

Purpose: Establish the foundation for receipt attachments with workspace isolation and secure file handling.
Output: Database table for attachment metadata, storage module mirroring logo.ts pattern, and API endpoint for serving.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-attachments/04-RESEARCH.md
@src/lib/server/db/schema.ts
@src/lib/server/storage/logo.ts
@src/routes/api/logo/[workspace]/[filename]/+server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add attachments table to database schema</name>
  <files>src/lib/server/db/schema.ts</files>
  <action>
Add an `attachments` table to the schema with the following structure:
- `id`: integer primary key auto-increment
- `transactionId`: integer, NOT NULL, UNIQUE (one attachment per transaction), references transactions.id with onDelete cascade
- `filename`: text NOT NULL (stored filename like "abc-123.jpg")
- `originalName`: text NOT NULL (user's original filename for display)
- `mimeType`: text NOT NULL (e.g., "image/jpeg")
- `sizeBytes`: integer NOT NULL
- `createdAt`: text with CURRENT_TIMESTAMP default
- `updatedAt`: text with CURRENT_TIMESTAMP default

Add index on transactionId for efficient lookups.

Add relations:
- `attachmentsRelations`: one-to-one with transactions
- Update `transactionsRelations` to include optional `attachment` relationship

Export types: `Attachment`, `NewAttachment`
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles with no errors.
Check that schema exports include `attachments`, `attachmentsRelations`, `Attachment`, `NewAttachment`.
  </verify>
  <done>
Attachments table schema exists with proper transaction relationship and type exports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create attachment storage module</name>
  <files>src/lib/server/storage/attachment.ts</files>
  <action>
Create attachment storage module mirroring the pattern in logo.ts:

**Constants:**
- `DATA_DIR = process.env.DATA_DIR ?? './data'`
- `ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif']`
- `MAX_SIZE_BYTES = 10 * 1024 * 1024` (10MB)

**Helper functions:**
- `getAttachmentsDir(workspaceId: string): string` - returns `{DATA_DIR}/attachments/{workspaceId}`
- `getAttachmentPath(workspaceId: string, transactionPublicId: string, ext: string): string`

**Exported functions:**

1. `saveAttachment(workspaceId: string, transactionPublicId: string, file: File): Promise<{ filename: string; mimeType: string; sizeBytes: number }>`
   - Validate MIME type against ALLOWED_TYPES (throw if invalid)
   - Validate size <= MAX_SIZE_BYTES (throw if too large)
   - Ensure directory exists with mkdirSync recursive
   - Delete any existing attachment for this transaction first
   - Read file buffer, re-encode through Sharp:
     - GIF: preserve as GIF (animated support)
     - Everything else: convert to JPEG quality 90
   - Write to filesystem as `{transactionPublicId}.{ext}`
   - Return { filename, mimeType, sizeBytes }

2. `getAttachment(workspaceId: string, transactionPublicId: string): { buffer: Buffer; mimeType: string; filename: string } | null`
   - Look for file matching pattern `{transactionPublicId}.*` in workspace dir
   - Return null if not found
   - Return { buffer, mimeType, filename } if found
   - Determine mimeType from extension (.jpg -> image/jpeg, .gif -> image/gif)

3. `deleteAttachment(workspaceId: string, transactionPublicId: string): boolean`
   - Find and delete file matching `{transactionPublicId}.*`
   - Return true if deleted, false if not found

4. `generateExportFilename(date: string, payee: string, amountCents: number, ext: string): string`
   - Sanitize payee: remove special chars, replace spaces with underscores, limit to 30 chars
   - Format amount as dollars (no cents)
   - Return `{date}_{sanitizedPayee}_${amount}{ext}` (e.g., "2026-01-25_Office_Depot_$125.jpg")
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles.
Manually verify the module exports the four functions correctly by checking exports.
  </verify>
  <done>
Storage module provides complete attachment CRUD with Sharp re-encoding and export filename generation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create attachment serving API endpoint</name>
  <files>src/routes/api/attachment/[workspace]/[transactionId]/+server.ts</files>
  <action>
Create API endpoint to serve attachments, mirroring logo endpoint pattern:

**GET handler:**
1. Extract workspace and transactionId from params
2. Call `getAttachment(workspace, transactionId)`
3. If null, throw error(404, 'Attachment not found')
4. Check URL query params:
   - `download=true`: Set Content-Disposition attachment header
   - `exportName={name}`: Use provided name for download (for bulk export)
   - If no exportName but download=true, use original filename
5. Return Response with:
   - Body: `new Uint8Array(buffer)`
   - Headers:
     - `Content-Type`: mimeType from getAttachment
     - `Cache-Control`: 'private, max-age=3600' (shorter than logo - attachments may be replaced)
     - `Content-Disposition`: attachment header if download=true

Import from $lib/server/storage/attachment.
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles.
Start dev server and confirm route is registered (no 404 for the route structure).
  </verify>
  <done>
API endpoint serves attachments with proper MIME type and supports download with export-friendly filenames.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no TypeScript errors
2. Schema file exports attachments table and types
3. Storage module exports all four functions
4. API endpoint file exists at correct path
5. Dev server starts without errors
</verification>

<success_criteria>
- Attachments table added to schema with transaction FK and unique constraint
- Storage module handles save/get/delete with Sharp re-encoding for security
- API endpoint serves files with correct MIME types
- Download support with export-friendly filename generation (YYYY-MM-DD_Payee_$Amount.ext)
</success_criteria>

<output>
After completion, create `.planning/phases/04-attachments/04-01-SUMMARY.md`
</output>
