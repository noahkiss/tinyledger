---
phase: 04-attachments
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/components/AttachmentUpload.svelte
  - src/routes/w/[workspace]/transactions/new/+page.svelte
  - src/routes/w/[workspace]/transactions/new/+page.server.ts
  - src/routes/w/[workspace]/transactions/[id]/+page.svelte
  - src/routes/w/[workspace]/transactions/[id]/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can upload receipt during transaction creation"
    - "User can view existing attachment on transaction detail page"
    - "User can replace attachment on existing transaction"
    - "User can download attachment with export-friendly filename"
    - "File preview shows before upload"
  artifacts:
    - path: "src/lib/components/AttachmentUpload.svelte"
      provides: "Upload component with preview and drag-drop"
      min_lines: 50
    - path: "src/routes/w/[workspace]/transactions/new/+page.svelte"
      provides: "Transaction form with attachment field"
      contains: "AttachmentUpload"
    - path: "src/routes/w/[workspace]/transactions/[id]/+page.svelte"
      provides: "Transaction detail with attachment view/replace"
      contains: "AttachmentUpload"
  key_links:
    - from: "src/routes/w/[workspace]/transactions/new/+page.server.ts"
      to: "src/lib/server/storage/attachment.ts"
      via: "saveAttachment call in form action"
      pattern: "import.*saveAttachment"
    - from: "src/routes/w/[workspace]/transactions/[id]/+page.server.ts"
      to: "src/lib/server/db/schema.ts"
      via: "attachments table query"
      pattern: "from.*attachments"
---

<objective>
Integrate attachment upload into transaction forms and display on detail page.

Purpose: Enable users to upload, view, replace, and download receipt attachments during transaction workflow.
Output: AttachmentUpload component, integrated forms, and attachment display on detail page.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-attachments/04-RESEARCH.md
@.planning/phases/04-attachments/04-01-SUMMARY.md
@src/routes/w/[workspace]/transactions/new/+page.svelte
@src/routes/w/[workspace]/transactions/new/+page.server.ts
@src/routes/w/[workspace]/transactions/[id]/+page.svelte
@src/routes/w/[workspace]/transactions/[id]/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AttachmentUpload component</name>
  <files>src/lib/components/AttachmentUpload.svelte</files>
  <action>
Create a reusable attachment upload component with Svelte 5 runes:

**Props (using $props()):**
- `name`: string = 'attachment' (form field name)
- `existingUrl`: string | null = null (URL to existing attachment for display)
- `existingFilename`: string | null = null (original filename for display)
- `onRemove`: (() => void) | undefined = undefined (callback when user removes existing)
- `class`: string = '' (additional CSS classes)

**State (using $state):**
- `files`: FileList | undefined
- `previewUrl`: string | null = null
- `dragOver`: boolean = false

**Effects (using $effect):**
1. When files changes:
   - Revoke previous previewUrl if exists (prevent memory leak)
   - If files has content, create new URL with URL.createObjectURL(files[0])
   - If no files, set previewUrl to null
2. Cleanup effect: Return cleanup function that revokes previewUrl on unmount

**Derived:**
- `displayUrl`: previewUrl || existingUrl (show preview if selecting, else existing)

**UI Structure:**
1. Hidden file input with accept="image/jpeg,image/png,image/webp,image/gif"
2. If displayUrl exists:
   - Show image preview with rounded corners and shadow
   - X button in top-right corner to clear (calls clearSelection if new file, onRemove if existing)
   - Show filename below image (from files[0].name or existingFilename)
3. Else (no image):
   - Show upload zone with dashed border
   - Plus icon centered
   - Text: "Click or drag to upload receipt"
   - Subtext: "JPEG, PNG, WebP, GIF up to 10MB"
   - Support drag-and-drop: ondragover, ondragleave, ondrop handlers
   - Highlight border on dragover (blue-500)

**Helper function:**
- `clearSelection()`: Reset files to empty DataTransfer().files, set previewUrl to null

Style with Tailwind, match existing component patterns.
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles.
Component file exists and exports default.
  </verify>
  <done>
AttachmentUpload component provides file selection, preview, drag-drop, and clear functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate attachment into transaction creation</name>
  <files>
    src/routes/w/[workspace]/transactions/new/+page.svelte
    src/routes/w/[workspace]/transactions/new/+page.server.ts
  </files>
  <action>
**In +page.svelte:**
1. Import AttachmentUpload component
2. Add AttachmentUpload field after Tags section, before Submit button
3. Label: "Receipt" with "(optional)" in gray
4. Add `enctype="multipart/form-data"` to the form element (CRITICAL for file uploads)

**In +page.server.ts:**
1. Import `saveAttachment` from '$lib/server/storage/attachment'
2. Import `attachments` from schema
3. After transaction is inserted and transactionId is available:
   - Get attachment file: `formData.get('attachment') as File | null`
   - If attachment exists AND attachment.size > 0:
     - Call saveAttachment(params.workspace, publicId, attachment)
     - Insert into attachments table:
       ```typescript
       db.insert(attachments).values({
         transactionId,
         filename: result.filename,
         originalName: attachment.name,
         mimeType: result.mimeType,
         sizeBytes: result.sizeBytes
       }).run();
       ```
   - Wrap in try/catch, on error return fail(400, { error: err.message })

Note: The form already uses use:enhance, which handles FormData properly.
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles.
Load new transaction page in browser, verify AttachmentUpload component renders.
Test file selection shows preview.
  </verify>
  <done>
New transaction form accepts attachment upload and saves to filesystem + database.
  </done>
</task>

<task type="auto">
  <name>Task 3: Display and replace attachment on transaction detail</name>
  <files>
    src/routes/w/[workspace]/transactions/[id]/+page.svelte
    src/routes/w/[workspace]/transactions/[id]/+page.server.ts
  </files>
  <action>
**In +page.server.ts load function:**
1. Import `attachments` from schema
2. Query for attachment after loading transaction:
   ```typescript
   const attachment = db.select().from(attachments)
     .where(eq(attachments.transactionId, transaction.id))
     .get();
   ```
3. Add to return object:
   ```typescript
   return {
     ...existing,
     attachment: attachment ? {
       url: `/api/attachment/${params.workspace}/${transaction.publicId}`,
       filename: attachment.originalName,
       downloadUrl: `/api/attachment/${params.workspace}/${transaction.publicId}?download=true`
     } : null
   };
   ```

**In +page.server.ts edit action:**
1. Import `saveAttachment`, `deleteAttachment` from storage/attachment
2. After existing transaction update logic:
   - Get attachment file from formData
   - Get removeAttachment flag: `formData.get('removeAttachment') === 'true'`
   - If removeAttachment is true:
     - Delete from filesystem: `deleteAttachment(params.workspace, existing.publicId)`
     - Delete from database: `db.delete(attachments).where(eq(attachments.transactionId, existing.id)).run()`
   - Else if new attachment with size > 0:
     - Save to filesystem
     - Upsert to database (delete old first, then insert new)

**In +page.svelte:**
1. Import AttachmentUpload
2. In the view mode section (when not editing), if data.attachment exists:
   - Display attachment image using img tag with src={data.attachment.url}
   - Add "View full size" link opening in new tab
   - Add "Download" link with href={data.attachment.downloadUrl}
   - Generate export filename using date, payee, amount from transaction
   - Download link: `{downloadUrl}&exportName={encodedExportName}`
3. In edit mode:
   - Add hidden input `name="removeAttachment"` with value controlled by state
   - Add AttachmentUpload with existingUrl and onRemove callback
   - onRemove sets removeAttachment state to true and clears existingUrl display
4. Add `enctype="multipart/form-data"` to edit form

**Export filename generation (client-side for download link):**
- Use transaction data: date, payee, amountCents
- Sanitize payee: replace non-alphanumeric with '', spaces with '_', limit 30 chars
- Format: `${date}_${sanitizedPayee}_$${Math.round(amountCents/100)}.jpg`
- URL encode the filename for the query param
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles.
Load transaction detail page, verify attachment displays if present.
Test download link generates correct export filename.
Test edit mode shows attachment with replace/remove functionality.
  </verify>
  <done>
Transaction detail shows attachment with view/download links and supports replacement in edit mode.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no TypeScript errors
2. New transaction form has working attachment upload
3. Transaction detail shows attachment with correct image
4. Download link uses export-friendly filename (YYYY-MM-DD_Payee_$Amount.ext)
5. Edit mode can replace or remove attachment
6. File preview works before upload (object URL)
7. Dev server starts and pages render without errors
</verification>

<success_criteria>
- AttachmentUpload component provides preview, drag-drop, clear functionality
- Transaction creation form accepts and saves attachments
- Transaction detail displays attachment with view full-size and download options
- Download filename follows YYYY-MM-DD_Payee_$Amount.ext pattern
- Edit mode supports attachment replacement and removal
- Memory management: object URLs properly revoked on cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/04-attachments/04-02-SUMMARY.md`
</output>
