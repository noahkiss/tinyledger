---
phase: 03-tags-categories
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/data/schedulec-categories.ts
  - src/lib/server/db/seed-tags.ts
  - src/lib/server/db/migrate.ts
  - src/lib/server/workspace/index.ts
  - src/lib/server/db/schema.ts
  - src/routes/w/[workspace]/settings/tags/+page.svelte
  - src/routes/w/[workspace]/settings/tags/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "New workspaces have 27 Schedule C tags pre-seeded"
    - "User can view all tags with usage counts on tags management page"
    - "User can rename a tag and the change reflects everywhere"
    - "User can merge two tags (source tag transactions move to target)"
    - "User can delete unused tags (in-use tags show merge instead)"
    - "Tag lock mode setting exists in workspace settings"
  artifacts:
    - path: "src/lib/data/schedulec-categories.ts"
      provides: "Schedule C category constants"
      exports: ["SCHEDULE_C_CATEGORIES"]
    - path: "src/lib/server/db/seed-tags.ts"
      provides: "Tag seeding function"
      exports: ["seedScheduleCTags"]
    - path: "src/routes/w/[workspace]/settings/tags/+page.svelte"
      provides: "Tags management UI"
      min_lines: 80
    - path: "src/routes/w/[workspace]/settings/tags/+page.server.ts"
      provides: "Tag CRUD actions"
      exports: ["load", "actions"]
  key_links:
    - from: "src/lib/server/workspace/index.ts"
      to: "src/lib/server/db/seed-tags.ts"
      via: "seedScheduleCTags call in createWorkspace"
      pattern: "seedScheduleCTags\\(db\\)"
    - from: "src/routes/w/[workspace]/settings/tags/+page.server.ts"
      to: "src/lib/server/db/schema.ts"
      via: "drizzle queries"
      pattern: "from\\(tags\\)"
---

<objective>
Implement complete tag infrastructure: Schedule C category pre-seeding for new workspaces, tag lock mode workspace setting, and a full tags management page with rename, merge, and delete operations.

Purpose: Enable tax-ready categorization from workspace creation and give users control over their tag taxonomy. This phase creates the foundation for TAGS-01 through TAGS-04 and WKSP-08.

Output: Schedule C categories seeded on new workspace creation, tags management page in settings, tag lock mode field in workspace_settings table.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-tags-categories/03-RESEARCH.md

# Key existing files
@src/lib/server/db/schema.ts
@src/lib/server/db/migrate.ts
@src/lib/server/workspace/index.ts
@src/routes/w/[workspace]/settings/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schedule C Categories and Tag Seeding</name>
  <files>
    src/lib/data/schedulec-categories.ts
    src/lib/server/db/seed-tags.ts
    src/lib/server/db/schema.ts
    src/lib/server/db/migrate.ts
    src/lib/server/workspace/index.ts
  </files>
  <action>
1. Create `src/lib/data/schedulec-categories.ts` with the 27 Schedule C categories from research:
   - Export `SCHEDULE_C_CATEGORIES` as const array of strings
   - Include expense categories (Vehicle Expenses, Commissions & Fees, Contract Labor, etc.)
   - Include 3 income categories at end (Sales Revenue, Service Income, Other Income)
   - Export type `ScheduleCCategory` derived from the array

2. Create `src/lib/server/db/seed-tags.ts`:
   - Import `tags` from schema and `SCHEDULE_C_CATEGORIES` from data
   - Export `seedScheduleCTags(db: BetterSQLite3Database)` function
   - Check if tags table is empty before seeding (only seed new workspaces)
   - Insert all categories as tags in a loop

3. Add `tagsLocked` boolean field to `workspace_settings` in schema.ts:
   - Add column: `tagsLocked: integer('tags_locked').default(0).notNull()` (SQLite boolean as 0/1)

4. Update `migrate.ts` to add the tagsLocked column:
   - Add ALTER TABLE statement wrapped in try/catch (column may already exist)
   - `ALTER TABLE workspace_settings ADD COLUMN tags_locked INTEGER DEFAULT 0 NOT NULL`

5. Update `createWorkspace()` in `src/lib/server/workspace/index.ts`:
   - Import `seedScheduleCTags` from seed-tags
   - Call `seedScheduleCTags(db)` after updating workspace settings
   - This ensures new workspaces get Schedule C tags on creation
  </action>
  <verify>
Create a test workspace and verify:
```bash
# Create a new workspace via the app's create workspace flow
# Then check database:
cd /home/flight/develop/tinyledger
sqlite3 data/workspaces/[new-workspace-id].db "SELECT name FROM tags ORDER BY name LIMIT 10;"
# Should show: Advertising & Marketing, Bank & Merchant Fees, etc.
sqlite3 data/workspaces/[new-workspace-id].db "SELECT COUNT(*) FROM tags;"
# Should return 27
```
  </verify>
  <done>New workspace databases have 27 Schedule C category tags pre-seeded. workspace_settings table has tags_locked column.</done>
</task>

<task type="auto">
  <name>Task 2: Tags Management Page</name>
  <files>
    src/routes/w/[workspace]/settings/tags/+page.server.ts
    src/routes/w/[workspace]/settings/tags/+page.svelte
  </files>
  <action>
1. Create `src/routes/w/[workspace]/settings/tags/+page.server.ts`:

**Load function:**
- Query all tags with usage count via subquery:
  ```typescript
  SELECT tags.*, (SELECT COUNT(*) FROM transaction_tags WHERE tag_id = tags.id) as usageCount
  FROM tags ORDER BY name
  ```
- Return tags array with id, name, createdAt, usageCount
- Also return workspace settings (for tagsLocked status)

**Actions:**
- `rename`: Parse id and newName from formData. Check for duplicate name (case-insensitive using LOWER()). Update tag name. Return success or error.

- `merge`: Parse sourceId and targetId from formData. Validate both exist and are different. Transaction logic:
  1. Update all transactionTags where tagId = sourceId to tagId = targetId
  2. Handle duplicate allocations (same transaction has both tags):
     - Find transactions that now have duplicate tagId entries
     - Sum their percentages and keep one row
     - Delete the duplicate row
  3. Delete the source tag
  Return merged: { from: sourceName, to: targetName }

- `delete`: Parse id from formData. Check usageCount > 0 and reject with "merge instead" message. Delete tag if unused. Return success.

- `toggleLock`: Toggle tagsLocked in workspace_settings. Return new lock state.

2. Create `src/routes/w/[workspace]/settings/tags/+page.svelte`:

**Layout:**
- Page title "Manage Tags" with tag count
- Toggle switch for "Lock Tags" mode with explanation text
- List of tags as cards/rows showing:
  - Tag name (editable inline or via button)
  - Usage count ("Used in X transactions")
  - Rename button -> opens inline edit or modal
  - Merge button -> opens merge dialog
  - Delete button (only shown if usageCount === 0)

**Merge Dialog (modal):**
- Shows source tag name
- Dropdown to select target tag (excludes source)
- Warning: "All X transactions will be reassigned"
- Cancel and Merge buttons
- Uses form with action="?/merge"

**Lock Toggle:**
- Checkbox or toggle switch
- Form action="?/toggleLock"
- Shows explanation: "When locked, new tags cannot be created during transaction entry"

**Styling:**
- Use existing Tailwind patterns from settings page
- Card/row style for each tag
- Color-coded delete button (red, only for unused)
- Orange for merge button

Use `use:enhance` for all forms for smooth UX without full page reload.
  </action>
  <verify>
```bash
npm run dev
```
Navigate to http://localhost:5173/w/[workspace-id]/settings/tags
1. Verify tag list displays with usage counts
2. Rename a tag - verify it updates in list
3. Merge two tags - verify source disappears, target keeps both names' transactions
4. Try to delete a used tag - verify error message
5. Delete an unused tag - verify it disappears
6. Toggle lock mode - verify toggle persists after page refresh
  </verify>
  <done>Tags management page at /w/[workspace]/settings/tags allows viewing all tags with usage counts, renaming tags, merging tags (source to target), deleting unused tags, and toggling tag lock mode.</done>
</task>

<task type="auto">
  <name>Task 3: Link Tags Page from Settings</name>
  <files>
    src/routes/w/[workspace]/settings/+page.svelte
  </files>
  <action>
Add a link/card to the tags management page from the main settings page.

1. In the existing settings page, add a new section after the form (or within it as a separate card):
   ```svelte
   <!-- Tags Management Link -->
   <div class="rounded-lg border border-gray-200 bg-white p-6">
     <h3 class="text-lg font-medium text-gray-900">Tags & Categories</h3>
     <p class="mt-1 text-sm text-gray-500">
       Manage expense categories, rename or merge tags, and control tag creation.
     </p>
     <a
       href="/w/{data.settings.id?.toString() ?? ''}/settings/tags"
       class="mt-4 inline-flex items-center rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200"
     >
       Manage Tags
       <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
       </svg>
     </a>
   </div>
   ```

2. Position this section appropriately - either:
   - As a separate card below the main settings form, OR
   - Within the form as a fieldset if that makes more sense visually

Ensure the link uses the correct workspace ID from data.
  </action>
  <verify>
```bash
npm run dev
```
Navigate to http://localhost:5173/w/[workspace-id]/settings
1. Verify "Tags & Categories" section is visible
2. Click "Manage Tags" link
3. Verify navigation to /w/[workspace-id]/settings/tags
  </verify>
  <done>Settings page has a visible link to the tags management page with clear description of what it does.</done>
</task>

</tasks>

<verification>
1. Create a new workspace and verify 27 Schedule C tags exist
2. Tags management page loads and shows all tags with usage counts
3. Rename, merge, delete operations work correctly
4. Lock mode toggles and persists
5. Settings page links to tags management
6. No TypeScript errors: `npm run check`
</verification>

<success_criteria>
- WKSP-08: New workspaces include pre-seeded Schedule C categories (27 tags)
- TAGS-02: Tags management page allows viewing, renaming, merging, and deleting tags
- TAGS-03: Tag lock mode setting exists and can be toggled
- TAGS-04: Pre-seeded tags are IRS Schedule C categories
- Settings page provides clear path to tag management
</success_criteria>

<output>
After completion, create `.planning/phases/03-tags-categories/03-01-SUMMARY.md`
</output>
