---
phase: 03-tags-categories
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/components/PayeeAutocomplete.svelte
  - src/lib/components/TagSelector.svelte
  - src/routes/w/[workspace]/transactions/new/+page.server.ts
  - src/routes/w/[workspace]/transactions/new/+page.svelte
  - src/routes/w/[workspace]/transactions/[id]/edit/+page.server.ts
  - src/routes/w/[workspace]/transactions/[id]/edit/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can type in payee field and see fuzzy-matched suggestions from history"
    - "Selecting a payee suggestion auto-fills tag suggestions based on that payee's last transaction"
    - "Selecting a payee suggestion shows last amount as a hint (user can override)"
    - "User can create a new tag inline while entering a transaction"
    - "Tag creation respects workspace lock mode (disabled when locked)"
  artifacts:
    - path: "src/lib/components/PayeeAutocomplete.svelte"
      provides: "Fuzzy search payee input with suggestions"
      min_lines: 60
    - path: "src/lib/components/TagSelector.svelte"
      provides: "Enhanced tag selector with inline creation"
      exports: ["default"]
    - path: "src/routes/w/[workspace]/transactions/new/+page.server.ts"
      provides: "Payee history query and createTag action"
      exports: ["load", "actions"]
  key_links:
    - from: "src/routes/w/[workspace]/transactions/new/+page.svelte"
      to: "src/lib/components/PayeeAutocomplete.svelte"
      via: "component import and onSelect callback"
      pattern: "PayeeAutocomplete.*onSelect"
    - from: "src/lib/components/PayeeAutocomplete.svelte"
      to: "@nozbe/microfuzz"
      via: "createFuzzySearch import"
      pattern: "createFuzzySearch|@nozbe/microfuzz"
    - from: "src/routes/w/[workspace]/transactions/new/+page.svelte"
      to: "src/routes/w/[workspace]/transactions/new/+page.server.ts"
      via: "fetch ?/createTag action"
      pattern: "\\?/createTag"
---

<objective>
Implement predictive entry features: payee autocomplete with fuzzy matching, tag suggestions based on payee history, optional amount pre-fill, and inline tag creation during transaction entry.

Purpose: Enable the "10-second transaction entry" experience where returning payees auto-suggest their usual tags and amounts, while allowing on-the-fly tag creation for new categories. This implements TAGS-01, PRED-01, PRED-02, and PRED-03.

Output: PayeeAutocomplete component with fuzzy search, enhanced TagSelector with inline creation, transaction form integration with predictive features.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-tags-categories/03-RESEARCH.md

# Key existing files
@src/lib/components/TagSelector.svelte
@src/routes/w/[workspace]/transactions/new/+page.svelte
@src/routes/w/[workspace]/transactions/new/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Microfuzz and Create PayeeAutocomplete Component</name>
  <files>
    package.json
    src/lib/components/PayeeAutocomplete.svelte
  </files>
  <action>
1. Install microfuzz:
   ```bash
   npm install @nozbe/microfuzz
   ```

2. Create `src/lib/components/PayeeAutocomplete.svelte`:

**Props (using Svelte 5 $props):**
```typescript
type PayeeHistory = {
    payee: string;
    count: number;
    lastAmount: number;
    lastType: 'income' | 'expense';
    lastTags: { id: number; name: string; percentage: number }[];
};

let {
    payees = [],
    value = $bindable(''),
    onSelect,
    placeholder = 'Enter payee name...'
}: {
    payees: PayeeHistory[];
    value?: string;
    onSelect?: (payee: PayeeHistory) => void;
    placeholder?: string;
} = $props();
```

**State:**
- `showDropdown`: boolean for dropdown visibility
- `highlightedIndex`: number for keyboard navigation
- `inputRef`: reference to input element

**Fuzzy search:**
```typescript
import createFuzzySearch from '@nozbe/microfuzz';

const fuzzySearch = $derived(
    createFuzzySearch(payees, { key: 'payee' })
);

let filteredPayees = $derived(
    value.trim()
        ? fuzzySearch(value).map(r => r.item).slice(0, 8)
        : payees.slice(0, 8)
);
```

**Keyboard navigation:**
- ArrowDown: increment highlightedIndex (max = filteredPayees.length - 1)
- ArrowUp: decrement highlightedIndex (min = 0)
- Enter: select highlighted payee
- Escape: close dropdown
- All arrow/enter: call e.preventDefault()

**Selection handler:**
```typescript
function handleSelect(payee: PayeeHistory) {
    value = payee.payee;
    showDropdown = false;
    onSelect?.(payee);
}
```

**Template:**
- Input field with onfocus/onblur to show/hide dropdown (onblur with setTimeout 200ms)
- Absolute positioned dropdown list below input
- Each item shows: payee name (bold), usage count, last amount formatted as currency
- Highlight current item with bg-blue-50
- Use onmousedown (not onclick) for item selection to fire before onblur

**Styling:**
- Match existing input styles (rounded-lg, border-gray-300, focus:border-blue-500)
- Dropdown: white bg, border, rounded-lg, shadow-lg, max-h-60 overflow-auto, z-10
- Items: px-3 py-2, hover:bg-gray-100
  </action>
  <verify>
```bash
npm run check
# Verify no type errors with microfuzz import
```
Component will be tested after integration in Task 3.
  </verify>
  <done>PayeeAutocomplete component created with fuzzy search, keyboard navigation, and selection callback. Microfuzz installed.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance TagSelector with Inline Tag Creation</name>
  <files>
    src/lib/components/TagSelector.svelte
  </files>
  <action>
Enhance the existing TagSelector component to support inline tag creation.

**Add new props:**
```typescript
let {
    availableTags = [],
    allocations = $bindable<TagAllocation[]>([]),
    onCreateTag,  // NEW: Callback for creating new tags
    locked = false,  // NEW: TAGS-03 lock mode
    suggestedTags = []  // NEW: Pre-populate from payee history
}: {
    availableTags: Tag[];
    allocations?: TagAllocation[];
    onCreateTag?: (name: string) => Promise<Tag | null>;
    locked?: boolean;
    suggestedTags?: { id: number; name: string; percentage: number }[];
} = $props();
```

**Add state for inline creation:**
```typescript
let newTagName = $state('');
let isCreating = $state(false);
let createError = $state('');
```

**Add create handler:**
```typescript
async function handleCreateTag() {
    if (!onCreateTag || !newTagName.trim() || locked || isCreating) return;

    createError = '';
    isCreating = true;
    try {
        const newTag = await onCreateTag(newTagName.trim());
        if (newTag) {
            // Add to allocations with remaining percentage
            const remaining = 100 - allocations.reduce((sum, a) => sum + a.percentage, 0);
            allocations = [...allocations, {
                tagId: newTag.id,
                percentage: remaining > 0 ? remaining : 0
            }];
            newTagName = '';
        }
    } catch (err) {
        createError = err instanceof Error ? err.message : 'Failed to create tag';
    } finally {
        isCreating = false;
    }
}
```

**Add effect for suggested tags:**
```typescript
// When suggestedTags changes and allocations is empty, auto-populate
$effect(() => {
    if (suggestedTags.length > 0 && allocations.length === 0) {
        allocations = suggestedTags.map(t => ({
            tagId: t.id,
            percentage: t.percentage
        }));
    }
});
```

**Update template - add creation UI after tag list:**
```svelte
{#if !locked && onCreateTag}
    <div class="flex gap-2 mt-3 pt-3 border-t border-gray-200">
        <input
            type="text"
            bind:value={newTagName}
            placeholder="Create new tag..."
            class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            onkeydown={(e) => e.key === 'Enter' && (e.preventDefault(), handleCreateTag())}
        />
        <button
            type="button"
            onclick={handleCreateTag}
            disabled={isCreating || !newTagName.trim()}
            class="px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
            {isCreating ? '...' : 'Create'}
        </button>
    </div>
    {#if createError}
        <p class="text-sm text-red-600 mt-1">{createError}</p>
    {/if}
{:else if locked}
    <p class="text-xs text-gray-500 mt-2">Tag creation is locked. Manage tags in settings.</p>
{/if}
```

**Keep all existing functionality intact** - tag selection, percentage editing, remove, distribute remaining.
  </action>
  <verify>
```bash
npm run check
# Verify no type errors
```
Component will be fully tested after integration in Task 3.
  </verify>
  <done>TagSelector enhanced with onCreateTag callback, locked mode support, and suggestedTags auto-population. Existing functionality preserved.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Predictive Entry in Transaction Forms</name>
  <files>
    src/routes/w/[workspace]/transactions/new/+page.server.ts
    src/routes/w/[workspace]/transactions/new/+page.svelte
    src/routes/w/[workspace]/transactions/[id]/edit/+page.server.ts
    src/routes/w/[workspace]/transactions/[id]/edit/+page.svelte
  </files>
  <action>
**1. Update +page.server.ts (new transaction):**

Add to load function - query payee history:
```typescript
// Get payee history with aggregated data
const payeeHistoryRaw = db
    .select({
        payee: transactions.payee,
        count: sql<number>`count(*)`,
        lastAmount: sql<number>`(
            SELECT amount_cents FROM transactions t2
            WHERE t2.payee = ${transactions.payee}
            AND t2.voided_at IS NULL AND t2.deleted_at IS NULL
            ORDER BY t2.date DESC, t2.id DESC LIMIT 1
        )`,
        lastType: sql<string>`(
            SELECT type FROM transactions t2
            WHERE t2.payee = ${transactions.payee}
            AND t2.voided_at IS NULL AND t2.deleted_at IS NULL
            ORDER BY t2.date DESC, t2.id DESC LIMIT 1
        )`,
        lastTransactionId: sql<number>`(
            SELECT id FROM transactions t2
            WHERE t2.payee = ${transactions.payee}
            AND t2.voided_at IS NULL AND t2.deleted_at IS NULL
            ORDER BY t2.date DESC, t2.id DESC LIMIT 1
        )`
    })
    .from(transactions)
    .where(and(
        isNull(transactions.voidedAt),
        isNull(transactions.deletedAt)
    ))
    .groupBy(transactions.payee)
    .orderBy(desc(sql`count(*)`))
    .all();

// For each payee, get the tags from their last transaction
const payeeHistory = payeeHistoryRaw.map(p => {
    const lastTags = db
        .select({
            id: tags.id,
            name: tags.name,
            percentage: transactionTags.percentage
        })
        .from(transactionTags)
        .innerJoin(tags, eq(transactionTags.tagId, tags.id))
        .where(eq(transactionTags.transactionId, p.lastTransactionId))
        .all();

    return {
        payee: p.payee,
        count: p.count,
        lastAmount: p.lastAmount,
        lastType: p.lastType as 'income' | 'expense',
        lastTags
    };
});

// Get workspace settings for tagsLocked
const settings = db.select().from(workspaceSettings).get();
```

Return: `{ tags, payeeHistory, tagsLocked: settings?.tagsLocked === 1 }`

Add createTag action:
```typescript
createTag: async ({ locals, request }) => {
    const db = locals.db!;
    const formData = await request.formData();
    const name = (formData.get('name') as string)?.trim();

    if (!name) {
        return fail(400, { error: 'Tag name is required' });
    }

    // Check for duplicate (case-insensitive)
    const existing = db.select().from(tags)
        .where(sql`LOWER(${tags.name}) = LOWER(${name})`)
        .get();

    if (existing) {
        return fail(400, { error: 'Tag already exists', existingTag: existing });
    }

    const result = db.insert(tags)
        .values({ name })
        .returning()
        .get();

    return { success: true, tag: result };
}
```

**2. Update +page.svelte (new transaction):**

Import PayeeAutocomplete:
```typescript
import PayeeAutocomplete from '$lib/components/PayeeAutocomplete.svelte';
```

Add state for suggestions:
```typescript
let suggestedTags = $state<{ id: number; name: string; percentage: number }[]>([]);
let suggestedAmount = $state<number | null>(null);
```

Add payee selection handler:
```typescript
function handlePayeeSelect(payeeData: typeof data.payeeHistory[0]) {
    // Set tag suggestions
    suggestedTags = payeeData.lastTags;

    // Set amount hint (only if same transaction type)
    if (payeeData.lastType === transactionType) {
        suggestedAmount = payeeData.lastAmount;
    } else {
        suggestedAmount = null;
    }
}
```

Add tag creation handler:
```typescript
async function handleCreateTag(name: string) {
    const formData = new FormData();
    formData.set('name', name);

    const response = await fetch('?/createTag', {
        method: 'POST',
        body: formData
    });

    const result = await response.json();

    if (result.type === 'success' && result.data?.tag) {
        // Add to available tags list
        data.tags = [...data.tags, result.data.tag].sort((a, b) =>
            a.name.localeCompare(b.name)
        );
        return result.data.tag;
    }

    if (result.data?.error) {
        throw new Error(result.data.error);
    }

    return null;
}
```

Replace payee input with PayeeAutocomplete:
```svelte
<PayeeAutocomplete
    payees={data.payeeHistory}
    bind:value={payee}
    onSelect={handlePayeeSelect}
    placeholder={transactionType === 'income' ? 'e.g., Client Name' : 'e.g., Office Depot'}
/>
```

Add amount suggestion hint:
```svelte
{#if suggestedAmount !== null}
    <p class="text-xs text-gray-500 mt-1">
        Last amount: ${(suggestedAmount / 100).toFixed(2)}
        <button
            type="button"
            class="text-blue-600 hover:underline ml-1"
            onclick={() => { amountCents = suggestedAmount!; suggestedAmount = null; }}
        >
            Use this
        </button>
    </p>
{/if}
```

Update TagSelector:
```svelte
<TagSelector
    availableTags={data.tags}
    bind:allocations={tagAllocations}
    onCreateTag={data.tagsLocked ? undefined : handleCreateTag}
    locked={data.tagsLocked}
    {suggestedTags}
/>
```

**3. Update edit page similarly:**
- Add payeeHistory to load (same query)
- Add createTag action
- Import and use PayeeAutocomplete
- Add onCreateTag to TagSelector
- For edit, don't auto-populate suggestions (preserve existing data)
  </action>
  <verify>
```bash
npm run dev
```

Test new transaction form:
1. Navigate to /w/[workspace]/transactions/new?type=expense
2. Start typing a payee name that exists in history
3. Verify dropdown appears with fuzzy matches
4. Select a payee - verify tags auto-populate
5. Verify amount hint appears if last transaction was same type
6. Click "Use this" on amount hint - verify amount fills
7. Type a new tag name and click Create - verify tag appears in dropdown
8. Submit transaction - verify it saves correctly

Test edit form:
1. Edit an existing transaction
2. Verify payee autocomplete works
3. Verify tag creation works
4. Verify existing allocations are NOT overwritten by suggestions
  </verify>
  <done>Transaction forms have payee autocomplete with fuzzy search, tag suggestions from payee history, amount hints, and inline tag creation. Edit form also enhanced with same features.</done>
</task>

</tasks>

<verification>
1. New transaction: payee autocomplete shows suggestions with fuzzy matching
2. Selecting payee auto-fills tags from their last transaction
3. Amount hint shows when payee has history (same type)
4. Can create new tag inline during transaction entry
5. Tag creation disabled when workspace has tags locked
6. Edit form has same predictive features
7. No TypeScript errors: `npm run check`
8. Build succeeds: `npm run build`
</verification>

<success_criteria>
- PRED-01: Payee field autocompletes from transaction history with fuzzy/substring matching
- PRED-02: Tag suggestions appear based on selected payee's history
- PRED-03: Amount pre-fills based on payee match (user can override)
- TAGS-01: User can create tags on-the-fly during transaction entry
- Tag creation respects lock mode from TAGS-03
</success_criteria>

<output>
After completion, create `.planning/phases/03-tags-categories/03-02-SUMMARY.md`
</output>
