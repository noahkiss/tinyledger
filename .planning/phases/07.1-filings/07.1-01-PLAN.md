---
phase: 07.1-filings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/db/schema.ts
  - src/lib/data/filing-forms.ts
autonomous: true

must_haves:
  truths:
    - "Filings table exists in database schema with FY/formId/status tracking"
    - "Filing definitions cover sole_prop federal forms (Schedule C, SE, 1040-ES quarters)"
    - "Filing definitions cover sole_prop PA state forms (PA-40, PA-40 ES quarters)"
    - "Filing definitions cover volunteer_org forms (990-N, BCO-10 where applicable)"
    - "Each filing has deadline calculation logic based on fiscal year"
  artifacts:
    - path: "src/lib/server/db/schema.ts"
      provides: "filings table definition"
      contains: "export const filings"
    - path: "src/lib/data/filing-forms.ts"
      provides: "Filing definitions for both workspace types"
      exports: ["FilingDefinition", "SOLE_PROP_FILINGS", "VOLUNTEER_ORG_FILINGS", "getFilingsForWorkspace", "getFilingDeadline"]
  key_links:
    - from: "src/lib/data/filing-forms.ts"
      to: "WorkspaceSettings.type"
      via: "workspace type discrimination"
      pattern: "sole_prop|volunteer_org"
---

<objective>
Create database schema and filing definitions for compliance filing tracking.

Purpose: Establish data foundation for Filings tab that supports both sole_prop (Schedule C, SE, quarterly 1040-ES, PA forms) and volunteer_org (990-N, state registration) workspace types.

Output: Extended schema.ts with filings table, filing-forms.ts with complete filing definitions and deadline calculation utilities.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-filings/07.1-CONTEXT.md
@.planning/phases/07.1-filings/07.1-RESEARCH.md
@src/lib/server/db/schema.ts
@src/lib/data/tax-forms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with filings table</name>
  <files>src/lib/server/db/schema.ts</files>
  <action>
Add `filings` table after `quarterlyPayments` table definition:

```typescript
export const filings = sqliteTable(
  'filings',
  {
    id: integer('id').primaryKey({ autoIncrement: true }),
    fiscalYear: integer('fiscal_year').notNull(),
    formId: text('form_id').notNull(), // References filing definition ID
    filedAt: text('filed_at'), // ISO timestamp when marked complete (null = not filed)
    confirmationNumber: text('confirmation_number'), // Optional confirmation/receipt number
    notes: text('notes'), // User notes
    createdAt: text('created_at').default(sql`CURRENT_TIMESTAMP`).notNull(),
    updatedAt: text('updated_at').default(sql`CURRENT_TIMESTAMP`).notNull()
  },
  (table) => [
    // Unique constraint: one record per fiscal year per form
    index('filings_year_form_idx').on(table.fiscalYear, table.formId)
  ]
);

// Type exports for filings
export type Filing = typeof filings.$inferSelect;
export type NewFiling = typeof filings.$inferInsert;
```

Keep existing type exports and relations unchanged.
  </action>
  <verify>Run `npm run check` - should pass with no type errors</verify>
  <done>filings table exported from schema.ts with Filing and NewFiling types</done>
</task>

<task type="auto">
  <name>Task 2: Create filing definitions data file</name>
  <files>src/lib/data/filing-forms.ts</files>
  <action>
Create new file `src/lib/data/filing-forms.ts` with:

1. **FilingDefinition interface:**
```typescript
export interface FilingDefinition {
  id: string;                     // Unique identifier (e.g., 'schedule-c', '1040-es-q1')
  name: string;                   // Display name (e.g., 'Schedule C')
  fullName: string;               // Full official name
  description: string;            // Brief description
  frequency: 'annual' | 'quarterly';
  quarter?: 1 | 2 | 3 | 4;       // For quarterly filings
  workspaceType: 'sole_prop' | 'volunteer_org' | 'both';
  category: 'federal' | 'state';  // For grouping in UI
  applicableStates?: string[];    // State-specific (empty = all states)
  filingThreshold?: string;       // When filing is required
  instructionsUrl?: string;       // Link to filing instructions
  /** Calculate deadline for given fiscal year */
  getDeadline: (fiscalYear: number) => { date: string; label: string };
}
```

2. **SOLE_PROP_FILINGS array** with these entries:
   - `schedule-c`: Annual, due April 15, federal
   - `schedule-se`: Annual, due April 15, federal
   - `1040-es-q1` through `1040-es-q4`: Quarterly, Apr 15/Jun 15/Sep 15/Jan 15 next year
   - `pa-40`: Annual, due April 15, state, applicableStates: ['PA']
   - `pa-40-es-q1` through `pa-40-es-q4`: Quarterly same dates, state, applicableStates: ['PA']

3. **VOLUNTEER_ORG_FILINGS array** with:
   - `990-n`: Annual, due 15th of 5th month after FY end (for calendar year = May 15), federal
   - `bco-10`: Annual, due within 30 days of anniversary, state, applicableStates: ['PA'], threshold note about >$25k contributions

4. **Utility functions:**
```typescript
/** Get all applicable filings for a workspace */
export function getFilingsForWorkspace(
  type: 'sole_prop' | 'volunteer_org',
  state: string
): FilingDefinition[]

/** Get deadline for a specific filing in a fiscal year */
export function getFilingDeadline(
  filingId: string,
  fiscalYear: number
): { date: string; label: string } | null
```

Deadline calculation notes:
- For 990-N: Calendar year FY ends Dec 31, due May 15 (5th month after)
- For quarterly payments: Q4 is Jan 15 of NEXT year (fiscalYear + 1)
- Use simple date formatting: "Apr 15, 2026" style labels
  </action>
  <verify>
1. Import and call `getFilingsForWorkspace('sole_prop', 'PA')` - should return 10 filings (2 annual federal + 4 quarterly federal + 1 annual state + 4 quarterly state, minus duplicates if any)
2. Import and call `getFilingsForWorkspace('volunteer_org', 'PA')` - should return 2 filings (990-N + BCO-10)
3. `npm run check` passes
  </verify>
  <done>
- FilingDefinition interface exported
- SOLE_PROP_FILINGS contains Schedule C, SE, 4x 1040-ES quarters, PA-40, 4x PA-40 ES quarters
- VOLUNTEER_ORG_FILINGS contains 990-N and BCO-10
- getFilingsForWorkspace correctly filters by workspace type and state
- getFilingDeadline returns correct dates including Q4 Jan 15 next year edge case
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no errors
2. Schema types compile correctly
3. Filing definitions cover all required forms from CONTEXT.md
4. Deadline calculations handle edge cases (Q4 Jan 15, 990-N 5th month)
</verification>

<success_criteria>
- filings table in schema.ts with proper types
- filing-forms.ts with complete definitions for both workspace types
- getFilingsForWorkspace filters correctly by type and state
- Ready for Plan 02 to build UI on this foundation
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-filings/07.1-01-SUMMARY.md`
</output>
