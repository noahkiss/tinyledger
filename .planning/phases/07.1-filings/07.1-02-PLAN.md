---
phase: 07.1-filings
plan: 02
type: execute
wave: 2
depends_on: ["07.1-01"]
files_modified:
  - src/routes/w/[workspace]/filings/+page.server.ts
  - src/routes/w/[workspace]/filings/+page.svelte
  - src/routes/w/[workspace]/taxes/+page.svelte
  - src/routes/w/[workspace]/+layout.svelte
  - src/lib/components/FilingCard.svelte
autonomous: true

must_haves:
  truths:
    - "Filings tab visible in navigation for BOTH sole_prop and volunteer_org workspaces"
    - "Filings sorted by status: past-due (red) at top, then upcoming, then completed"
    - "User can mark filing as complete with date filed, confirmation number, notes"
    - "User can unmark filing (with confirmation dialog)"
    - "Taxes page no longer shows quarterly payments section"
    - "Taxes page links to Filings tab for tracking"
  artifacts:
    - path: "src/routes/w/[workspace]/filings/+page.svelte"
      provides: "Filings tab UI"
      min_lines: 100
    - path: "src/routes/w/[workspace]/filings/+page.server.ts"
      provides: "Load filings, markComplete/unmarkComplete actions"
      exports: ["load", "actions"]
    - path: "src/lib/components/FilingCard.svelte"
      provides: "Individual filing card component"
      min_lines: 50
  key_links:
    - from: "src/routes/w/[workspace]/filings/+page.server.ts"
      to: "filings table"
      via: "drizzle query"
      pattern: "from\\(filings\\)"
    - from: "src/routes/w/[workspace]/+layout.svelte"
      to: "navTabs"
      via: "Filings tab added"
      pattern: "filings.*label.*Filings"
---

<objective>
Build Filings tab UI with card-based layout and migrate quarterly payments tracking from Taxes page.

Purpose: Consolidate compliance filing deadlines and completion tracking into dedicated Filings tab visible to both workspace types. Simplify Taxes page to focus on calculations only.

Output: Working Filings tab with mark-complete workflow, updated Taxes page linking to Filings, navigation updated for both workspace types.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-filings/07.1-CONTEXT.md
@.planning/phases/07.1-filings/07.1-RESEARCH.md
@.planning/phases/07.1-filings/07.1-01-SUMMARY.md
@src/lib/server/db/schema.ts
@src/lib/data/filing-forms.ts
@src/routes/w/[workspace]/taxes/+page.svelte
@src/routes/w/[workspace]/+layout.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FilingCard component</name>
  <files>src/lib/components/FilingCard.svelte</files>
  <action>
Create reusable card component for displaying individual filings. Pattern after existing quarterly payment cards from taxes page.

Props:
```typescript
interface Props {
  filing: {
    id: string;
    name: string;
    fullName: string;
    description: string;
    deadline: string;      // ISO date
    deadlineLabel: string; // "Apr 15, 2026"
    category: 'federal' | 'state';
    instructionsUrl?: string;
    // Status fields from database
    isComplete: boolean;
    filedAt?: string;
    confirmationNumber?: string;
    notes?: string;
    // Computed status
    isPastDue: boolean;
    isUpcoming: boolean;   // Within 30 days
  };
  fiscalYear: number;
  showMarkCompleteForm: boolean;
  onToggleForm: () => void;
}
```

Card layout:
1. Header: filing name + status badge (green "Complete", red "Past Due", yellow "Upcoming", or none)
2. Due date line: "Due: {deadlineLabel}"
3. Category badge: small "Federal" or "State" pill
4. If complete: show filed date, confirmation number (if any), notes (if any)
5. If not complete: "Mark Complete" button that triggers onToggleForm
6. If showMarkCompleteForm: inline form with date filed (defaults today), confirmation number (optional), notes (optional), Submit/Cancel buttons

Status colors (inherit from quarterly payments):
- Complete: border-green-300 bg-green-50
- Past Due: border-red-300 bg-red-50
- Upcoming: border-yellow-300 bg-yellow-50
- Future: border-gray-200 bg-white

Use form with `use:enhance` for progressive enhancement. Form action will be `?/markComplete` with hidden inputs for filingId and fiscalYear.
  </action>
  <verify>Component compiles without type errors in `npm run check`</verify>
  <done>FilingCard.svelte renders filing with status colors, mark complete form, and unmark action</done>
</task>

<task type="auto">
  <name>Task 2: Create Filings page server and UI</name>
  <files>src/routes/w/[workspace]/filings/+page.server.ts, src/routes/w/[workspace]/filings/+page.svelte</files>
  <action>
**+page.server.ts:**

Load function:
1. Get workspace settings (type, state, fiscalYearStartMonth, foundedYear)
2. Get fiscal year from URL param (default to current)
3. Call `getFilingsForWorkspace(settings.type, settings.state)` to get applicable filings
4. For each filing definition, calculate deadline for fiscal year using `filing.getDeadline(fiscalYear)`
5. Query `filings` table for this FY to get completion status
6. Merge definitions with database records
7. Compute status: isPastDue = deadline < today AND not complete, isUpcoming = within 30 days AND not complete
8. Sort: past-due first, then upcoming, then future incomplete, then complete
9. Return: filings array, fiscalYear, availableFiscalYears, workspaceId

Actions:
- `markComplete`: Insert/update filings record with filedAt, confirmationNumber, notes
- `unmarkComplete`: Delete filings record (or set filedAt to null)

**+page.svelte:**

Layout:
1. Header with FY picker (same pattern as taxes page)
2. Info banner: "Track your compliance filings. Past-due filings appear at the top."
3. Grid of FilingCard components (responsive: 1 col mobile, 2 cols tablet, 3 cols desktop)
4. If no filings: empty state message

State management:
- Track which card has form open: `let openFormId = $state<string | null>(null)`
- Toggle function passed to each card

Form actions use `use:enhance` for seamless updates.
  </action>
  <verify>
1. Visit /w/{workspace}/filings - page loads without error
2. Filings appear sorted by status (past-due first)
3. Can mark a filing complete - record saves to database
4. Can unmark a filing - record removes from database
5. `npm run check` passes
  </verify>
  <done>
- Filings page loads applicable filings for workspace type
- Cards display with correct status colors
- Mark complete form works with date/confirmation/notes
- Unmark complete removes record
- FY picker changes view
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Taxes page and layout navigation</name>
  <files>src/routes/w/[workspace]/taxes/+page.svelte, src/routes/w/[workspace]/+layout.svelte</files>
  <action>
**taxes/+page.svelte changes:**

1. REMOVE entire "Quarterly Estimated Payments" section (lines ~230-373)
2. REMOVE "Tax Forms Reference" collapsible section (lines ~376-415)
3. ADD after the "Grand Total" card, a link section:

```svelte
<!-- Filing Tracking Link -->
<div class="mt-6 rounded-lg border border-blue-200 bg-blue-50 p-4">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="font-medium text-blue-900">Track Your Filings</h3>
      <p class="text-sm text-blue-700">View deadlines and mark filings complete in the Filings tab.</p>
    </div>
    <a
      href="/w/{data.workspaceId}/filings?fy={data.fiscalYear}"
      class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
    >
      View Filings
    </a>
  </div>
</div>
```

4. KEEP: Net income summary, tax breakdown cards (SE, Federal, State, Local EIT, Grand Total)
5. KEEP: Disclaimer banner, FY picker, needsConfiguration state handling

**+layout.svelte changes:**

Update navTabs to include Filings for ALL workspace types (not just sole_prop):

```javascript
const baseNavTabs = [
  { href: 'transactions', label: 'Transactions' },
  { href: 'reports', label: 'Reports' },
  { href: 'filings', label: 'Filings' }  // NEW: visible to all
];

// Taxes tab only for sole_prop
const navTabs = $derived(
  data.settings.type === 'sole_prop'
    ? [...baseNavTabs.slice(0, 2), { href: 'taxes', label: 'Taxes' }, baseNavTabs[2]]
    : baseNavTabs
);
```

Order: Transactions | Reports | Taxes (sole_prop only) | Filings
  </action>
  <verify>
1. Taxes page no longer shows quarterly payments section
2. Taxes page shows "View Filings" link that navigates to filings tab
3. Filings tab visible in nav for sole_prop workspaces
4. Filings tab visible in nav for volunteer_org workspaces
5. `npm run check` passes
  </verify>
  <done>
- Taxes page simplified to calculations only + filings link
- Filings tab in navigation for both workspace types
- Tab order correct: Transactions, Reports, [Taxes for sole_prop], Filings
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no errors
2. Sole prop workspace: sees Transactions | Reports | Taxes | Filings tabs
3. Volunteer org workspace: sees Transactions | Reports | Filings tabs
4. Filings tab shows correct forms for each workspace type
5. Past-due filings appear at top with red styling
6. Mark complete workflow captures date, confirmation, notes
7. Unmark complete removes the record
8. Taxes page links to Filings, no longer shows quarterly payments
</verification>

<success_criteria>
- Filings tab functional for both workspace types
- Correct filings shown based on workspace type and state
- Status-based sorting (past-due first)
- Mark/unmark complete workflow with confirmation fields
- Taxes page simplified with link to Filings
- Navigation updated for both workspace types
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-filings/07.1-02-SUMMARY.md`
</output>
