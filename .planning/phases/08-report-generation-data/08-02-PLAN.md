---
phase: 08-report-generation-data
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/server/export/csv-export.ts
  - src/lib/server/export/json-export.ts
  - src/routes/w/[workspace]/export/csv/+server.ts
  - src/routes/w/[workspace]/export/full/+server.ts
  - src/routes/w/[workspace]/settings/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can export all transactions as CSV"
    - "User can export all data as JSON"
    - "User can export all attachments with data as a ZIP file"
    - "CSV includes all transaction fields with human-readable headers"
    - "JSON export includes workspace settings, transactions, tags, and filings"
    - "ZIP contains data.json, transactions.csv, and attachments/ folder"
  artifacts:
    - path: "src/lib/server/export/csv-export.ts"
      provides: "CSV generation for transactions"
      exports: ["generateTransactionsCSV"]
    - path: "src/lib/server/export/json-export.ts"
      provides: "Full JSON export structure"
      exports: ["generateFullExport"]
    - path: "src/routes/w/[workspace]/export/csv/+server.ts"
      provides: "GET endpoint for CSV download"
      exports: ["GET"]
    - path: "src/routes/w/[workspace]/export/full/+server.ts"
      provides: "GET endpoint for ZIP download with all data"
      exports: ["GET"]
  key_links:
    - from: "src/routes/w/[workspace]/export/full/+server.ts"
      to: "archiver"
      via: "streaming ZIP creation"
      pattern: "archiver\\('zip'"
    - from: "src/routes/w/[workspace]/settings/+page.svelte"
      to: "/w/[workspace]/export"
      via: "anchor hrefs for download buttons"
      pattern: "href=.*export/(csv|full)"
---

<objective>
Create data export capabilities: CSV export for transactions, JSON export for all data, and full ZIP export including attachments.

Purpose: Enable data portability and backup, allowing users to export their complete financial records and attachments for archival or migration.

Output: Export section in Settings page with buttons for CSV, JSON, and Full ZIP export.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-report-generation-data/08-CONTEXT.md
@.planning/phases/08-report-generation-data/08-RESEARCH.md

# Relevant existing files
@src/lib/server/db/schema.ts
@src/lib/server/storage/attachment.ts
@src/routes/w/[workspace]/settings/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create export utilities</name>
  <files>package.json, src/lib/server/export/csv-export.ts, src/lib/server/export/json-export.ts</files>
  <action>
Install papaparse and archiver:
```bash
npm install papaparse archiver
npm install --save-dev @types/archiver
```
Note: papaparse includes its own types.

Create `src/lib/server/export/csv-export.ts`:

```typescript
import Papa from 'papaparse';

interface ExportTransaction {
  publicId: string;
  date: string;
  type: 'income' | 'expense';
  payee: string;
  amountCents: number;
  description?: string;
  paymentMethod: string;
  checkNumber?: string;
  tags: string;  // Comma-separated: "Tag1 (50%), Tag2 (50%)"
  hasReceipt: boolean;
  voidedAt?: string;
}

export function generateTransactionsCSV(transactions: ExportTransaction[]): string {
  const data = transactions.map(t => ({
    'ID': t.publicId,
    'Date': t.date,
    'Type': t.type.charAt(0).toUpperCase() + t.type.slice(1),
    'Payee': t.payee,
    'Amount': (t.amountCents / 100).toFixed(2),
    'Description': t.description || '',
    'Payment Method': t.paymentMethod.charAt(0).toUpperCase() + t.paymentMethod.slice(1),
    'Check Number': t.checkNumber || '',
    'Tags': t.tags,
    'Has Receipt': t.hasReceipt ? 'Yes' : 'No',
    'Voided': t.voidedAt ? 'Yes' : 'No'
  }));

  return Papa.unparse(data, {
    quotes: true,
    newline: '\n'
  });
}
```

Create `src/lib/server/export/json-export.ts`:

```typescript
interface WorkspaceExport {
  exportVersion: '1.0';
  exportedAt: string;
  workspace: {
    name: string;
    type: string;
    businessName?: string;
    ein?: string;
    address?: string;
    phone?: string;
    responsibleParty?: string;
    fiscalYearStartMonth: number;
    foundedYear?: number;
  };
  transactions: Array<{
    publicId: string;
    date: string;
    type: 'income' | 'expense';
    amountCents: number;
    payee: string;
    description?: string;
    paymentMethod: string;
    checkNumber?: string;
    tags: Array<{ name: string; percentage: number }>;
    hasAttachment: boolean;
    attachmentFilename?: string;
    voidedAt?: string;
    createdAt: string;
  }>;
  tags: Array<{
    name: string;
    createdAt: string;
  }>;
  filings: Array<{
    fiscalYear: number;
    formId: string;
    filedAt?: string;
    confirmationNumber?: string;
    notes?: string;
  }>;
}

export function generateFullExport(data: {
  workspace: WorkspaceExport['workspace'];
  transactions: WorkspaceExport['transactions'];
  tags: WorkspaceExport['tags'];
  filings: WorkspaceExport['filings'];
}): string {
  const exportData: WorkspaceExport = {
    exportVersion: '1.0',
    exportedAt: new Date().toISOString(),
    ...data
  };

  return JSON.stringify(exportData, null, 2);
}

export type { WorkspaceExport };
```
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles with no errors.
  </verify>
  <done>
papaparse and archiver installed, csv-export.ts exports generateTransactionsCSV, json-export.ts exports generateFullExport and WorkspaceExport type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV and Full ZIP export endpoints</name>
  <files>src/routes/w/[workspace]/export/csv/+server.ts, src/routes/w/[workspace]/export/full/+server.ts</files>
  <action>
Create `src/routes/w/[workspace]/export/csv/+server.ts`:

GET handler:
1. Query all transactions (not deleted) with their tags and attachment presence
2. Format tags as "Tag1 (50%), Tag2 (50%)" string
3. Call generateTransactionsCSV
4. Return Response with Content-Type: text/csv and Content-Disposition attachment

```typescript
const filename = `${params.workspace}-transactions-${new Date().toISOString().split('T')[0]}.csv`;
return new Response(csv, {
  headers: {
    'Content-Type': 'text/csv; charset=utf-8',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
});
```

Create `src/routes/w/[workspace]/export/full/+server.ts`:

GET handler:
1. Query workspace settings, all transactions with tags/attachments, all tags, all filings
2. Generate JSON export string
3. Generate CSV export string
4. Create archiver ZIP with zlib level 6
5. Add data.json to archive
6. Add transactions.csv to archive
7. Add attachments directory if exists: `archive.directory(attachmentsDir, 'attachments')`
8. Finalize and stream response

```typescript
import archiver from 'archiver';
import { Readable } from 'node:stream';
import { existsSync } from 'node:fs';
import { join } from 'node:path';

const DATA_DIR = process.env.DATA_DIR ?? './data';

// Create archive
const archive = archiver('zip', { zlib: { level: 6 } });

// Add JSON
archive.append(jsonData, { name: 'data.json' });

// Add CSV
archive.append(csvData, { name: 'transactions.csv' });

// Add attachments folder if exists
const attachmentsDir = join(DATA_DIR, 'attachments', params.workspace);
if (existsSync(attachmentsDir)) {
  archive.directory(attachmentsDir, 'attachments');
}

archive.finalize();

const stream = Readable.toWeb(archive) as ReadableStream;
const filename = `${params.workspace}-export-${new Date().toISOString().split('T')[0]}.zip`;

return new Response(stream, {
  headers: {
    'Content-Type': 'application/zip',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
});
```
  </action>
  <verify>
1. Run dev server
2. Test CSV endpoint: `curl -I http://localhost:5173/w/{workspace}/export/csv` - should return 200 with text/csv content-type
3. Test ZIP endpoint: `curl -I http://localhost:5173/w/{workspace}/export/full` - should return 200 with application/zip content-type
  </verify>
  <done>
CSV endpoint returns properly formatted CSV file, Full export endpoint returns ZIP with data.json, transactions.csv, and attachments folder.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add export section to Settings page</name>
  <files>src/routes/w/[workspace]/settings/+page.svelte</files>
  <action>
Add "Data Export" section to Settings page after existing sections:

```svelte
<!-- Data Export Section -->
<section class="rounded-xl border border-gray-200 bg-white p-6">
  <h2 class="text-lg font-semibold text-gray-900 mb-4">Data Export</h2>
  <p class="text-sm text-gray-600 mb-4">
    Export your financial data for backup or migration purposes.
  </p>

  <div class="space-y-3">
    <!-- CSV Export -->
    <div class="flex items-center justify-between py-2">
      <div>
        <h3 class="text-sm font-medium text-gray-900">Transactions CSV</h3>
        <p class="text-xs text-gray-500">All transactions in spreadsheet format</p>
      </div>
      <a
        href="/w/{workspaceId}/export/csv"
        class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
        download
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Download CSV
      </a>
    </div>

    <!-- Full Export -->
    <div class="flex items-center justify-between py-2 border-t border-gray-100">
      <div>
        <h3 class="text-sm font-medium text-gray-900">Full Backup (ZIP)</h3>
        <p class="text-xs text-gray-500">All data including receipts and attachments</p>
      </div>
      <a
        href="/w/{workspaceId}/export/full"
        class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
        download
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Download ZIP
      </a>
    </div>
  </div>
</section>
```

Note: Get workspaceId from page data or $page.params.workspace
  </action>
  <verify>
1. Run dev server
2. Navigate to Settings page
3. Scroll to Data Export section
4. Click "Download CSV" - CSV file downloads
5. Click "Download ZIP" - ZIP file downloads
6. Extract ZIP and verify it contains:
   - data.json with export structure
   - transactions.csv with all transactions
   - attachments/ folder with any attachment files
  </verify>
  <done>
Settings page has Data Export section with working download buttons for CSV and Full ZIP export.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. CSV export endpoint returns valid CSV with all transaction fields
3. Full export endpoint returns ZIP containing data.json, transactions.csv, and attachments folder
4. JSON export follows WorkspaceExport schema with version 1.0
5. CSV includes human-readable headers and formatted amounts (dollars, not cents)
6. Settings page shows Data Export section with both download options
7. ZIP file can be extracted and all files are valid
</verification>

<success_criteria>
- CSV export downloads with filename "{workspace}-transactions-{date}.csv"
- CSV contains all transactions with readable headers
- Full ZIP export downloads with filename "{workspace}-export-{date}.zip"
- ZIP contains data.json (full export), transactions.csv, and attachments/ folder
- Settings page has clear Data Export section with both export options
- Export files use UTF-8 encoding
</success_criteria>

<output>
After completion, create `.planning/phases/08-report-generation-data/08-02-SUMMARY.md`
</output>
