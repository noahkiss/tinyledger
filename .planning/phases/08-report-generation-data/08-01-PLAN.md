---
phase: 08-report-generation-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/server/reports/tax-report.ts
  - src/lib/server/reports/pdf-tables.ts
  - src/routes/w/[workspace]/export/tax-report/+server.ts
  - src/routes/w/[workspace]/reports/+page.svelte
  - src/lib/server/db/schema.ts
  - src/lib/server/db/migrate.ts
autonomous: true

must_haves:
  truths:
    - "User can generate tax-ready PDF report for a fiscal year"
    - "PDF groups transactions by tag, then by month within each tag"
    - "Each line item shows date, payee, amount, and receipt indicator"
    - "PDF includes letterhead with logo, business name, EIN, address"
    - "PDF has Page X of Y footer on every page"
    - "Income section appears at top, expenses section below, summary at end"
  artifacts:
    - path: "src/lib/server/reports/tax-report.ts"
      provides: "PDF generation with branded letterhead and tax report tables"
      exports: ["generateTaxReportPDF"]
    - path: "src/lib/server/reports/pdf-tables.ts"
      provides: "Custom table rendering utilities for PDFKit"
      exports: ["drawTable", "drawSectionHeader"]
    - path: "src/routes/w/[workspace]/export/tax-report/+server.ts"
      provides: "GET endpoint streaming PDF download"
      exports: ["GET"]
  key_links:
    - from: "src/routes/w/[workspace]/export/tax-report/+server.ts"
      to: "src/lib/server/reports/tax-report.ts"
      via: "generateTaxReportPDF import"
      pattern: "import.*generateTaxReportPDF"
    - from: "src/routes/w/[workspace]/reports/+page.svelte"
      to: "/w/[workspace]/export/tax-report"
      via: "anchor href for PDF download"
      pattern: "href=.*export/tax-report"
---

<objective>
Create PDF tax report generation with branded letterhead, two-level grouping (tag then month), line item details, receipt indicators, and proper pagination with page numbers.

Purpose: Enable users to generate CPA-ready tax reports for Schedule C preparation, with professional branding and complete transaction details.

Output: Working PDF export accessible from Reports page with "Export PDF" button.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-report-generation-data/08-CONTEXT.md
@.planning/phases/08-report-generation-data/08-RESEARCH.md

# Relevant existing files
@src/lib/server/db/schema.ts
@src/lib/server/storage/attachment.ts
@src/routes/w/[workspace]/reports/+page.svelte
@src/routes/w/[workspace]/reports/+page.server.ts
@src/routes/api/attachment/[workspace]/[transactionId]/+server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add EIN field to schema</name>
  <files>package.json, src/lib/server/db/schema.ts, src/lib/server/db/migrate.ts</files>
  <action>
Install pdfkit and date-fns (pdfkit needs @types/pdfkit as devDependency):
```bash
npm install pdfkit date-fns
npm install --save-dev @types/pdfkit
```

Add `ein` text field to workspace_settings table in schema.ts:
- Add after `taxNotes` field
- Optional field (can be null)
- Format expectation: XX-XXXXXXX (validation is UI concern, not schema)

Update migrate.ts to add ein column:
- Add migration for `ein TEXT` column
- Use ALTER TABLE ADD COLUMN pattern (SQLite doesn't support IF NOT EXISTS for columns, so wrap in try-catch)
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles.
Run dev server and confirm no migration errors on workspace load.
  </verify>
  <done>
pdfkit and date-fns installed, WorkspaceSettings type includes ein field, migration runs without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PDF table utilities and tax report generator</name>
  <files>src/lib/server/reports/pdf-tables.ts, src/lib/server/reports/tax-report.ts</files>
  <action>
Create `src/lib/server/reports/pdf-tables.ts` with custom table rendering:
- `drawTable(doc, columns, rows, startX, startY)` - draws table with header row (gray bg) and data rows
- Each column has: header (string), width (number), align ('left' | 'right')
- Handle page breaks: check if row fits, call doc.addPage() if needed
- Return final Y position after table
- Use Helvetica-Bold for headers, Helvetica for data
- Row height: 18px, font size: 9pt for data, 10pt for headers

Create `src/lib/server/reports/tax-report.ts`:

Interface `TaxReportData`:
```typescript
interface TaxReportTransaction {
  date: string;        // YYYY-MM-DD
  payee: string;
  amountCents: number;
  hasReceipt: boolean;
}

interface TaxReportTag {
  name: string;
  transactions: TaxReportTransaction[];
  totalCents: number;
}

interface TaxReportData {
  workspace: {
    name: string;
    businessName?: string;
    ein?: string;
    address?: string;
    logoBuffer?: Buffer;
  };
  fiscalYear: number;
  fiscalYearStartMonth: number;
  income: TaxReportTag[];
  expenses: TaxReportTag[];
  summary: {
    totalIncome: number;
    totalExpenses: number;
    netIncome: number;
    transactionCount: number;
    receiptCount: number;
    receiptPercentage: number;
  };
}
```

Function `generateTaxReportPDF(data: TaxReportData): PDFKit.PDFDocument`:
1. Create PDFDocument with bufferPages: true, size: 'LETTER', margins: 72 (1 inch)
2. Render letterhead:
   - Logo in top-left (80x80 max) if available
   - Business name (or workspace name) right-aligned, bold 14pt
   - EIN below if available (format as "EIN: XX-XXXXXXX")
   - Address below if available
   - Horizontal line separator
3. Report title: "Tax Report - FY {year}" centered, 16pt bold
4. Date range subtitle: "Period: {startDate} to {endDate}" centered, 10pt gray
5. INCOME SECTION:
   - Section header: "INCOME" green (#22c55e) background, white text
   - For each tag, group transactions by month
   - Tag header: bold, tag name + total
   - Month subheader: italic month name
   - Table columns: Date (70), Payee (200), Amount (80 right), Receipt (50 center)
   - Receipt column shows checkmark or X
6. EXPENSES SECTION:
   - Same structure as income but section header red (#ef4444)
7. SUMMARY at end:
   - Horizontal line
   - "SUMMARY" heading
   - Total Income, Total Expenses, Net Income (bold if positive green, negative red)
   - Transaction count, receipt count, receipt coverage %
8. After all content, add page numbers:
   - Loop through buffered pages
   - Add "Page X of Y" centered at bottom (50px from bottom edge)
9. Return doc (caller calls doc.end())

Helper function `groupByMonth(transactions: TaxReportTransaction[])`:
- Returns Map<string, TaxReportTransaction[]> where key is "January 2026" format
- Sort months chronologically
  </action>
  <verify>
Run `npm run check` to verify TypeScript compiles with no errors.
  </verify>
  <done>
pdf-tables.ts exports drawTable function, tax-report.ts exports generateTaxReportPDF with proper typing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create export endpoint and add button to Reports page</name>
  <files>src/routes/w/[workspace]/export/tax-report/+server.ts, src/routes/w/[workspace]/reports/+page.svelte</files>
  <action>
Create `src/routes/w/[workspace]/export/tax-report/+server.ts`:

GET handler that:
1. Get `fy` query param (default to current fiscal year)
2. Load workspace settings including logo
3. Query transactions for fiscal year:
   - Join with transactionTags and tags
   - Exclude voided and deleted
   - Include attachment presence (LEFT JOIN attachments)
4. Group by type (income/expense), then by tag
5. Calculate totals and receipt stats
6. Call generateTaxReportPDF with assembled data
7. Stream response:
```typescript
import { Readable } from 'node:stream';

doc.end();
const stream = Readable.toWeb(doc) as ReadableStream;

return new Response(stream, {
  headers: {
    'Content-Type': 'application/pdf',
    'Content-Disposition': `attachment; filename="TaxReport-FY${fiscalYear}.pdf"`
  }
});
```

Update `src/routes/w/[workspace]/reports/+page.svelte`:
- Add "Export PDF" button in header next to granularity toggle
- Button links to `/w/{workspaceId}/export/tax-report?fy={fiscalYear}`
- Style: secondary button (gray outline), small icon (document download)
- Opens in new tab (target="_blank") for better UX
  </action>
  <verify>
1. Run dev server
2. Navigate to Reports page
3. Click "Export PDF" button
4. PDF downloads with correct filename
5. Open PDF and verify:
   - Letterhead shows workspace name/business info
   - Income section at top with transactions grouped by tag then month
   - Expenses section below
   - Summary at end with totals
   - Page numbers on each page
  </verify>
  <done>
Export endpoint streams PDF, Reports page has Export PDF button, clicking downloads properly formatted tax report.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. PDF export endpoint responds with Content-Type: application/pdf
3. Downloaded PDF opens correctly in PDF viewer
4. Letterhead displays logo (if set), business name, EIN (if set), address (if set)
5. Transactions grouped correctly: by tag, then by month within tag
6. Receipt indicators show checkmark for transactions with attachments
7. Summary totals match Reports page totals
8. Page numbers appear on all pages as "Page X of Y"
</verification>

<success_criteria>
- User can click "Export PDF" on Reports page
- PDF downloads with filename "TaxReport-FY{year}.pdf"
- PDF contains branded letterhead with workspace logo and business details
- Income section shows all income transactions grouped by tag and month
- Expenses section shows all expense transactions grouped by tag and month
- Each transaction line shows date, payee, amount, and receipt indicator
- Summary section shows total income, expenses, net income, and receipt coverage
- Page numbers appear as "Page X of Y" on every page
</success_criteria>

<output>
After completion, create `.planning/phases/08-report-generation-data/08-01-SUMMARY.md`
</output>
