---
phase: 07-tax-system
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - src/routes/w/[workspace]/taxes/+page.svelte
  - src/routes/w/[workspace]/taxes/+page.server.ts
  - src/lib/components/TaxBreakdownCard.svelte
  - src/routes/w/[workspace]/+layout.svelte
autonomous: true

must_haves:
  truths:
    - "User can view full tax breakdown on dedicated taxes tab"
    - "SE tax, federal, state, and local taxes shown with expandable details"
    - "Quarterly payment schedule displayed with due dates and recommended amounts"
    - "User can mark quarterly payments as paid"
    - "Users without tax config see setup prompt instead of estimates"
  artifacts:
    - path: "src/routes/w/[workspace]/taxes/+page.svelte"
      provides: "Taxes tab page"
      contains: ["TaxBreakdownCard", "quarterly", "disclaimer"]
    - path: "src/routes/w/[workspace]/taxes/+page.server.ts"
      provides: "Tax calculations and quarterly payment data"
      exports: ["load", "actions"]
    - path: "src/lib/components/TaxBreakdownCard.svelte"
      provides: "Expandable tax breakdown component"
      exports: ["default"]
    - path: "src/routes/w/[workspace]/+layout.svelte"
      provides: "Navigation with Taxes tab"
      contains: ["taxes", "Taxes"]
  key_links:
    - from: "taxes/+page.server.ts"
      to: "src/lib/utils/tax-calculations.ts"
      via: "import tax calculation functions"
      pattern: "calculateSelfEmploymentTax|calculateFederalIncomeTax"
    - from: "taxes/+page.svelte"
      to: "TaxBreakdownCard.svelte"
      via: "component import"
      pattern: "TaxBreakdownCard"
    - from: "taxes/+page.server.ts"
      to: "src/lib/server/db/schema.ts"
      via: "query quarterlyPayments"
      pattern: "quarterlyPayments"
---

<objective>
Create dedicated taxes tab with full tax breakdown, calculation transparency, and quarterly payment tracking with mark-as-paid functionality.

Purpose: Central location for tax management - see estimates, understand calculations, track quarterly payments.
Output: New /taxes route with breakdowns and payment tracking.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-tax-system/07-CONTEXT.md
@.planning/phases/07-tax-system/07-RESEARCH.md
@.planning/phases/07-tax-system/07-01-SUMMARY.md
@.planning/phases/07-tax-system/07-02-SUMMARY.md
@src/lib/utils/tax-calculations.ts
@src/lib/server/db/schema.ts
@src/routes/w/[workspace]/+layout.svelte
@src/routes/w/[workspace]/reports/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaxBreakdownCard component</name>
  <files>src/lib/components/TaxBreakdownCard.svelte</files>
  <action>
Create reusable expandable card component for displaying tax breakdowns.

**Props interface:**
```typescript
interface Props {
  title: string;
  totalCents: number;
  items: { label: string; amountCents: number; formula?: string }[];
  expanded?: boolean;
  variant?: 'default' | 'summary'; // summary = larger, no expand
}
```

**Structure:**
- Outer container: rounded-xl border border-gray-200 bg-white overflow-hidden
- Header button (clickable to expand/collapse):
  - Title on left (font-medium text-gray-900)
  - Total amount on right (text-lg font-semibold)
  - Chevron icon that rotates when expanded (transition-transform)
  - Only show chevron for 'default' variant
- Expanded content (shown when isExpanded === true):
  - border-t border-gray-100 bg-gray-50 p-4
  - Definition list (dl) with items
  - Each item: flex justify-between
    - dt: label + optional formula in smaller gray text
    - dd: amount formatted with formatCurrency

**Behavior:**
- Local $state for isExpanded, initialized from `expanded` prop
- Toggle on button click
- Import formatCurrency from $lib/utils/currency

**Summary variant:**
- No chevron, not clickable
- Always shows just title and total
- Use for grand total display
  </action>
  <verify>
    - `npm run check` passes
    - Component renders with title and amount
    - Click expands to show item breakdown
    - Formula text shows in smaller gray
  </verify>
  <done>TaxBreakdownCard component created with expandable breakdown display</done>
</task>

<task type="auto">
  <name>Task 2: Create taxes tab server load and actions</name>
  <files>src/routes/w/[workspace]/taxes/+page.server.ts</files>
  <action>
Create new route at src/routes/w/[workspace]/taxes/+page.server.ts

**Load function:**
1. Get workspace settings from parent or direct query
2. Check taxConfigured flag - if false, return { needsConfiguration: true }
3. Parse fiscal year from URL params (same pattern as reports)
4. Calculate YTD net income (same query pattern as reports)
5. Import and call tax calculation functions:
   - calculateSelfEmploymentTax(netIncomeCents)
   - calculateFederalIncomeTax(netIncome, bracketRate, seDeduction)
   - calculateStateIncomeTax(netIncome, effectiveStateRate)
   - calculateLocalEIT(netIncome, eitRate)
6. Calculate total estimated tax
7. Query quarterly payments from database for fiscal year
8. Call calculateQuarterlyPayments() to get schedule with paid status

**Rate handling:**
- federalBracketRate: stored as 22, divide by 100 for decimal (0.22)
- stateRateOverride: stored as 307, divide by 10000 for decimal (0.0307)
  - If null, use getStateRate(settings.state).rate
- localEitRate: stored as 100, divide by 10000 for decimal (0.01)

**Return data:**
```typescript
{
  needsConfiguration: boolean;
  fiscalYear: number;
  netIncomeCents: number;
  taxes: {
    selfEmployment: { totalCents, taxableCents, socialSecurityCents, medicareCents, deductibleCents };
    federal: { totalCents, rate, adjustedIncomeCents };
    state: { totalCents, rate, stateName };
    local: { totalCents, rate };
    grandTotal: number;
  };
  quarterlyPayments: QuarterlyPayment[];
  formChecklist: TaxForm[]; // from getFormsForState
}
```

**Actions:**

markPaid action:
- Extract: quarter, fiscalYear, federalPaidCents, statePaidCents, notes
- Upsert into quarterlyPayments table (insert or update if exists)
- Set paidAt to current timestamp
- Return { success: true }

unmarkPaid action:
- Extract: quarter, fiscalYear
- Delete record from quarterlyPayments table
- Return { success: true }
  </action>
  <verify>
    - `npm run check` passes
    - Load returns needsConfiguration: true if taxes not configured
    - Load returns full tax breakdown when configured
    - markPaid action creates payment record
  </verify>
  <done>Taxes route server handles tax calculations and quarterly payment CRUD</done>
</task>

<task type="auto">
  <name>Task 3: Create taxes tab page UI</name>
  <files>
    src/routes/w/[workspace]/taxes/+page.svelte
    src/routes/w/[workspace]/+layout.svelte
  </files>
  <action>
**Create src/routes/w/[workspace]/taxes/+page.svelte:**

**Configuration required state:**
If data.needsConfiguration is true:
- Show banner/card prompting to configure taxes
- Link to settings page: "Configure Tax Settings"
- Don't show any estimates
- Use bg-yellow-50 card with icon and clear call-to-action

**Main layout when configured:**
- svelte:head with title "Taxes - TinyLedger"
- Page header with fiscal year picker (same pattern as reports/transactions)
- Disclaimer banner at top: "These estimates are for planning purposes only. Consult a tax professional for actual filing."

**Tax breakdown section:**
- Grid of TaxBreakdownCard components (2-column on desktop, 1-column on mobile)
- Cards for:
  1. Self-Employment Tax - show 92.35% calculation, SS/Medicare breakdown
  2. Federal Income Tax - show adjusted income (after SE deduction), bracket rate
  3. State Income Tax - show state name and rate
  4. Local EIT - show rate (if configured)
- Grand Total card at bottom (full width, variant="summary")

**Calculation transparency:**
- Each card shows formula in expanded state
- Example for SE tax: "$50,000 × 92.35% × 15.3% = $7,067"
- Use actual values from data

**Quarterly payments section:**
- Section title: "Quarterly Estimated Payments"
- Grid of payment cards (4 cards, one per quarter)
- Each card shows:
  - Quarter label (Q1, Q2, Q3, Q4)
  - Due date
  - Recommended amount
  - Status badge: Paid (green), Past Due (red), Upcoming (yellow), or none
  - Mark as Paid button (opens small form)
  - If paid: show paid amount, option to unmark

**Mark as Paid form:**
- Use enhance for progressive enhancement
- Hidden inputs: quarter, fiscalYear
- Optional amount inputs: federalPaidCents, statePaidCents
  - Default to recommended amounts
  - User can adjust
- Optional notes textarea
- Submit button: "Mark Paid"
- Show as expandable form below card or in modal

**Border colors for payment cards:**
- Paid: border-green-300 bg-green-50
- Past due: border-red-300 bg-red-50
- Upcoming (within 30 days): border-yellow-300 bg-yellow-50
- Future: border-gray-200

**Update src/routes/w/[workspace]/+layout.svelte:**
- Add "Taxes" to navTabs array after "Reports"
- Only show Taxes tab for sole_prop workspaces (check data.settings.type)
  </action>
  <verify>
    - `npm run check` passes
    - Taxes tab appears in navigation for sole_prop workspaces
    - Configuration prompt shows when taxes not set up
    - Tax breakdown cards show correct calculations
    - Quarterly payment cards show with correct status colors
    - Mark as paid form submits successfully
  </verify>
  <done>Taxes tab page complete with breakdown cards, quarterly tracking, and mark-paid functionality</done>
</task>

</tasks>

<verification>
1. TaxBreakdownCard component renders and expands correctly
2. Taxes tab appears in navigation for sole_prop workspaces
3. Configuration prompt shows for unconfigured workspaces
4. Tax breakdown shows SE, federal, state, local taxes
5. Quarterly payments show with correct status colors
6. Mark as paid action works and persists
7. Formulas display actual values for transparency
8. Disclaimer visible on page
9. `npm run check` passes
10. Page works on mobile (responsive grid)
</verification>

<success_criteria>
- User can view full tax breakdown with calculation transparency
- User can see quarterly payment schedule with due dates
- User can mark quarterly payments as paid
- Paid payments show in UI with green status
- Configuration prompt redirects to settings if needed
</success_criteria>

<output>
After completion, create `.planning/phases/07-tax-system/07-03-SUMMARY.md`
</output>
