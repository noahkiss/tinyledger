---
phase: 07-tax-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/routes/w/[workspace]/settings/+page.svelte
  - src/routes/w/[workspace]/settings/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can select their state from a dropdown"
    - "User can select their federal tax bracket"
    - "User can enter state rate override and local EIT rate"
    - "Tax forms reference section shows relevant forms for selected state"
    - "Unusual rate values trigger warnings but are still accepted"
  artifacts:
    - path: "src/routes/w/[workspace]/settings/+page.svelte"
      provides: "Tax configuration UI section"
      contains: ["federalBracket", "state", "localEitRate", "Tax Forms"]
    - path: "src/routes/w/[workspace]/settings/+page.server.ts"
      provides: "Tax settings form handling"
      contains: ["federalBracketRate", "stateRateOverride", "taxConfigured"]
  key_links:
    - from: "settings/+page.svelte"
      to: "src/lib/data/federal-brackets-2026.ts"
      via: "import for bracket dropdown"
      pattern: "FEDERAL_BRACKETS_2026"
    - from: "settings/+page.svelte"
      to: "src/lib/data/state-tax-rates.ts"
      via: "import for state dropdown"
      pattern: "STATE_TAX_RATES"
    - from: "settings/+page.server.ts"
      to: "src/lib/server/db/schema.ts"
      via: "update workspaceSettings"
      pattern: "federalBracketRate.*stateRateOverride"
---

<objective>
Add tax configuration section to workspace settings: state selector, federal bracket dropdown, state/local rate inputs, and tax forms reference section.

Purpose: Users must configure tax rates before seeing estimates. This provides the UI for that configuration.
Output: Extended settings page with tax configuration section.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-tax-system/07-CONTEXT.md
@.planning/phases/07-tax-system/07-RESEARCH.md
@.planning/phases/07-tax-system/07-01-SUMMARY.md
@src/routes/w/[workspace]/settings/+page.svelte
@src/routes/w/[workspace]/settings/+page.server.ts
@src/lib/data/federal-brackets-2026.ts
@src/lib/data/state-tax-rates.ts
@src/lib/data/tax-forms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tax configuration UI to settings page</name>
  <files>src/routes/w/[workspace]/settings/+page.svelte</files>
  <action>
Add a new "Tax Configuration" section to the settings page after the Fiscal Year section. The section should only show for sole_prop workspace type.

**Structure:**
1. Section wrapper with title "Tax Configuration" and subtitle explaining purpose
2. Visible only when `data.settings.type === 'sole_prop'`

**State Selection:**
- Dropdown with label "State"
- Import and use STATE_TAX_RATES from $lib/data/state-tax-rates.ts
- Show state name and rate in option: "Pennsylvania (3.07%)"
- Bind to name="state"
- On change, auto-update state rate display

**Federal Bracket:**
- Dropdown with label "Federal Tax Bracket"
- Import and use FEDERAL_BRACKETS_2026 from $lib/data/federal-brackets-2026.ts
- Show bracket label in options (e.g., "22% ($48,476 - $103,350)")
- Bind to name="federalBracketRate" (store the percentage as integer: 22)
- Add expandable help section (use $state toggle) explaining how to pick bracket:
  - "Select the bracket that matches your expected taxable income after deductions and credits."
  - Show bracket table in expandable area

**State Rate Override:**
- Text input for custom state rate (optional)
- Label: "State Rate Override (%)"
- Placeholder shows auto-filled rate from selected state
- Only show if user wants to override
- Use checkbox "Use custom rate" to toggle field visibility
- Bind to name="stateRateOverride"
- Format: user enters "3.07", store as 307 (rate * 10000)
- Add warning if rate > 15%: "This rate seems high. The highest state rate is California at 13.3%."

**Local EIT Rate:**
- Text input with label "Local Earned Income Tax Rate (%)"
- Placeholder: "e.g., 1.0"
- Bind to name="localEitRate"
- Format: user enters "1.0", store as 100 (rate * 10000)
- Add warning if rate > 5%: "Most local EIT rates are under 3%. Please verify this rate."
- Add help text with link: "Find your PA local rate" -> https://apps.dced.pa.gov/munstats-public/ReportInformation2.aspx?report=EitWithCollector_Dyn_Excel&type=R (only show for PA)

**Tax Notes:**
- Textarea with label "Tax Notes"
- Placeholder: "Notes for your reference (e.g., CPA contact info, reminders)"
- Bind to name="taxNotes"

**Styling:**
- Use existing settings page patterns: rounded-lg border bg-white p-6
- Section divider between tax config and other settings
- Expandable sections use simple $state toggle with chevron icon (existing pattern)
- Warning messages: yellow bg-yellow-50 border-yellow-200 text-yellow-800

**Helper functions in script:**
- formatRateForDisplay(rate: number): string - converts 307 to "3.07"
- parseRateFromInput(input: string): number | null - converts "3.07" to 307
- Create reactive state for showing warnings based on input values
  </action>
  <verify>
    - `npm run check` passes
    - Tax configuration section visible on settings page for sole_prop workspaces
    - State dropdown shows states with rates
    - Federal bracket dropdown shows 7 brackets
    - Rate inputs accept decimal format
  </verify>
  <done>Tax configuration UI section added with state, federal bracket, and rate inputs</done>
</task>

<task type="auto">
  <name>Task 2: Add tax forms reference section</name>
  <files>src/routes/w/[workspace]/settings/+page.svelte</files>
  <action>
Add "Tax Forms & Resources" expandable section below the tax configuration inputs, still within the tax config section.

**Structure:**
- Collapsible section (default collapsed) with title "Tax Forms & Resources"
- Use $state toggle for expansion
- Header shows chevron that rotates when expanded

**Content when expanded:**
- Import getFormsForState from $lib/data/tax-forms.ts
- Filter forms based on selected state
- Show forms in a simple list/table format:
  - Form name (linked to irsLink or stateLink)
  - Due date
  - Brief description
  - Filing threshold if applicable
- Group by Federal forms, then State forms (if any)
- Include disclaimer at bottom: "These are common forms. Your situation may require additional forms. Consult a tax professional for advice."

**Styling:**
- Use bg-gray-50 for expanded content area
- Form names as links with underline, text-blue-600
- Table-like layout: grid or flex with consistent spacing
- Smaller text (text-sm) for descriptions
  </action>
  <verify>
    - Expandable section shows/hides on click
    - Forms list updates when state changes
    - Form links open in new tab
    - Disclaimer visible at bottom
  </verify>
  <done>Tax forms reference section shows relevant forms for selected state with links</done>
</task>

<task type="auto">
  <name>Task 3: Handle tax settings in server action</name>
  <files>src/routes/w/[workspace]/settings/+page.server.ts</files>
  <action>
Update the save action to handle new tax configuration fields.

**Extract new fields from formData:**
- state: string (two-letter code)
- federalBracketRate: integer (10, 12, 22, 24, 32, 35, 37)
- stateRateOverride: integer | null (rate * 10000, e.g., 307 for 3.07%)
- localEitRate: integer | null (rate * 10000)
- taxNotes: string | null

**Validation:**
- state: must be 2 characters and exist in STATE_TAX_RATES
- federalBracketRate: must be one of valid rates (10, 12, 22, 24, 32, 35, 37)
- stateRateOverride: if provided, must be positive number; warn (but don't fail) if > 1500 (15%)
- localEitRate: if provided, must be positive number; warn (but don't fail) if > 500 (5%)
- All warnings returned in ActionData but don't prevent save

**Determine taxConfigured:**
- Set taxConfigured = true if:
  - state is set AND
  - federalBracketRate is set
  - (state rate uses default from selected state if no override)

**Update database:**
Add to updateData object:
- state
- federalBracketRate
- stateRateOverride (null if not provided or checkbox unchecked)
- localEitRate (null if not provided)
- taxNotes
- taxConfigured

**Parse rate inputs:**
- User enters "3.07", multiply by 10000 to get 30700 for storage
- Use parseInt after multiplying: Math.round(parseFloat(input) * 10000)
- Handle empty string as null

**Return warnings in ActionData:**
- success: true
- warnings: string[] (e.g., ["State rate seems unusually high"])
  </action>
  <verify>
    - `npm run check` passes
    - Saving settings with tax config works
    - Tax fields persist and reload correctly
    - Unusual rates show warnings but still save
    - taxConfigured flag set correctly
  </verify>
  <done>Tax settings saved to database with validation and warnings for unusual values</done>
</task>

</tasks>

<verification>
1. Tax configuration section appears on settings page for sole_prop workspaces
2. State dropdown populated with correct rates
3. Federal bracket dropdown shows all 2026 brackets
4. Rate inputs accept and format decimal percentages
5. Tax forms section shows relevant forms based on state
6. Form submission saves all tax fields
7. taxConfigured flag set when rates configured
8. Warnings show for unusual rates but save succeeds
9. `npm run check` passes
</verification>

<success_criteria>
- User can configure federal tax bracket from dropdown
- User can select state and see auto-filled rate
- User can override state rate and enter local EIT
- Tax forms reference section shows relevant forms
- Settings persist after save and reload
- taxConfigured flag enables taxes tab (next plan)
</success_criteria>

<output>
After completion, create `.planning/phases/07-tax-system/07-02-SUMMARY.md`
</output>
