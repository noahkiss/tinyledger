---
phase: 07-tax-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/data/federal-brackets-2026.ts
  - src/lib/data/state-tax-rates.ts
  - src/lib/data/tax-forms.ts
  - src/lib/utils/tax-calculations.ts
  - src/lib/server/db/schema.ts
  - src/lib/server/db/migrate.ts
autonomous: true

must_haves:
  truths:
    - "Tax calculation utilities exist and return correct values"
    - "Static tax data for 2026 federal brackets and state rates is bundled"
    - "Database schema supports tax configuration and quarterly payments"
  artifacts:
    - path: "src/lib/data/federal-brackets-2026.ts"
      provides: "Federal tax bracket data for 2026"
      exports: ["FEDERAL_BRACKETS_2026", "FederalBracket"]
    - path: "src/lib/data/state-tax-rates.ts"
      provides: "State income tax rates lookup"
      exports: ["STATE_TAX_RATES", "StateRate", "getStateRate"]
    - path: "src/lib/data/tax-forms.ts"
      provides: "Tax forms reference data"
      exports: ["FEDERAL_FORMS", "PA_FORMS", "TaxForm", "getFormsForState"]
    - path: "src/lib/utils/tax-calculations.ts"
      provides: "Tax calculation functions"
      exports: ["calculateSelfEmploymentTax", "calculateFederalIncomeTax", "calculateStateIncomeTax", "calculateLocalEIT", "calculateQuarterlyPayments", "getQuarterlyDueDates"]
    - path: "src/lib/server/db/schema.ts"
      provides: "Tax config columns on workspaceSettings, quarterlyPayments table"
      contains: ["state:", "federalBracketRate:", "quarterlyPayments"]
  key_links:
    - from: "src/lib/utils/tax-calculations.ts"
      to: "IRS formulas"
      via: "15.3% of 92.35% SE tax formula"
      pattern: "0\\.9235.*0\\.153"
---

<objective>
Create tax data infrastructure: static data files for federal brackets and state rates, tax calculation utilities, and database schema extension for tax configuration and quarterly payments.

Purpose: Foundation for all tax features - configuration, display, and quarterly tracking depend on these utilities and schema.
Output: Static data files, calculation functions, and database migrations.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-tax-system/07-CONTEXT.md
@.planning/phases/07-tax-system/07-RESEARCH.md
@src/lib/server/db/schema.ts
@src/lib/utils/currency.ts
@src/lib/utils/fiscal-year.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create static tax data files</name>
  <files>
    src/lib/data/federal-brackets-2026.ts
    src/lib/data/state-tax-rates.ts
    src/lib/data/tax-forms.ts
  </files>
  <action>
Create three static data files in src/lib/data/:

**federal-brackets-2026.ts:**
- Export `FederalBracket` interface with: rate (decimal), rateLabel (string like "22%"), minIncome (dollars), maxIncome (dollars | null), label (display string)
- Export `FEDERAL_BRACKETS_2026` array with 2026 single filer brackets from Tax Foundation:
  - 10%: $0 - $11,925
  - 12%: $11,926 - $48,475
  - 22%: $48,476 - $103,350
  - 24%: $103,351 - $197,300
  - 32%: $197,301 - $250,525
  - 35%: $250,526 - $626,350
  - 37%: $626,351+

**state-tax-rates.ts:**
- Export `StateRate` interface with: code (2-letter), name, rate (decimal), rateLabel, type ('flat' | 'graduated'), notes (optional)
- Export `STATE_TAX_RATES` array starting with PA (3.07% flat) - add common states with flat rates
- Export `getStateRate(code: string)` function to look up rate by state code
- Include states: PA, IL, MI, IN, CO, UT, NC, MA, KY (all flat rate states for simplicity)

**tax-forms.ts:**
- Export `TaxForm` interface with: id, name, fullName, description, irsLink/stateLink, dueDate, frequency, filingThreshold, applicableStates
- Export `FEDERAL_FORMS` array with Schedule C, Schedule SE, Form 1040-ES
- Export `PA_FORMS` array with PA-40, PA-40 ES
- Export `getFormsForState(stateCode: string)` function that returns federal forms + state forms if available
  </action>
  <verify>
    - `cat src/lib/data/federal-brackets-2026.ts` shows 7 brackets
    - `cat src/lib/data/state-tax-rates.ts` shows PA rate of 0.0307
    - `cat src/lib/data/tax-forms.ts` shows federal and PA forms
    - `npm run check` passes with no type errors
  </verify>
  <done>Static tax data files exist with correct 2026 bracket thresholds and PA 3.07% rate</done>
</task>

<task type="auto">
  <name>Task 2: Create tax calculation utilities</name>
  <files>src/lib/utils/tax-calculations.ts</files>
  <action>
Create src/lib/utils/tax-calculations.ts with pure calculation functions. All amounts in cents to match codebase convention.

**Self-employment tax (calculateSelfEmploymentTax):**
- Input: netIncomeCents (number)
- Returns object: { taxableCents, socialSecurityCents, medicareCents, additionalMedicareCents, totalCents, deductibleCents }
- Formula: 15.3% of 92.35% of net income
  - Social Security: 12.4% up to $176,100 wage base (2026 estimate - use 17610000 cents)
  - Medicare: 2.9% of all income
  - Additional Medicare: 0.9% over $200,000 threshold
  - Deductible: 50% of total SE tax
- Return 0 values if netIncomeCents <= 0

**Federal income tax (calculateFederalIncomeTax):**
- Input: netIncomeCents, bracketRate (decimal), seDeductionCents
- Returns: number (cents)
- Formula: (netIncome - seDeduction) * bracketRate
- Return 0 if result negative

**State income tax (calculateStateIncomeTax):**
- Input: netIncomeCents, stateRate (decimal)
- Returns: number (cents)
- Simple: netIncome * stateRate, return 0 if negative income

**Local EIT (calculateLocalEIT):**
- Input: netIncomeCents, eitRate (decimal)
- Returns: number (cents)
- Same as state: netIncome * eitRate

**Quarterly due dates (getQuarterlyDueDates):**
- Input: year (number)
- Returns array of { quarter, dueDate (ISO), label (formatted) }
- Dates: Apr 15, Jun 15, Sep 15, Jan 15 (next year)

**Quarterly payments (calculateQuarterlyPayments):**
- Input: year, ytdNetIncomeCents, totalEstimatedTaxCents, paidPayments array, today (ISO date string)
- Returns array of QuarterlyPayment objects with: quarter, dueDate, dueDateLabel, recommendedCents, paidCents, isPaid, isPastDue, isUpcoming (within 30 days)
- Uses annualized method: remaining tax / remaining quarters

Add JSDoc comments explaining each formula with IRS references.
  </action>
  <verify>
    - `npm run check` passes
    - Quick test: calculateSelfEmploymentTax(10000000) should return SE tax of ~141000 cents ($1,410.66 = $100,000 * 0.9235 * 0.153)
  </verify>
  <done>Tax calculation functions exist with correct formulas and return integer cents</done>
</task>

<task type="auto">
  <name>Task 3: Extend database schema for tax configuration</name>
  <files>
    src/lib/server/db/schema.ts
    src/lib/server/db/migrate.ts
  </files>
  <action>
**Extend workspaceSettings table in schema.ts:**
Add after fiscalYearStartMonth:
- state: text('state').default('PA') - Two-letter state code
- federalBracketRate: integer('federal_bracket_rate') - Stored as percentage (e.g., 22 for 22%)
- stateRateOverride: integer('state_rate_override') - Stored as rate * 10000 (e.g., 307 for 3.07%), null = use default for state
- localEitRate: integer('local_eit_rate') - Stored as rate * 10000 (e.g., 100 for 1%)
- taxNotes: text('tax_notes') - Free text for user reference
- taxConfigured: integer('tax_configured', { mode: 'boolean' }).default(false).notNull() - Has user configured taxes?

**Add new quarterlyPayments table:**
- id: integer primary key auto increment
- fiscalYear: integer not null
- quarter: integer not null (1-4)
- federalPaidCents: integer (null = unpaid)
- statePaidCents: integer (null = unpaid)
- paidAt: text (ISO timestamp when marked paid)
- notes: text (optional user notes)
- createdAt/updatedAt: text with CURRENT_TIMESTAMP default
- Add unique constraint on (fiscalYear, quarter) - one payment record per quarter

**Export types:**
- QuarterlyPayment = typeof quarterlyPayments.$inferSelect
- NewQuarterlyPayment = typeof quarterlyPayments.$inferInsert

**Update migrate.ts:**
Add migration that:
1. Adds new columns to workspace_settings (ALTER TABLE ADD COLUMN with defaults)
2. Creates quarterly_payments table
Use the same pattern as existing migrations - check if column/table exists before adding.
  </action>
  <verify>
    - `npm run check` passes
    - `npm run dev` starts without errors (migration runs on first request)
    - Schema exports QuarterlyPayment type
  </verify>
  <done>Schema extended with tax config columns and quarterlyPayments table, migration runs successfully</done>
</task>

</tasks>

<verification>
1. All three static data files exist with correct exports
2. Tax calculation utilities return correct values (SE tax ~15.3% of 92.35% of net)
3. Schema compiles with new tax fields
4. Migration creates quarterlyPayments table
5. `npm run check` passes
6. `npm run dev` starts without errors
</verification>

<success_criteria>
- Static tax data bundled for 2026 federal brackets and state rates
- Tax calculation utilities handle SE tax, federal, state, local with integer cents
- Quarterly payment schedule calculation works correctly
- Database schema supports tax configuration storage
- All TypeScript types exported and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/07-tax-system/07-01-SUMMARY.md`
</output>
