---
phase: 07-tax-system
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - src/routes/w/[workspace]/transactions/+page.svelte
  - src/routes/w/[workspace]/transactions/+page.server.ts
  - src/lib/components/QuarterlyPaymentMarker.svelte
  - src/routes/w/[workspace]/reports/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Quarterly payment due dates appear in transaction timeline"
    - "Timeline markers have distinct visual style from transactions"
    - "Paid payments show as completed in timeline"
    - "Reports dashboard uses configured tax rate for set-aside calculation"
  artifacts:
    - path: "src/lib/components/QuarterlyPaymentMarker.svelte"
      provides: "Timeline marker for quarterly payments"
      exports: ["default"]
    - path: "src/routes/w/[workspace]/transactions/+page.svelte"
      provides: "Timeline with quarterly markers"
      contains: ["QuarterlyPaymentMarker", "quarterlyPayments"]
    - path: "src/routes/w/[workspace]/transactions/+page.server.ts"
      provides: "Quarterly payment data for timeline"
      contains: ["quarterlyPayments"]
  key_links:
    - from: "transactions/+page.svelte"
      to: "QuarterlyPaymentMarker.svelte"
      via: "component import"
      pattern: "QuarterlyPaymentMarker"
    - from: "reports/+page.server.ts"
      to: "src/lib/server/db/schema.ts"
      via: "query workspaceSettings for tax config"
      pattern: "federalBracketRate|stateRate"
---

<objective>
Integrate quarterly payment markers into transaction timeline and update reports dashboard to use configured tax rates instead of hardcoded 25%.

Purpose: Surface quarterly payment due dates where users spend most time (timeline) and make tax set-aside accurate.
Output: Timeline markers and updated reports calculation.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-tax-system/07-CONTEXT.md
@.planning/phases/07-tax-system/07-03-SUMMARY.md
@src/routes/w/[workspace]/transactions/+page.svelte
@src/routes/w/[workspace]/transactions/+page.server.ts
@src/routes/w/[workspace]/reports/+page.server.ts
@src/lib/utils/reports.ts
@src/lib/components/TimelineDateMarker.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuarterlyPaymentMarker component</name>
  <files>src/lib/components/QuarterlyPaymentMarker.svelte</files>
  <action>
Create component for displaying quarterly payment markers in the timeline.

**Props interface:**
```typescript
interface Props {
  quarter: 1 | 2 | 3 | 4;
  dueDate: string; // ISO date
  dueDateLabel: string; // "Apr 15, 2026"
  federalRecommendedCents: number;
  stateRecommendedCents: number;
  isPaid: boolean;
  paidFederalCents?: number;
  paidStateCents?: number;
  isPastDue: boolean;
  isUpcoming: boolean; // within 30 days
  workspaceId: string;
}
```

**Visual design (distinct from transactions):**
- Dashed border (border-dashed border-2) instead of solid
- Muted background (bg-gray-50 normally)
- Calendar icon on left instead of payment method icon
- Smaller text overall (text-sm)
- System label: "Quarterly Estimated Tax" not a payee name

**Border colors by status:**
- isPaid: border-green-400 bg-green-50
- isPastDue: border-red-400 bg-red-50
- isUpcoming: border-yellow-400 bg-yellow-50
- default: border-gray-300 bg-gray-50

**Content layout:**
- Top row: "Q{quarter} Estimated Tax" + status badge (Paid/Past Due/Upcoming)
- Second row: due date label in small gray text
- Third row: amounts
  - If paid: "Federal: $X | State: $Y | Total: $Z" with checkmark
  - If unpaid: "Recommended: Federal $X + State $Y = $Z"
- Link to taxes page: "View Details" or "Mark Paid" (small, text-blue-600)

**Click behavior:**
- Entire card links to /w/{workspaceId}/taxes (or opens mark-paid flow)
- Use anchor tag wrapping content
  </action>
  <verify>
    - `npm run check` passes
    - Component renders with calendar icon and dashed border
    - Status badges show correctly
    - Link navigates to taxes page
  </verify>
  <done>QuarterlyPaymentMarker component created with distinct visual style</done>
</task>

<task type="auto">
  <name>Task 2: Integrate quarterly markers into timeline</name>
  <files>
    src/routes/w/[workspace]/transactions/+page.server.ts
    src/routes/w/[workspace]/transactions/+page.svelte
  </files>
  <action>
**Update transactions/+page.server.ts:**

Add quarterly payment data to load function:
1. Import getQuarterlyDueDates and calculateQuarterlyPayments from tax-calculations
2. Import quarterlyPayments schema and getStateRate
3. Query workspace settings for tax config
4. Only include quarterly markers if:
   - settings.type === 'sole_prop' AND
   - settings.taxConfigured === true
5. Get quarterly due dates for fiscal year
6. Query paid payments from quarterlyPayments table
7. Calculate recommended amounts using current YTD totals and tax rates
8. Return quarterlyPayments array in load data (or empty array if not applicable)

Return structure for each payment:
```typescript
{
  quarter: 1 | 2 | 3 | 4;
  dueDate: string;
  dueDateLabel: string;
  federalRecommendedCents: number;
  stateRecommendedCents: number;
  isPaid: boolean;
  paidFederalCents: number | null;
  paidStateCents: number | null;
  isPastDue: boolean;
  isUpcoming: boolean;
}
```

**Update transactions/+page.svelte:**

1. Import QuarterlyPaymentMarker component
2. Create combined timeline items:
   - Merge transactions and quarterly payments by date
   - Quarterly payments appear at their due date position
   - Sort all items by date descending

3. Update groupedTransactions logic:
   - Instead of just grouping transactions, create unified timeline
   - Each date can have transactions AND/OR a quarterly marker
   - Use a discriminated union or separate arrays per date

4. In the timeline rendering:
   - For each date group, render transactions normally
   - If a quarterly payment falls on this date, render QuarterlyPaymentMarker
   - Quarterly markers should appear BEFORE transactions on the same date (more prominent)

5. Handle quarterly markers that don't match any transaction date:
   - Create date entry just for the quarterly marker
   - Use same date marker styling but different icon/color

**Date handling:**
- Quarterly due dates are specific dates (Apr 15, Jun 15, Sep 15, Jan 15)
- Insert into timeline at correct chronological position
- If due date is in the future relative to current fiscal year view, still show it
  </action>
  <verify>
    - `npm run check` passes
    - Quarterly markers appear in timeline at correct dates
    - Markers have distinct visual style (dashed border, calendar icon)
    - Paid markers show green, unpaid show gray
    - Past due markers show red
    - Markers link to taxes page
  </verify>
  <done>Quarterly payment markers integrated into transaction timeline</done>
</task>

<task type="auto">
  <name>Task 3: Update reports to use configured tax rate</name>
  <files>
    src/routes/w/[workspace]/reports/+page.server.ts
    src/lib/utils/reports.ts
  </files>
  <action>
**Update reports/+page.server.ts:**

1. Import tax calculation functions from tax-calculations.ts
2. Import getStateRate from state-tax-rates.ts
3. In load function, get tax configuration from settings:
   - federalBracketRate, stateRateOverride, localEitRate, taxConfigured
4. Calculate actual estimated tax rate if taxes are configured:
   - Calculate total estimated tax using tax calculation functions
   - Divide by net income to get effective rate
   - Use this rate for tax set-aside display
5. If taxes not configured, fall back to TAX_SET_ASIDE_RATE (25%)

**Update tax set-aside calculation:**
Current code uses hardcoded TAX_SET_ASIDE_RATE (0.25).
Change to:
- If taxConfigured: calculate actual tax estimate and show real number
- If not configured: show estimate based on 25% with note "(estimated - configure taxes for accuracy)"

**Return additional data:**
- taxSetAsideCents: calculated from actual rates or estimate
- taxConfigured: boolean
- taxRateUsed: the effective rate used (for display)

**Update reports.ts:**
- Keep TAX_SET_ASIDE_RATE as default/fallback
- Add helper function to calculate effective tax rate from config:
```typescript
export function calculateEffectiveTaxRate(
  netIncomeCents: number,
  federalRate: number,
  stateRate: number,
  localRate: number
): number {
  // Returns approximate effective rate including SE tax
}
```

**UI consideration:**
- Reports page may need to show "(estimated)" if taxes not configured
- This is handled by passing taxConfigured to the page
- Page can show small note under tax set-aside card
  </action>
  <verify>
    - `npm run check` passes
    - Reports page shows tax set-aside based on configured rates
    - Unconfigured workspaces still show 25% estimate
    - Tax set-aside updates when rates change
  </verify>
  <done>Reports dashboard uses configured tax rates for accurate set-aside calculation</done>
</task>

</tasks>

<verification>
1. QuarterlyPaymentMarker component renders with distinct style
2. Timeline shows quarterly markers at correct due dates
3. Paid payments show green checkmark in timeline
4. Past due payments show red warning
5. Upcoming payments show yellow highlight
6. Clicking marker navigates to taxes page
7. Reports tax set-aside uses configured rates
8. Fallback to 25% when taxes not configured
9. `npm run check` passes
10. Mobile responsive (markers readable on small screens)
</verification>

<success_criteria>
- Quarterly payment due dates visible in transaction timeline
- Timeline markers clearly distinguished from regular transactions
- Paid/unpaid/past due status visible at a glance
- Reports dashboard shows accurate tax set-aside based on user's rates
- Users prompted to configure taxes for accurate calculations
</success_criteria>

<output>
After completion, create `.planning/phases/07-tax-system/07-04-SUMMARY.md`
</output>
