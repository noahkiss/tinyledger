---
phase: 02-core-transactions
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/routes/w/[workspace]/transactions/+page.svelte
  - src/routes/w/[workspace]/transactions/+page.server.ts
  - src/routes/w/[workspace]/transactions/new/+page.svelte
  - src/routes/w/[workspace]/transactions/new/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can create income transaction with all required fields"
    - "User can create expense transaction with all required fields"
    - "Tags with percentages can be assigned and must sum to 100%"
    - "Created transactions appear in basic list view"
    - "Transaction history records 'created' action"
  artifacts:
    - path: "src/routes/w/[workspace]/transactions/new/+page.svelte"
      provides: "Transaction creation form UI"
      min_lines: 100
    - path: "src/routes/w/[workspace]/transactions/new/+page.server.ts"
      provides: "Create transaction server action"
      exports: ["actions"]
    - path: "src/routes/w/[workspace]/transactions/+page.svelte"
      provides: "Transaction list view"
      min_lines: 50
    - path: "src/routes/w/[workspace]/transactions/+page.server.ts"
      provides: "Load transactions for list"
      exports: ["load"]
  key_links:
    - from: "new/+page.server.ts"
      to: "transactions table"
      via: "db.insert"
      pattern: "db\\.insert\\(transactions\\)"
    - from: "new/+page.server.ts"
      to: "transactionHistory table"
      via: "db.insert for audit"
      pattern: "insert\\(transactionHistory\\)"
    - from: "+page.server.ts (list)"
      to: "transactions table"
      via: "db.select"
      pattern: "db\\.select\\(\\)\\.from\\(transactions\\)"
---

<objective>
Create the transaction entry form and basic list view for creating income/expense transactions.

Purpose: Enable users to create transactions with full field support (amount, date, payee, tags, description, payment method). This is the core of the 10-second entry workflow.

Output: Transaction creation form with server action, basic list view for testing.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-transactions/02-RESEARCH.md
@.planning/phases/02-core-transactions/02-01-SUMMARY.md
@.planning/phases/02-core-transactions/02-02-SUMMARY.md
@src/lib/server/db/schema.ts
@src/lib/components/CurrencyInput.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transaction list page</name>
  <files>
    src/routes/w/[workspace]/transactions/+page.svelte
    src/routes/w/[workspace]/transactions/+page.server.ts
  </files>
  <action>
**+page.server.ts:**
Create a load function that:
- Gets db from locals (already injected by hooks.server.ts)
- Queries transactions table with:
  - WHERE deletedAt IS NULL (exclude soft-deleted)
  - ORDER BY date DESC, createdAt DESC
  - LIMIT 50 (basic pagination, full timeline is Phase 5)
- Queries tags table for available tags (used by create form)
- Returns { transactions, tags }

Include the tag allocations for each transaction using Drizzle's with() or a separate query.

**+page.svelte:**
Create a basic list view that:
- Shows "Transactions" heading
- Has large "Income" and "Expense" buttons linking to /transactions/new?type=income|expense
- Lists transactions in a simple table/list format showing:
  - Date
  - Type (Income/Expense badge, green/red)
  - Payee
  - Amount (formatted with formatCurrency)
  - Voided indicator if voidedAt is set (strikethrough or badge)
- Each row links to /transactions/{publicId} for viewing/editing
- Shows "No transactions yet" empty state

Use Tailwind for styling. Income = green badge, Expense = red badge.
Import formatCurrency from '$lib/utils/currency'.
  </action>
  <verify>
Run `npm run dev` and navigate to /w/test/transactions - page loads without error.
Income/Expense buttons link to correct URLs.
  </verify>
  <done>
Transaction list page loads, shows empty state or transactions, has create buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transaction form UI</name>
  <files>src/routes/w/[workspace]/transactions/new/+page.svelte</files>
  <action>
Create the transaction creation form using the input components from Plan 02.

Page structure:
- Read type from URL query param (?type=income|expense), default to expense
- Show heading "New {Type} Transaction"
- Back link to /transactions

Form fields (in order):
1. Amount - CurrencyInput component
2. Date - DateInput component (default to today)
3. Payee - Text input with label
4. Description - Textarea (optional)
5. Payment Method - PaymentMethodSelect component
6. Tags - TagSelector component (optional, only validate if any added)

Form layout:
- Mobile-first single column
- Large touch-friendly inputs
- Submit button at bottom: "Create {Type}" (green for income, red for expense)

Use SvelteKit form with use:enhance for progressive enhancement.
Handle form.error from server to display validation errors at top.

Get available tags from parent page load (pass via +page.server.ts).
Default date to today's date in YYYY-MM-DD format.
  </action>
  <verify>
Run `npm run dev` and navigate to /w/test/transactions/new?type=income
Form renders with all fields, no console errors.
  </verify>
  <done>
Transaction creation form displays all fields with proper components and styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create transaction server action</name>
  <files>src/routes/w/[workspace]/transactions/new/+page.server.ts</files>
  <action>
Create the server-side logic for transaction creation.

**load function:**
- Query tags table for available tags
- Return { tags }

**actions.default:**
Parse form data:
- type: 'income' | 'expense' (from hidden field or query)
- amount_cents: integer (from hidden input in CurrencyInput)
- date: string (YYYY-MM-DD)
- payee: string
- description: string (optional)
- paymentMethod: 'cash' | 'card' | 'check'
- checkNumber: string (optional, only for check)
- tag_N and percentage_N: parse into array of {tagId, percentage}

Validation (return fail(400, {error}) on failure):
- type must be 'income' or 'expense'
- amount_cents must be > 0
- date must be valid YYYY-MM-DD format
- payee must not be empty after trim
- If any tags selected, percentages must sum to exactly 100

Create transaction:
1. Generate publicId using crypto.randomUUID()
2. Insert into transactions table
3. For each tag allocation, insert into transactionTags table
4. Insert history record with action='created'

On success: redirect(303, `/w/${params.workspace}/transactions/${publicId}`)

Import: transactions, transactionTags, transactionHistory, tags from schema.
Use fail() and redirect() from '@sveltejs/kit'.
  </action>
  <verify>
Run `npm run dev`, create a transaction, verify it appears in the list.
Check database has transaction + history record with action='created'.
  </verify>
  <done>
Transactions can be created with all fields, stored in database with history, redirect to detail page.
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run dev` starts without errors
- [ ] /w/test/transactions shows list page with Income/Expense buttons
- [ ] /w/test/transactions/new?type=income shows form with all fields
- [ ] Creating a transaction redirects to detail page (404 expected until Plan 04)
- [ ] Transaction appears in list with correct formatting
- [ ] Database has transaction record with amountCents as integer
- [ ] Database has transactionHistory record with action='created'
</verification>

<success_criteria>
1. Transaction list shows all non-deleted transactions sorted by date
2. Large Income/Expense buttons work and pass type to form
3. Form uses all four input components correctly
4. Server validation catches missing/invalid fields
5. Tag percentages validated to sum to 100% on server
6. History record created automatically on insert
7. Public UUID used in URLs (not internal ID)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-transactions/02-03-SUMMARY.md`
</output>
