---
phase: 02-core-transactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/db/schema.ts
  - src/lib/utils/currency.ts
autonomous: true

must_haves:
  truths:
    - "Transaction schema supports income/expense types with amount in cents"
    - "Tags table exists for category management"
    - "Junction table supports percentage allocation per tag"
    - "History table captures all transaction state changes"
  artifacts:
    - path: "src/lib/server/db/schema.ts"
      provides: "transactions, tags, transactionTags, transactionHistory tables"
      contains: "export const transactions"
    - path: "src/lib/utils/currency.ts"
      provides: "dollarsToCents, centsToDollars, formatCurrency utilities"
      exports: ["dollarsToCents", "centsToDollars", "formatCurrency"]
  key_links:
    - from: "transactions table"
      to: "transactionTags junction"
      via: "transactionId foreign key"
      pattern: "references.*transactions.id"
    - from: "transactionTags"
      to: "tags"
      via: "tagId foreign key"
      pattern: "references.*tags.id"
---

<objective>
Extend the database schema with transaction, tag, and history tables for Phase 2 CRUD operations.

Purpose: Establish the data layer foundation for all transaction operations, ensuring currency is stored as integer cents, tags support percentage allocation, and all changes are tracked in a history table.

Output: Extended schema.ts with 4 new tables and currency utility functions.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-transactions/02-RESEARCH.md
@src/lib/server/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with transaction and tag tables</name>
  <files>src/lib/server/db/schema.ts</files>
  <action>
Add the following tables to the existing schema.ts file, keeping the existing workspaceSettings table:

1. **transactions** table:
   - id: integer primary key autoIncrement
   - publicId: text notNull unique (UUID for URLs, generated via crypto.randomUUID)
   - type: text enum ['income', 'expense'] notNull
   - amountCents: integer notNull (store currency as cents to avoid float errors)
   - date: text notNull (ISO date string YYYY-MM-DD, not timestamp)
   - payee: text notNull
   - description: text (nullable)
   - paymentMethod: text enum ['cash', 'card', 'check'] notNull
   - checkNumber: text (nullable, only when paymentMethod is 'check')
   - voidedAt: text (nullable, timestamp when voided)
   - deletedAt: text (nullable, soft delete timestamp)
   - createdAt: text default CURRENT_TIMESTAMP notNull
   - updatedAt: text default CURRENT_TIMESTAMP notNull
   - Add indexes: date_idx, payee_idx, type_idx

2. **tags** table:
   - id: integer primary key autoIncrement
   - name: text notNull unique
   - createdAt: text default CURRENT_TIMESTAMP notNull

3. **transactionTags** junction table:
   - id: integer primary key autoIncrement
   - transactionId: integer notNull, references transactions.id with onDelete cascade
   - tagId: integer notNull, references tags.id with onDelete restrict
   - percentage: integer notNull (1-100, must sum to 100 per transaction)
   - Add indexes: transaction_idx, tag_idx

4. **transactionHistory** table:
   - id: integer primary key autoIncrement
   - transactionId: integer notNull, references transactions.id with onDelete cascade
   - action: text enum ['created', 'updated', 'voided', 'unvoided', 'deleted'] notNull
   - previousState: text mode json (nullable, snapshot before change)
   - changedFields: text mode json (nullable, list of changed field names)
   - timestamp: text default CURRENT_TIMESTAMP notNull

Add Drizzle relations for transactions <-> transactionTags <-> tags.

Export type aliases: Transaction, NewTransaction, Tag, NewTag, TransactionTag, NewTransactionTag, TransactionHistory, NewTransactionHistory.

Use `import { relations } from 'drizzle-orm'` for relation definitions.
Use `import { index } from 'drizzle-orm/sqlite-core'` for indexes.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Check that all table exports are available: `grep -E "export (const|type)" src/lib/server/db/schema.ts`
  </verify>
  <done>
schema.ts contains transactions, tags, transactionTags, transactionHistory tables with proper foreign keys, indexes, and type exports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create currency utility functions</name>
  <files>src/lib/utils/currency.ts</files>
  <action>
Create a new utility file at src/lib/utils/currency.ts with the following functions:

```typescript
/**
 * Convert dollar amount to cents (integer)
 * Handles floating-point precision by rounding
 */
export function dollarsToCents(dollars: number): number {
  return Math.round(dollars * 100);
}

/**
 * Convert cents (integer) to dollar amount
 */
export function centsToDollars(cents: number): number {
  return cents / 100;
}

/**
 * Format cents as currency string for display
 * Uses Intl.NumberFormat for proper locale handling
 */
export function formatCurrency(cents: number): string {
  const dollars = centsToDollars(cents);
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(dollars);
}

/**
 * Parse a currency string input to cents
 * Handles inputs like "1.50", "$1.50", "1", "1.5"
 */
export function parseCurrencyToCents(input: string): number {
  // Remove all non-numeric except decimal point
  const cleaned = input.replace(/[^\d.]/g, '');
  const dollars = parseFloat(cleaned) || 0;
  return dollarsToCents(dollars);
}
```

Create the utils directory if it doesn't exist: `src/lib/utils/`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Verify file exists: `test -f src/lib/utils/currency.ts && echo "exists"`
  </verify>
  <done>
Currency utility functions exist and are type-safe, ready for use in input components and server actions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify schema with migration test</name>
  <files>scripts/test-transactions.ts</files>
  <action>
Create a test script at scripts/test-transactions.ts that:

1. Creates a test workspace database (or uses existing test workspace)
2. Verifies all new tables are created via migrate.ts
3. Tests CRUD operations:
   - Create a tag
   - Create an income transaction with cents amount
   - Create a transactionTag linking them with 100% allocation
   - Create a history entry for the 'created' action
   - Query transactions with tag relations
   - Verify voidedAt and deletedAt default to null
4. Cleans up test data

The script should:
- Import from the existing db/index.ts and migrate.ts
- Use the existing getWorkspaceDb pattern
- Console.log success/failure for each operation
- Exit with code 0 on success, 1 on failure

Add a test script to package.json: "test:transactions": "tsx scripts/test-transactions.ts"
  </action>
  <verify>
Run `npm run test:transactions` - should complete with exit code 0.
All console.log statements should show success.
  </verify>
  <done>
Schema migration works, all tables exist with proper foreign key relationships, and CRUD operations succeed.
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes (TypeScript compiles)
- [ ] `npm run test:transactions` passes (schema migrates and CRUD works)
- [ ] schema.ts exports all 4 new tables and their types
- [ ] Currency utils handle edge cases (0, negative, decimals)
</verification>

<success_criteria>
1. transactions table stores amount as integer cents, not float
2. tags table has unique name constraint
3. transactionTags junction table has foreign keys with correct cascade behavior
4. transactionHistory table tracks all action types with JSON state snapshots
5. All tables are created on workspace database initialization
6. Currency utility functions correctly convert between cents and dollars
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-transactions/02-01-SUMMARY.md`
</output>
