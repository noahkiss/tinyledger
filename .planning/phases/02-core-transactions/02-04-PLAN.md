---
phase: 02-core-transactions
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/routes/w/[workspace]/transactions/[id]/+page.svelte
  - src/routes/w/[workspace]/transactions/[id]/+page.server.ts
  - src/routes/w/[workspace]/transactions/[id]/history/+page.svelte
  - src/routes/w/[workspace]/transactions/[id]/history/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can view transaction details with all fields displayed"
    - "User can edit transaction and changes are saved"
    - "Edit history is tracked with changed fields recorded"
    - "User can void transaction (keeps record, shows as voided)"
    - "User can delete only voided transactions (soft delete)"
    - "User can view full edit history for a transaction"
  artifacts:
    - path: "src/routes/w/[workspace]/transactions/[id]/+page.svelte"
      provides: "Transaction view/edit form"
      min_lines: 150
    - path: "src/routes/w/[workspace]/transactions/[id]/+page.server.ts"
      provides: "Load transaction, edit/void/delete actions"
      exports: ["load", "actions"]
    - path: "src/routes/w/[workspace]/transactions/[id]/history/+page.svelte"
      provides: "Transaction history view"
      min_lines: 40
  key_links:
    - from: "+page.server.ts (edit)"
      to: "transactionHistory"
      via: "previousState snapshot"
      pattern: "previousState.*JSON\\.stringify"
    - from: "void action"
      to: "voidedAt column"
      via: "set voidedAt timestamp"
      pattern: "voidedAt.*new Date"
    - from: "delete action"
      to: "soft delete check"
      via: "require voidedAt first"
      pattern: "if.*!.*voidedAt"
---

<objective>
Create the transaction view/edit page with void-first deletion model and full edit history tracking.

Purpose: Complete the CRUD cycle for transactions. Users can view details, edit fields (with history tracked), void transactions to exclude from totals, and delete only voided items. This implements the audit trail requirement.

Output: Transaction detail page with edit form, void/unvoid/delete actions, and history view.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-transactions/02-RESEARCH.md
@.planning/phases/02-core-transactions/02-01-SUMMARY.md
@.planning/phases/02-core-transactions/02-02-SUMMARY.md
@src/lib/server/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transaction view/edit page</name>
  <files>
    src/routes/w/[workspace]/transactions/[id]/+page.svelte
    src/routes/w/[workspace]/transactions/[id]/+page.server.ts
  </files>
  <action>
**+page.server.ts load function:**
- Query transaction by publicId (params.id)
- Include tag allocations via join or separate query
- Query available tags for edit form
- Return { transaction, tagAllocations, tags }
- If transaction not found or deletedAt is set, throw error(404)

**+page.svelte:**
Create a view/edit page with two modes: view (default) and edit.

View mode:
- Display all transaction fields formatted nicely
- Type badge (Income green / Expense red)
- Amount formatted with formatCurrency
- Date, Payee, Description
- Payment method (and check # if applicable)
- Tags with percentages shown as pills
- Voided banner if voidedAt is set (amber/yellow background)
- "Edit" button (disabled if voided)
- "Void" button (or "Unvoid" if already voided)
- "Delete" button (only visible if voided)
- "View History" link

Edit mode:
- Same form as create, pre-populated with current values
- Uses all input components (CurrencyInput, DateInput, TagSelector, PaymentMethodSelect)
- "Save" and "Cancel" buttons
- Cannot edit voided transactions (redirect or disable)

Use Svelte 5 $state for editMode toggle.
Use form with use:enhance for edit submission.

**+page.server.ts actions:**

**edit action:**
1. Get existing transaction by publicId
2. Return fail(404) if not found
3. Return fail(400) if voided (cannot edit voided transactions)
4. Parse form data same as create
5. Compare old values to new values, build changedFields array
6. If any changes:
   - Insert history record with action='updated', previousState=old transaction, changedFields
   - Update transaction with new values + updatedAt timestamp
7. Return { success: true }

**void action:**
1. Get transaction, fail(404) if not found
2. Return fail(400) if already voided
3. Insert history record with action='voided', previousState
4. Update transaction: set voidedAt to current timestamp
5. Return { success: true, action: 'voided' }

**unvoid action:**
1. Get transaction, fail(400) if not voided
2. Insert history record with action='unvoided', previousState
3. Update transaction: set voidedAt to null
4. Return { success: true, action: 'unvoided' }

**delete action:**
1. Get transaction, fail(404) if not found
2. IMPORTANT: Return fail(400, {error: 'Cannot delete active transaction. Void it first.'}) if NOT voided
3. Insert history record with action='deleted', previousState
4. Update transaction: set deletedAt to current timestamp (soft delete)
5. Redirect to /w/{workspace}/transactions
  </action>
  <verify>
Run `npm run dev`, create a transaction, navigate to its detail page.
Verify view mode displays all fields correctly.
Test edit mode saves changes and records history.
  </verify>
  <done>
Transaction detail page works with view/edit modes, edit tracks history with changed fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement void/delete with history</name>
  <files>src/routes/w/[workspace]/transactions/[id]/+page.svelte</files>
  <action>
Add void/delete UI elements to the transaction detail page:

**Void button:**
- Shown when transaction is NOT voided
- Form action="?/void" with confirmation dialog
- Text: "Void Transaction"
- Style: amber/yellow button

**Unvoid button:**
- Shown when transaction IS voided
- Form action="?/unvoid"
- Text: "Restore Transaction"
- Style: green button

**Delete button:**
- ONLY shown when transaction IS voided
- Form action="?/delete" with strong confirmation dialog
- Text: "Permanently Delete"
- Style: red button
- Show warning: "This action cannot be undone"

**Voided state display:**
- When voidedAt is set, show banner at top: "This transaction is voided"
- Gray out the main content area
- Show voidedAt date in banner
- Disable Edit button when voided

Use form with method="POST" and use:enhance.
Add confirmation via onclick="return confirm('Are you sure?')" or Svelte logic.
  </action>
  <verify>
Test void workflow: void a transaction, verify it shows as voided.
Test delete only works on voided: try to delete active transaction, verify error.
Test unvoid: restore a voided transaction.
  </verify>
  <done>
Void/unvoid/delete actions work correctly, enforce void-first deletion model, record history.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create transaction history view</name>
  <files>
    src/routes/w/[workspace]/transactions/[id]/history/+page.svelte
    src/routes/w/[workspace]/transactions/[id]/history/+page.server.ts
  </files>
  <action>
**+page.server.ts:**
- Get transaction by publicId to get internal id
- Query transactionHistory WHERE transactionId = id ORDER BY timestamp DESC
- Return { transaction: { publicId, payee }, history: [...] }

**+page.svelte:**
Create a history timeline view:

- Heading: "History for {payee}" with back link to transaction
- List of history entries in reverse chronological order
- Each entry shows:
  - Action badge (created=green, updated=blue, voided=amber, unvoided=green, deleted=red)
  - Timestamp formatted as readable date/time
  - For 'updated' actions: list of changed fields
  - Expandable/collapsible previousState JSON (optional, can be simple display)

Timeline styling:
- Vertical line connecting entries
- Circular dots for each entry
- Use Tailwind for timeline CSS (relative positioning, before pseudo-elements via arbitrary variants)

Handle empty history gracefully (shouldn't happen, but show message).
  </action>
  <verify>
Create a transaction, edit it twice, void it, view history.
Verify history shows: created, updated (x2), voided with correct timestamps.
  </verify>
  <done>
Transaction history page shows complete audit trail with action types and timestamps.
  </done>
</task>

</tasks>

<verification>
- [ ] View transaction page shows all fields correctly
- [ ] Edit mode works, saves changes, records history with changedFields
- [ ] Void action sets voidedAt, records history
- [ ] Unvoid action clears voidedAt, records history
- [ ] Delete action ONLY works on voided transactions
- [ ] Delete is soft (sets deletedAt, doesn't remove row)
- [ ] Deleted transactions don't appear in list
- [ ] History page shows all actions in chronological order
</verification>

<success_criteria>
1. Transaction detail page displays all fields including tags with percentages
2. Edit mode uses same components as create, pre-populated
3. Edit saves changes and records exactly which fields changed
4. Voided transactions show visual indicator and disable edit
5. Delete button only appears for voided transactions
6. Attempting to delete non-voided transaction returns clear error
7. History timeline shows complete audit trail
8. All timestamps use consistent ISO format
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-transactions/02-04-SUMMARY.md`
</output>
