---
phase: 06-reports-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/components/charts/NetIncomeChart.svelte
  - src/lib/components/charts/SpendingBreakdown.svelte
  - src/lib/components/charts/IncomeVsExpense.svelte
  - src/routes/w/[workspace]/reports/+page.server.ts
  - src/routes/w/[workspace]/reports/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can see net income trend over time as a line chart"
    - "User can see spending breakdown by tag as a horizontal bar chart"
    - "User can see income vs expense by month as a grouped bar chart"
    - "Clicking a chart element navigates to transactions page with filter applied"
  artifacts:
    - path: "src/lib/components/charts/NetIncomeChart.svelte"
      provides: "Line chart showing net income over time"
      min_lines: 50
    - path: "src/lib/components/charts/SpendingBreakdown.svelte"
      provides: "Horizontal bar chart for spending by tag"
      min_lines: 60
    - path: "src/lib/components/charts/IncomeVsExpense.svelte"
      provides: "Grouped bar chart for income vs expense by month"
      min_lines: 60
  key_links:
    - from: "SpendingBreakdown.svelte"
      to: "/w/[workspace]/transactions"
      via: "goto with tag filter"
      pattern: "goto.*tag="
    - from: "IncomeVsExpense.svelte"
      to: "/w/[workspace]/transactions"
      via: "goto with date filter"
      pattern: "goto.*(from|to)="
---

<objective>
Implement the three interactive charts: net income line chart, spending breakdown horizontal bar, and income vs expense grouped bar with click-to-filter navigation.

Purpose: Provide visual financial insights with interactive drill-down to filtered transaction lists.

Output: Three Chart.js chart components integrated into reports page with click-to-filter functionality.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-reports-dashboard/06-CONTEXT.md
@.planning/phases/06-reports-dashboard/06-RESEARCH.md
@.planning/phases/06-reports-dashboard/06-01-SUMMARY.md

# Existing chart pattern
@src/lib/components/charts/Sparkline.svelte
@src/routes/w/[workspace]/reports/+page.svelte
@src/routes/w/[workspace]/reports/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tag spending data to server load</name>
  <files>src/routes/w/[workspace]/reports/+page.server.ts</files>
  <action>
Update the existing +page.server.ts to add spending breakdown by tag:

1. Add SQL aggregation for expense breakdown by tag:
   ```typescript
   // Join transactions -> transaction_tags -> tags
   // Filter: type='expense', within fiscal year, not voided, not deleted
   // Group by tag, calculate: SUM(amount_cents * percentage / 100)
   // This properly handles split allocations
   ```

2. Query structure (pseudo-SQL):
   ```sql
   SELECT
     tags.id as tagId,
     tags.name as tagName,
     SUM(transactions.amount_cents * transaction_tags.percentage / 100) as totalCents
   FROM transaction_tags
   INNER JOIN transactions ON transaction_tags.transaction_id = transactions.id
   INNER JOIN tags ON transaction_tags.tag_id = tags.id
   WHERE transactions.type = 'expense'
     AND transactions.voided_at IS NULL
     AND transactions.deleted_at IS NULL
     AND transactions.date >= fyStart
     AND transactions.date <= fyEnd
   GROUP BY tags.id
   ORDER BY totalCents DESC
   ```

3. Return as `spendingByTag: { tagId: number, tagName: string, totalCents: number }[]`

4. Limit to top 10 tags for chart readability; group remainder as "Other" if there are more than 10.

Note: Use drizzle-orm sql template and existing patterns from the file.
  </action>
  <verify>
    - Page still loads without error
    - Browser Network tab shows spendingByTag array in response
  </verify>
  <done>Server returns spendingByTag data with tag-allocated expense totals</done>
</task>

<task type="auto">
  <name>Task 2: Create NetIncomeChart and IncomeVsExpense chart components</name>
  <files>src/lib/components/charts/NetIncomeChart.svelte, src/lib/components/charts/IncomeVsExpense.svelte</files>
  <action>
1. Create `src/lib/components/charts/NetIncomeChart.svelte`:
   - Props: `data: { period: string, net: number }[]`, `workspaceId: string`, `fiscalYear: number`
   - Line chart showing net income over time
   - X-axis: period labels (month names)
   - Y-axis: dollar amounts (use formatCurrency in tooltip)
   - Line color: blue (#3b82f6)
   - Fill area under line with low opacity
   - Click handler: navigate to transactions filtered by date range for that month
     ```typescript
     function handleClick(event: ChartEvent, elements: ActiveElement[]) {
       if (elements.length === 0) return;
       const period = data[elements[0].index].period; // e.g., "2026-01"
       const [year, month] = period.split('-');
       const from = `${year}-${month}-01`;
       const to = `${year}-${month}-${getLastDayOfMonth(year, month)}`;
       goto(`/w/${workspaceId}/transactions?fy=${fiscalYear}&from=${from}&to=${to}`);
     }
     ```
   - Register: LineController, LineElement, PointElement, LinearScale, CategoryScale, Tooltip, Legend, Filler
   - Options: responsive: true, maintainAspectRatio: false, onClick: handleClick
   - Container: h-64 (256px)

2. Create `src/lib/components/charts/IncomeVsExpense.svelte`:
   - Props: `data: { period: string, income: number, expense: number }[]`, `workspaceId: string`, `fiscalYear: number`
   - Grouped bar chart with two datasets
   - Dataset 1: Income bars (green #22c55e)
   - Dataset 2: Expense bars (red #ef4444)
   - X-axis: period labels
   - Y-axis: dollar amounts
   - Legend at top showing Income/Expense labels
   - Click handler: same pattern as NetIncomeChart (filter by date range)
   - Register: BarController, BarElement, LinearScale, CategoryScale, Tooltip, Legend
   - Container: h-64

Both components:
- Use $effect() for Chart lifecycle (create, update on data change, destroy on cleanup)
- CRITICAL: Destroy previous chart instance before creating new one
- Format tooltips with formatCurrency
- Handle empty data gracefully (show "No data" message)
  </action>
  <verify>
    - Both component files exist with no TypeScript errors
    - Import components in +page.svelte (temporarily) to verify they compile
  </verify>
  <done>NetIncomeChart (line) and IncomeVsExpense (grouped bar) components created with click-to-filter</done>
</task>

<task type="auto">
  <name>Task 3: Create SpendingBreakdown chart and integrate all charts into reports page</name>
  <files>src/lib/components/charts/SpendingBreakdown.svelte, src/routes/w/[workspace]/reports/+page.svelte</files>
  <action>
1. Create `src/lib/components/charts/SpendingBreakdown.svelte`:
   - Props: `data: { tagId: number, tagName: string, totalCents: number }[]`, `workspaceId: string`, `fiscalYear: number`
   - Horizontal bar chart (indexAxis: 'y')
   - Bars colored with a palette: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16']
   - Y-axis: tag names (sorted by value, highest at top)
   - X-axis: dollar amounts
   - No legend needed (single dataset)
   - Click handler: navigate to transactions filtered by tag
     ```typescript
     function handleClick(event: ChartEvent, elements: ActiveElement[]) {
       if (elements.length === 0) return;
       const tagId = data[elements[0].index].tagId;
       goto(`/w/${workspaceId}/transactions?fy=${fiscalYear}&tag=${tagId}`);
     }
     ```
   - Tooltips: show tag name and formatted amount
   - Container: dynamic height based on number of tags (min h-48, max h-96)
     - Height calculation: Math.min(Math.max(data.length * 32, 192), 384)
   - Register: BarController, BarElement, LinearScale, CategoryScale, Tooltip
   - Handle empty data: "No expense data" message

2. Update `src/routes/w/[workspace]/reports/+page.svelte`:
   - Import all three chart components
   - Add charts section below summary cards
   - Layout:
     ```
     <section class="space-y-6 mt-8">
       <h2 class="text-lg font-semibold text-gray-900">Financial Overview</h2>

       <!-- Net Income Over Time -->
       <div class="rounded-xl border border-gray-200 bg-white p-4">
         <h3 class="text-sm font-medium text-gray-700 mb-4">Net Income Over Time</h3>
         <NetIncomeChart {data.periodData} {workspaceId} {fiscalYear} />
       </div>

       <!-- Income vs Expense by Month -->
       <div class="rounded-xl border border-gray-200 bg-white p-4">
         <h3 class="text-sm font-medium text-gray-700 mb-4">Income vs Expense by Month</h3>
         <IncomeVsExpense {data.periodData} {workspaceId} {fiscalYear} />
       </div>

       <!-- Spending by Category -->
       <div class="rounded-xl border border-gray-200 bg-white p-4">
         <h3 class="text-sm font-medium text-gray-700 mb-4">Spending by Category</h3>
         <SpendingBreakdown {data.spendingByTag} {workspaceId} {fiscalYear} />
       </div>
     </section>
     ```
   - Pass workspaceId from data (already available from layout)
   - Charts stack vertically (full width on all screen sizes per CONTEXT.md)

3. Add workspaceId to page data if not already present:
   - Should be available from `locals.workspaceId` or route params
   - Check existing pattern in +page.server.ts
  </action>
  <verify>
    - Navigate to /w/[workspace]/reports - all three charts render
    - Click on net income chart month - navigates to transactions with date filter
    - Click on spending breakdown bar - navigates to transactions with tag filter
    - Click on income/expense bar - navigates to transactions with date filter
    - No console errors, charts responsive to window resize
  </verify>
  <done>All three charts integrated into reports page with click-to-filter drill-down navigation</done>
</task>

</tasks>

<verification>
1. Three charts visible on reports page: line chart, grouped bar chart, horizontal bar chart
2. Click any chart element - browser navigates to transactions page with appropriate filter
3. Charts handle empty data gracefully (show message, no errors)
4. Charts are responsive (resize browser window)
5. No memory leaks: navigate between pages multiple times, check memory
6. Tooltips display formatted currency values
</verification>

<success_criteria>
- RPTS-02: Line chart shows net income over time
- RPTS-03: Horizontal bar chart shows spending breakdown by tag (top 10 + Other)
- RPTS-04: Grouped bar chart shows income vs expense by month
- All charts are interactive: clicking navigates to filtered transactions
- Click-to-filter works on both desktop and mobile (tap)
- Charts match TinyLedger visual aesthetic (rounded corners, borders, white background)
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-dashboard/06-02-SUMMARY.md`
</output>
