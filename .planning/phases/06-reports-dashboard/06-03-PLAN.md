---
phase: 06-reports-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/lib/components/GranularityToggle.svelte
  - src/routes/w/[workspace]/reports/+page.server.ts
  - src/routes/w/[workspace]/reports/+page.svelte
autonomous: false

must_haves:
  truths:
    - "User can toggle between monthly and quarterly chart granularity"
    - "Partial periods show 'as of today' indicator instead of projections"
    - "Reports page is fully functional on mobile with tap interactions"
  artifacts:
    - path: "src/lib/components/GranularityToggle.svelte"
      provides: "Dropdown toggle for monthly/quarterly"
      min_lines: 20
  key_links:
    - from: "GranularityToggle.svelte"
      to: "URL searchParams"
      via: "goto with granularity param"
      pattern: "goto.*granularity="
---

<objective>
Add time period granularity toggle (monthly/quarterly), partial period indicators, and verify mobile experience.

Purpose: Allow users to view data at different time scales and clearly understand when viewing incomplete periods.

Output: Complete reports dashboard with granularity toggle and mobile-verified interactions.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-reports-dashboard/06-CONTEXT.md
@.planning/phases/06-reports-dashboard/06-02-SUMMARY.md

# Existing patterns
@src/lib/components/FiscalYearPicker.svelte
@src/routes/w/[workspace]/reports/+page.svelte
@src/routes/w/[workspace]/reports/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GranularityToggle and update server data aggregation</name>
  <files>src/lib/components/GranularityToggle.svelte, src/routes/w/[workspace]/reports/+page.server.ts</files>
  <action>
1. Create `src/lib/components/GranularityToggle.svelte`:
   - Props: `granularity: 'monthly' | 'quarterly'`
   - Follow FiscalYearPicker pattern for URL param handling
   - Render as a dropdown/select element:
     ```svelte
     <select
       value={granularity}
       onchange={handleChange}
       class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
     >
       <option value="monthly">Monthly</option>
       <option value="quarterly">Quarterly</option>
     </select>
     ```
   - handleChange function:
     ```typescript
     function handleChange(e: Event) {
       const target = e.target as HTMLSelectElement;
       const url = new URL($page.url);
       url.searchParams.set('granularity', target.value);
       goto(url.toString(), { replaceState: true, noScroll: true });
     }
     ```

2. Update `src/routes/w/[workspace]/reports/+page.server.ts`:
   - Already parses `granularity` param (from Plan 01)
   - Update period aggregation to support quarterly:
     - Monthly: strftime('%Y-%m', date) -> "2026-01", "2026-02"
     - Quarterly: Calculate quarter from month
       ```typescript
       // For quarterly, group by year-quarter
       const quarterExpr = sql`strftime('%Y', ${transactions.date}) || '-Q' || ((CAST(strftime('%m', ${transactions.date}) AS INTEGER) + 2) / 3)`;
       ```
   - Return `granularity` in response for UI state

3. Add `isPartialPeriod` flag to the last period in periodData:
   - Compare last period end date to today
   - If today is within the last period, mark it as partial
   - Return: `currentPeriodPartial: boolean` and `asOfDate: string` (today's date formatted)
  </action>
  <verify>
    - GranularityToggle component renders without errors
    - Changing toggle updates URL with `?granularity=quarterly`
    - Server returns quarterly aggregated data when param is set
    - currentPeriodPartial flag is true when viewing current month/quarter
  </verify>
  <done>Granularity toggle created and server supports both monthly and quarterly aggregation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate granularity toggle and partial period indicator into reports page</name>
  <files>src/routes/w/[workspace]/reports/+page.svelte</files>
  <action>
1. Import GranularityToggle component

2. Add controls row below FiscalYearPicker:
   ```svelte
   <div class="flex flex-wrap items-center justify-between gap-4">
     <FiscalYearPicker
       fiscalYear={data.fiscalYear}
       availableYears={data.availableFiscalYears}
       startMonth={data.fiscalYearStartMonth}
     />
     <GranularityToggle granularity={data.granularity} />
   </div>
   ```

3. Add partial period indicator near charts:
   - If `data.currentPeriodPartial` is true, show indicator
   - Position: small text below charts section header
   ```svelte
   {#if data.currentPeriodPartial}
     <p class="text-sm text-gray-500 italic">
       Current {data.granularity === 'monthly' ? 'month' : 'quarter'} shows data as of {formatDate(data.asOfDate)}
     </p>
   {/if}
   ```
   - formatDate helper: use Intl.DateTimeFormat for "Feb 1, 2026" format

4. Update chart period labels:
   - Monthly: "Jan", "Feb", "Mar"...
   - Quarterly: "Q1", "Q2", "Q3", "Q4"
   - Pass granularity to chart components if needed for label formatting
   - Or: format labels in +page.server.ts before returning

5. Ensure charts update reactively when granularity changes:
   - Data flows from server on URL change
   - Charts should re-render automatically via $effect watching props

6. Per CONTEXT.md: time controls scroll away (not sticky) on mobile
   - Current layout already does this (controls are not position: sticky)
   - Verify by testing
  </action>
  <verify>
    - Toggle appears next to FiscalYearPicker
    - Selecting "Quarterly" updates charts to show 4 bars instead of 12
    - Partial period message appears when viewing current month/quarter
    - Charts animate smoothly when granularity changes
  </verify>
  <done>Reports page shows granularity toggle and partial period indicator, charts update accordingly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete reports dashboard with summary cards, three interactive charts, granularity toggle, and mobile layout</what-built>
  <how-to-verify>
1. **Desktop verification:**
   - Open http://localhost:5173/w/[your-workspace]/reports
   - Verify four summary cards display (net income hero at top with sparkline, three below)
   - Verify three charts render (line, grouped bar, horizontal bar)
   - Click on a bar in "Spending by Category" - should navigate to transactions filtered by that tag
   - Click on a month bar in "Income vs Expense" - should navigate to transactions filtered by that date range
   - Toggle granularity between Monthly and Quarterly - charts should update
   - If current period is partial, verify "as of [date]" indicator appears

2. **Mobile verification (Chrome DevTools or real device):**
   - Open DevTools, toggle device toolbar (Ctrl+Shift+M)
   - Select iPhone 12/13 or similar
   - Verify summary cards stack vertically
   - Verify charts are full-width and scrollable
   - Tap on chart elements - verify tap-to-filter navigation works
   - Scroll down - verify time controls scroll away (not sticky)

3. **Edge cases:**
   - Switch to a fiscal year with no transactions - verify empty states show gracefully
   - If you have many tags, verify spending breakdown shows top 10 + "Other"
  </how-to-verify>
  <resume-signal>Type "approved" to complete the phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Granularity toggle updates charts without page reload
2. Quarterly view shows 4 periods, monthly shows up to 12
3. Partial period indicator shows when viewing current period
4. All click-to-filter interactions work on mobile (tap)
5. Charts handle both granularities without visual issues
6. Page is fully responsive at all breakpoints
</verification>

<success_criteria>
- Granularity toggle (Monthly/Quarterly) is functional
- Partial periods clearly indicated with "as of today" message
- All Phase 6 requirements met:
  - RPTS-01: Summary cards with YTD income, expenses, net income, tax set-aside
  - RPTS-02: Net income line chart
  - RPTS-03: Spending by tag horizontal bar chart
  - RPTS-04: Income vs expense grouped bar chart
- Mobile experience is smooth with tap interactions
- Human verification confirms visual/functional quality
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-dashboard/06-03-SUMMARY.md`
</output>
