---
phase: 06-reports-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/w/[workspace]/reports/+page.server.ts
  - src/routes/w/[workspace]/reports/+page.svelte
  - src/lib/components/SummaryCard.svelte
  - src/lib/components/charts/Sparkline.svelte
  - src/lib/utils/reports.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can view YTD income, YTD expenses, net income, and tax set-aside on reports page"
    - "Net income hero card displays prominently at top with sparkline trend"
    - "Summary cards show % change vs previous period"
    - "Reports page loads with current fiscal year data by default"
  artifacts:
    - path: "src/routes/w/[workspace]/reports/+page.server.ts"
      provides: "Server-side data aggregation for reports"
      exports: ["load"]
    - path: "src/routes/w/[workspace]/reports/+page.svelte"
      provides: "Reports dashboard page"
      min_lines: 50
    - path: "src/lib/components/SummaryCard.svelte"
      provides: "Reusable summary card with sparkline slot"
      min_lines: 20
    - path: "src/lib/components/charts/Sparkline.svelte"
      provides: "Minimal Chart.js sparkline"
      min_lines: 30
  key_links:
    - from: "src/routes/w/[workspace]/reports/+page.svelte"
      to: "+page.server.ts"
      via: "SvelteKit data loading"
      pattern: "let \\{ data \\}"
    - from: "src/lib/components/charts/Sparkline.svelte"
      to: "chart.js"
      via: "Chart constructor in $effect"
      pattern: "new Chart"
---

<objective>
Create reports dashboard with server-side data aggregation and summary cards displaying YTD metrics with sparkline trends.

Purpose: Establish the reports page foundation with summary cards showing income, expenses, net income, and tax set-aside. The hero card (net income) includes an inline sparkline.

Output: Working reports page at /w/[workspace]/reports with four summary cards and Chart.js installed.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reports-dashboard/06-CONTEXT.md
@.planning/phases/06-reports-dashboard/06-RESEARCH.md

# Patterns to follow
@src/routes/w/[workspace]/transactions/+page.server.ts
@src/lib/components/FiscalYearPicker.svelte
@src/lib/utils/fiscal-year.ts
@src/lib/utils/currency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Chart.js and create reports data utilities</name>
  <files>package.json, src/lib/utils/reports.ts</files>
  <action>
1. Install Chart.js:
   ```bash
   npm install chart.js
   ```

2. Create `src/lib/utils/reports.ts` with helper functions:
   - `getMonthLabel(date: string): string` - Extract month label from YYYY-MM-DD (e.g., "Jan", "Feb")
   - `getQuarterLabel(date: string): string` - Get quarter label (e.g., "Q1", "Q2")
   - `calculatePercentChange(current: number, previous: number): number | null` - Returns percent change, null if previous is 0
   - `getMonthsInFiscalYear(fiscalYear: number, startMonth: number): string[]` - Returns array of YYYY-MM strings for each month in FY
   - `TAX_SET_ASIDE_RATE = 0.25` - Default 25% tax set-aside (can be made configurable in Phase 7)

Use existing fiscal-year.ts patterns. Month labels should use Intl.DateTimeFormat for proper formatting.
  </action>
  <verify>
    - `npm ls chart.js` shows chart.js installed
    - File `src/lib/utils/reports.ts` exists with exported functions
  </verify>
  <done>Chart.js installed and reports utilities created with month/quarter helpers and percent change calculation</done>
</task>

<task type="auto">
  <name>Task 2: Create server-side data aggregation for reports</name>
  <files>src/routes/w/[workspace]/reports/+page.server.ts</files>
  <action>
Create `src/routes/w/[workspace]/reports/+page.server.ts` following the transactions +page.server.ts pattern:

1. Parse URL params:
   - `fy` - fiscal year (default to current)
   - `granularity` - 'monthly' | 'quarterly' (default 'monthly')

2. Get workspace settings for fiscal year config (same pattern as transactions)

3. Calculate YTD totals (within fiscal year, excluding voided):
   - `totalIncome` - sum of income transactions
   - `totalExpenses` - sum of expense transactions
   - `netIncome` - totalIncome - totalExpenses
   - `taxSetAside` - netIncome * TAX_SET_ASIDE_RATE (only if net positive)

4. Calculate previous period comparison:
   - If current month is partial, compare to same day count in previous month
   - For simplicity in v1: compare current period totals to previous period totals
   - Return `previousPeriod: { income, expense, net }` for % change calculation

5. Aggregate data by period (monthly or quarterly):
   - Group by strftime('%Y-%m', date) for monthly
   - Group by strftime('%Y', date) || '-Q' || ((CAST(strftime('%m', date) AS INTEGER) - 1) / 3 + 1) for quarterly
   - Return array: `{ period: string, income: number, expense: number, net: number }[]`

6. Get net income trend for sparkline:
   - Array of monthly net income values for the fiscal year
   - `netIncomeTrend: number[]` (one value per month, in chronological order)

7. Return all data including availableFiscalYears and fiscalYearStartMonth for FY picker reuse.

Use SQL aggregation (not client-side) - follow existing patterns with `sql` template literal from drizzle-orm.
  </action>
  <verify>
    - Navigate to `/w/[workspace]/reports` in browser - should load without 500 error
    - Check browser Network tab - server returns JSON with totals and periodData
  </verify>
  <done>Reports page server load returns YTD totals, previous period comparison, period aggregates, and sparkline data</done>
</task>

<task type="auto">
  <name>Task 3: Create SummaryCard and Sparkline components with reports page</name>
  <files>src/lib/components/SummaryCard.svelte, src/lib/components/charts/Sparkline.svelte, src/routes/w/[workspace]/reports/+page.svelte</files>
  <action>
1. Create `src/lib/components/charts/` directory (mkdir -p)

2. Create `src/lib/components/charts/Sparkline.svelte`:
   - Props: `data: number[]`, `class?: string`
   - Use Chart.js with $effect() for lifecycle (see RESEARCH.md Pattern 3)
   - Minimal config: no axes, no gridlines, no points, no legend, no tooltips
   - Color: green (#22c55e) if trend up (last > first), red (#ef4444) if down
   - Default dimensions via container (h-8 w-24)
   - Register only: LineController, LineElement, PointElement, LinearScale, CategoryScale
   - IMPORTANT: Always destroy chart in $effect cleanup to prevent memory leaks

3. Create `src/lib/components/SummaryCard.svelte`:
   - Props: `label: string`, `value: number`, `percentChange: number | null`, `variant: 'hero' | 'default'`, `valuePrefix?: string`
   - Use formatCurrency from $lib/utils/currency
   - Hero variant: larger text, more prominent styling
   - Show % change badge: green with + prefix if positive, red if negative, gray if null
   - Include `{@render children?.()}` slot for sparkline in hero card
   - Styling: rounded-xl border, subtle background, colored accent (matches CONTEXT.md)

4. Create `src/routes/w/[workspace]/reports/+page.svelte`:
   - Import SummaryCard, Sparkline, FiscalYearPicker, formatCurrency
   - Header section with FiscalYearPicker (reuse existing component)
   - Summary cards grid:
     - Hero card (net income) at top spanning full width with Sparkline
     - Three supporting cards below in a row (income, expenses, tax set-aside)
     - On mobile (sm breakpoint): all cards stack vertically
   - Use Tailwind grid: `grid-cols-1 sm:grid-cols-3` for supporting cards
   - Calculate percent changes using calculatePercentChange utility
   - Add placeholder sections for charts (will be implemented in Plan 02)

Styling should match existing TinyLedger aesthetic (see transactions page).
  </action>
  <verify>
    - Navigate to `/w/[workspace]/reports` - see four summary cards with data
    - Hero card shows net income with sparkline trend visualization
    - Cards show % change vs previous period (or no badge if N/A)
    - Mobile view (responsive): cards stack vertically
  </verify>
  <done>Reports page displays summary cards with YTD income, expenses, net income (with sparkline), and tax set-aside</done>
</task>

</tasks>

<verification>
1. Chart.js in dependencies: `npm ls chart.js`
2. Reports page loads: `curl -s http://localhost:5173/w/test/reports | grep -q "reports"` (or visit in browser)
3. Summary cards render with real data from database
4. Sparkline animates/renders without console errors
5. No memory leaks: navigate away and back, check browser memory
</verification>

<success_criteria>
- Reports page accessible at /w/[workspace]/reports
- Four summary cards display: YTD income, YTD expenses, net income (hero), tax set-aside
- Hero card includes inline sparkline showing net income trend
- Cards show % change vs previous period where applicable
- Mobile responsive layout (cards stack on small screens)
- No TypeScript errors, no console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-dashboard/06-01-SUMMARY.md`
</output>
